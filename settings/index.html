<!doctype html>
<html>

<head>
    <!-- The '/homey.js' script must be included in your settings view to work -->
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
    <link rel="stylesheet" type="text/css" href="extraStyles.css">
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css'>
</head>

<body>
    <fieldset class="homey-form-fieldset">
        <legend class="homey-form-legend"><span data-i18n="settings.Settings"></span></legend>
        <label class="homey-form-checkbox">
            <input class="homey-form-checkbox-input" id="autoConfig" type="checkbox" value="auto" />
            <span class="homey-form-checkbox-checkmark"></span>
            <span class="homey-form-checkbox-text"><span data-i18n="settings.autoConfig"></span></span>
        </label>
        <div id="AutoConfigWarnOff"><span data-i18n="settings.autoConfigWarning1"></span></div>
        <div id="AutoConfigWarnOn"><span data-i18n="settings.autoConfigWarning2"></span></div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
        <select class="homey-form-select" id="configType">
            <option value="panelConfig">Button Configurations</option>
            <option value="displayConfig">Display Configurations</option>
        </select>

        <!-- Button Bar Configuration -->

        <div id="panelConfig" class="tabcontent">
            <div class="homey-form-group">
                <div style="padding: 10px 10px 10px 10px; border: 1px solid lightblue; border-radius: 10px">
                    <select class="homey-form-select" id="ButtonPanelConfigurationNo">
                        <option value=0>Button Configuration 1</option>
                        <option value=1>Button Configuration 2</option>
                        <option value=2>Button Configuration 3</option>
                        <option value=3>Button Configuration 4</option>
                        <option value=4>Button Configuration 5</option>
                        <option value=5>Button Configuration 6</option>
                        <option value=6>Button Configuration 7</option>
                        <option value=7>Button Configuration 8</option>
                        <option value=8>Button Configuration 9</option>
                        <option value=9>Button Configuration 10</option>
                        <option value=10>Button Configuration 11</option>
                        <option value=11>Button Configuration 12</option>
                        <option value=12>Button Configuration 13</option>
                        <option value=13>Button Configuration 14</option>
                        <option value=14>Button Configuration 15</option>
                        <option value=15>Button Configuration 16</option>
                        <option value=16>Button Configuration 17</option>
                        <option value=17>Button Configuration 18</option>
                        <option value=18>Button Configuration 19</option>
                        <option value=19>Button Configuration 20</option>
                    </select>
                    <div class="horizontalcontainer">
                        <div class="horizontalgroup">
                            <legend class="homey-subtitle"><span data-i18n="settings.leftPanel"></span></legend>

                            <label class="homey-form-label" for="leftDevice"><span data-i18n="settings.device"></span></label>
                            <select class="homey-form-select" id="leftDevice">
                            </select>

                            <label class="homey-form-label" id="leftCapabilityLabel" for="leftCapability"><span data-i18n="settings.capability"></span></label>
                            <select class="homey-form-select" id="leftCapability">
                            </select>

                            <label class="homey-form-label" for="leftTopText"><span data-i18n="settings.topLabel"></span></label>
                            <input class="homey-form-input" id="leftTopText" type="text" maxlength="20" value="" />
                            
                            <label class="homey-form-label" id="leftOnTextLabel" for="leftOnText"><span data-i18n="settings.labelOn"></span></label>
                            <input class="homey-form-input" id="leftOnText" type="text" maxlength="20" value="" />

                            <label class="homey-form-label" id="leftOffTextLabel" for="leftOffText"><span data-i18n="settings.labelOff"></span></label>
                            <input class="homey-form-input" id="leftOffText" type="text" maxlength="20" value="" />
                        </div>
                        <div class="horizontalgroup">
                            <legend class="homey-subtitle"><span data-i18n="settings.rightPanel"></span></legend>

                            <label class="homey-form-label" for="rightDevice"><span data-i18n="settings.device"></span></label>
                            <select class="homey-form-select" id="rightDevice">
                            </select>

                            <label class="homey-form-label" id="rightCapabilityLabel" for="rightCapability"><span data-i18n="settings.capability"></span></label>
                            <select class="homey-form-select" id="rightCapability">
                            </select>

                            <label class="homey-form-label" for="rightTopText"><span data-i18n="settings.topLabel"></span></label>
                            <input class="homey-form-input" id="rightTopText" type="text" maxlength="20" value="" />

                            <label class="homey-form-label" id="rightOnTextLabel" for="rightOnText"><span data-i18n="settings.labelOn"></span></label>
                            <input class="homey-form-input" id="rightOnText" type="text" maxlength="20" value="" />

                            <label class="homey-form-label" id="rightOffTextLabel" for="rightOffText"><span data-i18n="settings.labelOff"></span></label>
                            <input class="homey-form-input" id="rightOffText" type="text" maxlength="20" value="" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Display Configuration -->

        <div id="displayConfig" class="tabcontent">
            <div class="homey-form-group">
                <div style="padding: 10px 10px 10px 10px; border: 1px solid lightblue; border-radius: 10px">
                    <select class="homey-form-select" id="displayConfigurationNo">
                        <option value=0>Display Configuration 1</option>
                        <option value=1>Display Configuration 2</option>
                        <option value=2>Display Configuration 3</option>
                        <option value=3>Display Configuration 4</option>
                        <option value=4>Display Configuration 5</option>
                        <option value=5>Display Configuration 6</option>
                        <option value=6>Display Configuration 7</option>
                        <option value=7>Display Configuration 8</option>
                        <option value=8>Display Configuration 9</option>
                        <option value=9>Display Configuration 10</option>
                        <option value=10>Display Configuration 11</option>
                        <option value=11>Display Configuration 12</option>
                        <option value=12>Display Configuration 13</option>
                        <option value=13>Display Configuration 14</option>
                        <option value=14>Display Configuration 15</option>
                        <option value=15>Display Configuration 16</option>
                        <option value=16>Display Configuration 17</option>
                        <option value=17>Display Configuration 18</option>
                        <option value=18>Display Configuration 19</option>
                        <option value=19>Display Configuration 20</option>
                    </select>
                </div>
                <div id="displayItemsSection"></div>
            </div>
            <p><button class="homey-button-secondary-shadow" id="newDisplayItem"><span data-i18n="settings.newDisplayItem"></span></button></p>
        </div>

    </fieldset>

    <!-- Save Configuration button -->

    <p><button class="homey-button-primary-full" id="save"><span data-i18n="settings.save"></span></button></p>

    <!-- Code to handle page life -->

    <script type="text/javascript">

        // General declarations
        var devicesArray = [];
        var devicesFetched = false;
        var autoConfigElement = document.getElementById('autoConfig');
        var ConfigTypeElement = document.getElementById('configType');
        var saveButton = document.getElementById('save');

        // Declarations for the Button Bar Config page

        var ButtonConfigurationNoElement = document.getElementById('ButtonPanelConfigurationNo');

        var leftTopTextElement = document.getElementById('leftTopText');
        var leftOnTextElement = document.getElementById('leftOnText');
        var leftOffTextElement = document.getElementById('leftOffText');
        var leftDeviceElement = document.getElementById('leftDevice');
        var leftCapabilityElement = document.getElementById('leftCapability');

        var rightTopTextElement = document.getElementById('rightTopText');
        var rightOnTextElement = document.getElementById('rightOnText');
        var rightOffTextElement = document.getElementById('rightOffText');
        var rightDeviceElement = document.getElementById('rightDevice');
        var rightCapabilityElement = document.getElementById('rightCapability');

        var buttonConfigurationsFetched = false;
        var localbuttonConfigurations = [];
        var currentButtonConfigurationNo = 0;

        // Declarations for the Display Config page

        var displayConfigurationNoElement = document.getElementById('displayConfigurationNo');
        var newDisplayItemButton = document.getElementById('newDisplayItem');

        var displayConfigurationsFetched = false;
        var localDisplayConfigurations = [];
        var currentDisplayConfigurationNo = 0;
        var displayCapabilityItems = [];

        // a method named 'onHomeyReady' must be present in your code
        function onHomeyReady(Homey)
        {
            // General code

            getDeivices();
            configTypeChanged('panelConfig');

            Homey.get('autoConfig', function(err, autoConfig)
            {
                if (err) return Homey.alert(err);
                autoConfigElement.checked = autoConfig;
                autoConfigChanged();
            });

            autoConfigElement.addEventListener('click', function(e)
            {
                Homey.set('autoConfig', autoConfigElement.checked);
                autoConfigChanged();
            });

            ConfigTypeElement.addEventListener('change', function(e)
            {
                configTypeChanged( ConfigTypeElement.value);
            });

            saveButton.addEventListener('click', function(e)
            {
                if (autoConfigElement.checked)
                {
                    if (leftCapabilityElement.value === 'dim')
                    {
                        const dimVal = parseInt(leftOnTextElement.value, 10);
                        if (dimVal < -100 || dimVal > 100 || dimVal === 0)
                        {
                            Homey.alert(Homey.__("settings.dimError", {leftRight: 'Left'}));
                            return;
                        }
                    }

                    if (rightCapabilityElement.value === 'dim')
                    {
                        const dimVal = parseInt(rightOnTextElement.value, 10);
                        if (dimVal < -100 || dimVal > 100 || dimVal === 0)
                        {
                            Homey.alert(Homey.__("settings.dimError", {leftRight: 'Right'}));
                            return;
                        }
                    }

                    var ButtonPanelConfigurationNo = ButtonConfigurationNoElement.value;

                    var ButtonPanelConfiguration = {
                        leftTopText: leftTopTextElement.value,
                        leftOnText: leftOnTextElement.value,
                        leftOffText: leftOffTextElement.value,
                        leftDevice: leftDeviceElement.value,
                        leftCapability: leftCapabilityElement.value,
                        rightTopText: rightTopTextElement.value,
                        rightOnText: rightOnTextElement.value,
                        rightOffText: rightOffTextElement.value,
                        rightDevice: rightDeviceElement.value,
                        rightCapability: rightCapabilityElement.value
                    };

                    localbuttonConfigurations[ButtonPanelConfigurationNo] = ButtonPanelConfiguration;
                    Homey.set('buttonConfigurations', localbuttonConfigurations);

                    storeDevicesSettings();
                    Homey.set('displayConfigurations', localDisplayConfigurations);
                    Homey.alert(Homey.__("settings.saved"));
                }
                else
                {
                    Homey.alert(Homey.__("settings.saveError1"));
                }
            });

            // Button Bar Config code

            Homey.get('buttonConfigurations', function(err, buttonConfigurations)
            {
                if (err) return Homey.alert(err);
                localbuttonConfigurations = buttonConfigurations;
                buttonConfigurationsFetched = true;
                console.log('buttonConfigurations: ' + JSON.stringify(buttonConfigurations));
                updateButtonPanelConfiguration();
            });

            ButtonPanelConfigurationNo.addEventListener('change', function(e)
            {
                // Store the current configuration
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];

                ButtonPanelConfiguration.leftTopText = leftTopTextElement.value;
                ButtonPanelConfiguration.leftOnText = leftOnTextElement.value;
                ButtonPanelConfiguration.leftOffText = leftOffTextElement.value;
                ButtonPanelConfiguration.leftDevice = leftDeviceElement.value;
                ButtonPanelConfiguration.leftCapability = leftCapabilityElement.value;
                ButtonPanelConfiguration.rightTopText = rightTopTextElement.value;
                ButtonPanelConfiguration.rightOnText = rightOnTextElement.value;
                ButtonPanelConfiguration.rightOffText = rightOffTextElement.value;
                ButtonPanelConfiguration.rightDevice = rightDeviceElement.value;
                ButtonPanelConfiguration.rightCapability = rightCapabilityElement.value;

                // Fetch the new configuration
                updateButtonPanelConfiguration();
            });

            leftTopTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftTopText = leftTextTopElement.value;
            });

            leftOnTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftOnText = leftOnTextElement.value;
            });

            leftOffTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftOffText = leftOffTextElement.value;
            });

            rightTopTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightTopText = rightTopTextElement.value;
            });

            rightOnTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightOnText = rightOnTextElement.value;
            });

            rightOffTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightOffText = rightOffTextElement.value;
            });

            leftDeviceElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftDevice = leftDeviceElement.value;
                getCapabilities(leftDeviceElement.value, leftCapabilityElement, ButtonPanelConfiguration.leftDevice, leftOnTextElement, leftOffTextElement);
            });

            rightDeviceElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightDevice = rightDeviceElement.value;
                getCapabilities(rightDeviceElement.value, rightCapabilityElement, ButtonPanelConfiguration.rightDevice, rightOnTextElement, rightOffTextElement);
            });

            leftCapabilityElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftCapability = leftCapabilityElement.value;
                if (leftCapabilityElement.value === "dim")
                {
                    document.getElementById('leftOnTextLabel').innerHTML = Homey.__("settings.dimValue");
                    document.getElementById('leftOffText').style.visibility = "hidden";
                    document.getElementById('leftOffTextLabel').style.visibility = "hidden";
                }
                else
                {
                    document.getElementById('leftOnTextLabel').innerHTML = Homey.__("settings.labelOn");
                    document.getElementById('leftOffText').style.visibility = "visible";
                    document.getElementById('leftOffTextLabel').style.visibility = "visible";
                }

            });

            rightCapabilityElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightCapability = rightCapabilityElement.value;
                if (leftCapabilityElement.value === "dim")
                {
                    document.getElementById('rightOnTextLabel').innerHTML = Homey.__("settings.dimValue");
                    document.getElementById('rightOffText').style.visibility = "hidden";
                    document.getElementById('rightOffTextLabel').style.visibility = "hidden";
                }
                else
                {
                    document.getElementById('rightOnTextLabel').innerHTML = Homey.__("settings.labelOn");
                    document.getElementById('rightOffText').style.visibility = "visible";
                    document.getElementById('rightOffTextLabel').style.visibility = "visible";
                }
            });

            // Display Config code

            displayConfigurationNoElement.addEventListener('change', function(e)
            {
                // Store the current configuration
                storeDevicesSettings();

                // Fetch the new configuration
                updateDisplayConfiguration();
            });

            newDisplayItemButton.addEventListener('click', function(e)
            {
                if (displayConfigurationsFetched)
                {
                    displayConfigurationNo = displayConfigurationNoElement.value;
                    var displayConfiguration = localDisplayConfigurations[displayConfigurationNo];
                    if (displayConfiguration)
                    {
                        var displayItem = {
                            device: "none",
                            capability: "",
                            label: "",
                            units: "",
                            numberRounding: 0,
                            xPos: 0,
                            yPos: 0,
                            width: 100,
                            fontSize: 1,
                            alignment: 0,
                        };

                        displayConfiguration.items.push(displayItem);

                        localDisplayConfigurations[displayConfigurationNo] = displayConfiguration;
                        Homey.set('displayConfigurations', localDisplayConfigurations);
                        drawDisplayConfiguration(displayConfiguration);
                    }
                }
            });

            Homey.get('displayConfigurations', function(err, displayConfigurations)
            {
                if (err) return Homey.alert(err);
                localDisplayConfigurations = displayConfigurations;
                displayConfigurationsFetched = (localDisplayConfigurations.length > 0);
                updateDisplayConfiguration();
            });

            // Tell Homey we're ready to be displayed
            Homey.ready();
        }

        function getDeivices()
        {
            Homey.api('POST', '/Devices/', {type: 'boolean', id: 'dim'}, function(err, devices)
            {
                if (err) return Homey.alert(err);

                devicesArray = Object.values(devices);
                devicesFetched = true;
                fillPanelDevices();
                fillDisplayDevices();
            });
        } 

        function fillPanelDevices()
        {
            //fill the device lists with devices
            if (devicesFetched)
            {
                fillDevicesElement(leftDeviceElement);
                fillDevicesElement(rightDeviceElement);
                updateButtonPanelConfiguration();
            };
        }

        function fillDevicesElement( element )
        {
            if (devicesFetched && element)
            {
                //fill the device lists with devices
                element.innerHTML = "";

                var option = document.createElement("option");
                option.text = "none";
                option.value = "none";
                element.add(option);

                for (const device of devicesArray)
                {
                    var option = document.createElement("option");
                    option.text = device.name;
                    option.value = device.id;
                    element.add(option);
                }
            }
        }

        function getCapabilities(deviceId, element, selectedCapability, onTextElement, offTextElement)
        {
            if (deviceId === "none")
            {
                element.innerHTML = "";
                element.style.visibility = "hidden";
                document.getElementById(`${element.id}Label`).style.visibility = "hidden";
                return;
            }
            Homey.api('POST', '/device_capabilities/', { deviceId }, function(err, capabilities)
            {
                if (err) return Homey.alert(err);
                element.innerHTML = "";
                if (capabilities)
                {
                    const capabilitiesArray = Object.values(capabilities);
                    for (const capability of capabilitiesArray)
                    {
                        if (capability.type === "boolean" || capability.id === "dim")
                        {
                            var option = document.createElement("option");
                            option.text = capability.title;
                            option.value = capability.id;
                            element.add(option);
                        }
                    }
                    element.style.visibility = "visible";
                    document.getElementById(`${element.id}Label`).style.visibility = "visible";
                    element.value = selectedCapability;
                    if (selectedCapability === "dim")
                    {
                        document.getElementById(`${onTextElement.id}Label`).innerHTML = Homey.__("settings.dimValue");
                        document.getElementById(`${offTextElement.id}`).style.visibility = "hidden";
                        document.getElementById(`${offTextElement.id}Label`).style.visibility = "hidden";
                    }
                    else
                    {
                        document.getElementById(`${onTextElement.id}Label`).innerHTML = Homey.__("settings.labelOn");
                        document.getElementById(`${offTextElement.id}`).style.visibility = "visible";
                        document.getElementById(`${offTextElement.id}Label`).style.visibility = "visible";
                    }
                }
            });
        }

        function updateButtonPanelConfiguration()
        {
            if ((buttonConfigurationsFetched == false) || (devicesFetched == false)) return;

            if (currentButtonConfigurationNo < 0 || currentButtonConfigurationNo >= localbuttonConfigurations.length)
            {
                currentButtonConfigurationNo = 0;
                ButtonConfigurationNoElement.value = currentButtonConfigurationNo;
            }

            if (ButtonConfigurationNoElement.value == "")
            {
                leftTopTextElement.value = "";
                leftOnTextElement.value = "";
                leftOffTextElement.value = "";
                leftDeviceElement.value = "";
                leftCapabilityElement.value = "";

                rightTopTextElement.value = "";
                rightOnTextElement.value = "";
                rightOffTextElement.value = "";
                rightDeviceElement.value = "";
                rightCapabilityElement.value = "";
            }
            else
            {
                currentButtonConfigurationNo = ButtonConfigurationNoElement.value;
                let ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];

                leftTopTextElement.value = ButtonPanelConfiguration.leftTopText;
                leftOnTextElement.value = ButtonPanelConfiguration.leftOnText;
                leftOffTextElement.value = ButtonPanelConfiguration.leftOffText;
                leftDeviceElement.value = ButtonPanelConfiguration.leftDevice;
                getCapabilities(leftDeviceElement.value, leftCapabilityElement, ButtonPanelConfiguration.leftCapability, leftOnTextElement, leftOffTextElement);

                rightTopTextElement.value = ButtonPanelConfiguration.rightTopText;
                rightOnTextElement.value = ButtonPanelConfiguration.rightOnText;
                rightOffTextElement.value = ButtonPanelConfiguration.rightOffText;
                rightDeviceElement.value = ButtonPanelConfiguration.rightDevice;
                rightCapabilityElement.value = ButtonPanelConfiguration.rightCapability;
                getCapabilities(rightDeviceElement.value, rightCapabilityElement, ButtonPanelConfiguration.rightCapability, rightOnTextElement, rightOffTextElement);
            }
        }

        function autoConfigChanged()
        {
            if (!autoConfigElement.checked)
            {
                configTypeChanged("");
                document.getElementById('AutoConfigWarnOff').style.display = "block";
                document.getElementById('AutoConfigWarnOn').style.display = "none";
                saveButton.style.display = "none";
                ConfigTypeElement.style.display = "none";
            }
            else
            {
                configTypeChanged( ConfigTypeElement.value);
                document.getElementById('AutoConfigWarnOff').style.display = "none";
                document.getElementById('AutoConfigWarnOn').style.display = "block";
                saveButton.style.display = "block";
                ConfigTypeElement.style.display = "block";
            }
        }

        function configTypeChanged(configSelected)
        {
            var i, tabcontent, tablinks;

            // Get all elements with class="tabcontent" and hide them
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++)
            {
                tabcontent[i].style.display = "none";
            }
            if (configSelected !== "")
            {
                document.getElementById(configSelected).style.display = "block";
            }
        }

        // Code for Displaypanel configuration

        function updateDisplayConfiguration()
        {
            if (displayConfigurationsFetched)
            {
                currentDisplayConfigurationNo = displayConfigurationNoElement.value;

                var displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];

                if (displayConfiguration == null)
                {
                    displayConfiguration = {};
                    displayConfiguration.items = [];
                }

                displayCapabilityItems = [];

                drawDisplayConfiguration(displayConfiguration);
            }
        }

        function drawDisplayConfiguration(displayConfiguration)
        {
            document.getElementById('displayItemsSection').innerHTML = "";
            for (var itemNo = 0; itemNo < displayConfiguration.items.length; itemNo++)
            {
                const item = displayConfiguration.items[itemNo];
                const capabilities = {}
                displayCapabilityItems.push(capabilities);
                insertDisplayItemSection(item, itemNo);
            }

            fillDisplayDevices();
        }

        function insertDisplayItemSection(item, itemNo)
        {
            var section = document.getElementById('displayItemsSection').innerHTML;
            const ctrlLabels = {
                device: Homey.__("settings.device"),
                capability: Homey.__("settings.capability"),
                label: Homey.__("settings.label"),
                units: Homey.__("settings.units"),
                xPos: Homey.__("settings.xPos"),
                yPos: Homey.__("settings.yPos"),
                width: Homey.__("settings.width"),
                rounding: Homey.__("settings.rounding"),
                fontSize: Homey.__("settings.fontSize"),
                topLeft: Homey.__("settings.topLeft"),
                topCenter: Homey.__("settings.topCenter"),
                topRight: Homey.__("settings.topRight"),
                centerLeft: Homey.__("settings.centerLeft"),
                centerCenter: Homey.__("settings.centerCenter"),
                centerRight: Homey.__("settings.centerRight"),
                bottomLeft: Homey.__("settings.bottomLeft"),
                bottomCenter: Homey.__("settings.bottomCenter"),
                bottomRight: Homey.__("settings.bottomRight"),
                deleteDisplayItem: Homey.__("settings.deleteDisplayItem"),
            }
            const itemLegend =  Homey.__("settings.displayItemlegend", {itemNo: itemNo + 1});

            section = section +
                `<div class="horizontalcontainer">
                    <div class="horizontalgroup">
                        <legend class="homey-subtitle">${itemLegend}</legend>

                        <label class="homey-form-label" for="display${itemNo}Device">${ctrlLabels.device}</label>
                        <select class="homey-form-select" id="display${itemNo}Device" onChange="getDisplayCapabilities(${itemNo})">
                        </select>

                        <label class="homey-form-label" for="display${itemNo}Capability">${ctrlLabels.capability}</label>
                        <select class="homey-form-select" id="display${itemNo}Capability" onChange="selectDisplayCapabilities(${itemNo})">
                        </select>

                        <label class="homey-form-label" for="display${itemNo}Label">${ctrlLabels.label}</label>
                        <input class="homey-form-input" id="display${itemNo}Label" type="text" value="${item.label}" />

                        <label class="homey-form-label" for="display${itemNo}Units">${ctrlLabels.units}</label>
                        <input class="homey-form-input" id="display${itemNo}Units" type="text" value="${item.units}" />

                        <label class="homey-form-label" for="display${itemNo}X">${ctrlLabels.xPos}</label>
                        <input class="homey-form-input" id="display${itemNo}X" type="number" value="${item.xPos}" />

                        <label class="homey-form-label" for="display${itemNo}Y">${ctrlLabels.yPos}</label>
                        <input class="homey-form-input" id="display${itemNo}Y" type="number" value="${item.yPos}" />

                        <label class="homey-form-label" for="display${itemNo}Width">${ctrlLabels.width}</label>
                        <input class="homey-form-input" id="display${itemNo}Width" type="number" value="${item.width}" />

                        <label class="homey-form-label" for="display${itemNo}Rounding">${ctrlLabels.rounding}</label>
                        <input class="homey-form-input" id="display${itemNo}Rounding" type="number" value="${item.rounding}" />

                        <label class="homey-form-label" for="display${itemNo}FontSize">${ctrlLabels.fontSize}</label>
                        <select class="homey-form-select" id="display${itemNo}FontSize">
                            <option value=1>1</option>
                            <option value=2>2</option>
                            <option value=3>3</option>
                            <option value=4>4</option>
                        </select>

                        <label class="homey-form-label" for="display${itemNo}Alignment">${ctrlLabels.alignment}</label>
                        <select class="homey-form-select" id="display${itemNo}Alignment">
                            <option value=0>${ctrlLabels.topLeft}</option>
                            <option value=1>${ctrlLabels.topCenter}</option>
                            <option value=2>${ctrlLabels.topRight}</option>
                            <option value=3>${ctrlLabels.centerLeft}</option>
                            <option value=4>${ctrlLabels.center}</option>
                            <option value=5>${ctrlLabels.centerRight}</option>
                            <option value=6>${ctrlLabels.bottomLeft}</option>
                            <option value=7>${ctrlLabels.bottomCenter}</option>
                            <option value=8>${ctrlLabels.bottomRight}</option>
                        </select><br>
                        <p><button class="homey-button-secondary-shadow" id="deleteDisplayItem" onClick="deleteItem(${itemNo})" style="font-size: 30px;"><i class="fi fi-rr-trash"></i> </button></p>
                    </div>
                </div>`;

            document.getElementById('displayItemsSection').innerHTML = section;
            // fillDevicesElement(document.getElementById(`display${itemNo}Device`));
        }

        function fillDisplayDevices()
        {
            // Get the current display configuration
            var displayConfig = localDisplayConfigurations[displayConfigurationNoElement.value];

            if (displayConfig)
            {
                for (var itemNo = 0; itemNo < displayConfig.items.length; itemNo++)
                {
                    fillDevicesElement(document.getElementById(`display${itemNo}Device`));
                    document.getElementById(`display${itemNo}Device`).value = displayConfig.items[itemNo].device;
                    getDisplayCapabilities(itemNo);
                }
            }
        }

        function getDisplayCapabilities(item)
        {
            var deviceId = document.getElementById(`display${item}Device`).value;
            var capabilitiesElement = document.getElementById(`display${item}Capability`);
            capabilitiesElement.innerHTML = "";
            if ((deviceId != "") && (deviceId != 'none'))
            {
                Homey.api('POST', '/device_capabilities/', { deviceId }, function(err, capabilities)
                {
                    if (err) return Homey.alert(err);

                    if (capabilities)
                    {
                        displayCapabilityItems[item].capabilities = capabilities;
                        const capabilitiesArray = Object.values(capabilities);
                        for (const capability of capabilitiesArray)
                        {
                            var option = document.createElement("option");
                            option.text = capability.title;
                            option.value = capability.id;
                            capabilitiesElement.add(option);
                        }
                        capabilitiesElement.style.visibility = "visible";

                        var displayConfig = localDisplayConfigurations[displayConfigurationNoElement.value];
                        if (displayConfig)
                        {
                            const capabilityID = displayConfig.items[item].capability;
                            if (capabilities[capabilityID])
                            {
                                capabilitiesElement.value = capabilityID;
                                document.getElementById(`display${item}Label`).value = capabilities[capabilityID].title;
                                document.getElementById(`display${item}Units`).value = capabilities[capabilityID].units ? capabilities[capabilityID].units : "";
                            }
                            else
                            {
                                capabilitiesElement.value = "";
                            }
                        }
                    }
                });
            }
        }

        function selectDisplayCapabilities(item)
        {
            const capabilities = displayCapabilityItems[item].capabilities
            var capabilityID = document.getElementById(`display${item}Capability`).value;
            if (capabilityID != "" && capabilities[capabilityID])
            {
                document.getElementById(`display${item}Label`).value = capabilities[capabilityID].title
                document.getElementById(`display${item}Units`).value = capabilities[capabilityID].units ? capabilities[capabilityID].units : "";
            }
        }

        function deleteItem(itemNo)
        {
            // Save all the settings so they don't get lost when the controls are redawn
            storeDevicesSettings();

            var displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];

            if (displayConfiguration != null)
            {
                displayConfiguration.items.splice(itemNo, 1);
                drawDisplayConfiguration(displayConfiguration);
            }
        }

        function storeDevicesSettings()
        {
            var displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];

            if (displayConfiguration != null)
            {
                for (var itemNo = 0; itemNo < displayConfiguration.items.length; itemNo++)
                {
                    displayConfiguration.items[itemNo].device = document.getElementById(`display${itemNo}Device`).value;
                    displayConfiguration.items[itemNo].capability = document.getElementById(`display${itemNo}Capability`).value;
                    displayConfiguration.items[itemNo].label = document.getElementById(`display${itemNo}Label`).value;
                    displayConfiguration.items[itemNo].units = document.getElementById(`display${itemNo}Units`).value;
                    displayConfiguration.items[itemNo].xPos = document.getElementById(`display${itemNo}X`).value;
                    displayConfiguration.items[itemNo].yPos = document.getElementById(`display${itemNo}Y`).value;
                    displayConfiguration.items[itemNo].width = document.getElementById(`display${itemNo}Width`).value;
                    displayConfiguration.items[itemNo].rounding = document.getElementById(`display${itemNo}Rounding`).value;
                    displayConfiguration.items[itemNo].fontSize = document.getElementById(`display${itemNo}FontSize`).value;
                    displayConfiguration.items[itemNo].alignment = document.getElementById(`display${itemNo}Alignment`).value;
                }
            }
        }
    </script>
</body>

</html>