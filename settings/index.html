<!doctype html>
<html>

<head>
    <!-- The '/homey.js' script must be included in your settings view to work -->
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
    <link rel="stylesheet" type="text/css" href="extraStyles.css">
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css'>
</head>

<body>
    <div class="fixedTop">
        <label class="homey-form-label" for="configType" style="margin-top:0px"><span data-i18n="settings.view"></span></label>
        <select class="homey-form-select" id="configType">
            <option value="settings" data-i18n="settings.Settings"></option>
            <option value="panelConfig" data-i18n="settings.buttonConfigs"></option>
            <option value="displayConfig" data-i18n="settings.displayConfigs"></option>
            <option value="brokerConfig" data-i18n="settings.brokerConfigs"></option>
        </select>
        <hr style="margin-top:8px;margin-bottom:0px;background-color:lightblue">
    </div>
    
    <div class="main">
        <!-- Settings page -->
        
        <div id="settings" class="tabcontent">
            <fieldset class="homey-form-fieldset">
                <legend class="homey-form-legend"><span data-i18n="settings.Settings"></span></legend>
                <label class="homey-form-checkbox">
                    <input class="homey-form-checkbox-input" id="autoConfig" type="checkbox" value="auto" />
                    <span class="homey-form-checkbox-checkmark"></span>
                    <span class="homey-form-checkbox-text"><span data-i18n="settings.autoConfig"></span></span>
                </label>
                <div id="AutoConfigWarnOff"><span data-i18n="settings.autoConfigWarning1"></span></div>
                <div id="AutoConfigWarnOn"><span data-i18n="settings.autoConfigWarning2"></span></div>
            </fieldset>
        </div>
        <fieldset class="homey-form-fieldset">
            <!-- Button Bar Configuration -->

            <div id="panelConfig" class="tabcontent">
                <div class="homey-form-group">
                    <div style="padding: 10px 10px 10px 10px; border: 1px solid lightblue; border-radius: 10px">
                        <div class="tooltip"><i class="fi fi-rr-info"></i>
                            <span class="tooltiptext" data-i18n="settings.buttonExplanation"></span>
                        </div>

                        <select class="homey-form-select" id="ButtonPanelConfigurationNo">
                        </select>
                        <div class="horizontalcontainer">
                            <div class="horizontalgroup">
                                <legend class="homey-subtitle"><span data-i18n="settings.leftPanel"></span></legend>

                                <label class="homey-form-label" for="leftDevice"><span data-i18n="settings.device"></span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext" data-i18n="settings.deviceExplanation"></span>
                                    </div>
                                </label>
                                <select class="homey-form-select" id="leftDevice">
                                    <option value="" selected disabled hidden><span data-i18n="settings.device"></option>
                                </select>

                                <span>
                                    <div id="leftCapabilityDiv">
                                        <label class="homey-form-label" id="leftCapabilityLabel" for="leftCapability"><span data-i18n="settings.capability"></span>
                                        </label>
                                        <select class="homey-form-select" id="leftCapability">
                                            <option value="" selected disabled hidden><span data-i18n="settings.selectCapability"></span></option>
                                        </select>
                                    </div>
                                </span>

                                <label class="homey-form-label" for="leftTopText"><span data-i18n="settings.topLabel"></span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext" data-i18n="settings.topLabelExplanation"></span>
                                    </div>
                                </label>
                                <input class="homey-form-input" id="leftTopText" type="text" maxlength="20" value="" />

                                <span>
                                    <div id="leftOnTextDiv">
                                        <label class="homey-form-label" id="leftOnTextLabel" for="leftOnText"><span data-i18n="settings.labelOn"></span>
                                            <div class="tooltip"><i class="fi fi-rr-info"></i>
                                                <span class="tooltiptext" data-i18n="settings.labelOnExplantion"></span>
                                            </div>
                                        </label>
                                        <input class="homey-form-input" id="leftOnText" type="text" maxlength="20" value="" />
                                    </div>
                                </span>

                                <span>
                                    <div id="leftDimChangeDiv">
                                        <label class="homey-form-label" id="leftDimChangeLabel" for="leftDimChange"><span data-i18n="settings.dimValue"></span>
                                            <div class="tooltip"><i class="fi fi-rr-info"></i>
                                                <span class="tooltiptext" data-i18n="settings.dimChangeExplanation"></span>
                                            </div>
                                        </label>
                                        <input class="homey-form-input" id="leftDimChange" type="text" maxlength="20" value="" />
                                    </div>
                                </span>

                                <label class="homey-form-label" id="leftOffTextLabel" for="leftOffText"><span data-i18n="settings.labelOff"></span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext" data-i18n="settings.labelOffExplantion"></span>
                                    </div>
                                </label>
                                <input class="homey-form-input" id="leftOffText" type="text" maxlength="20" value="" />

                                <label class="homey-form-label" id="leftFrontLEDColorLabel" for="leftFrontLEDColor"><span data-i18n="settings.frontLEDColor"></span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext" data-i18n="settings.frontLEDColorExplanation"></span>
                                    </div>
                                </label>
                                <input class="homey-form-input" id="leftFrontLEDColor" type="color" value="" />

                                <label class="homey-form-label" id="leftWallLEDColorLabel" for="leftFrontLEDColor"><span data-i18n="settings.wallLEDColor"></span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext" data-i18n="settings.wallLEDColorExplanation"></span>
                                    </div>
                                </label>
                                <input class="homey-form-input" id="leftWallLEDColor" type="color" value="" />

                                <span>
                                    <div id="leftBrokerIdDiv">
                                        <label class="homey-form-label" for="leftBrokerId"><span data-i18n="settings.brokerId"></span>
                                            <div class="tooltip"><i class="fi fi-rr-info"></i>
                                                <span class="tooltiptext" data-i18n="settings.brokerIdExplanation"></span>
                                            </div>
                                        </label>
                                        <select class="homey-form-select" id="leftBrokerId">
                                        </select>
                                    </div>
                                </span>

                                <span>
                                    <div id="leftCustomMQTTDiv">
                                        <br>
                                        <div id="leftCustomMQTTTopicsSection"></div>
                                        <p><button class="homey-button-secondary-shadow" id="newLeftCustomMQTTItem"><span data-i18n="settings.newCustomMQTTItem"></span></button></p>
                                    </div>
                                </span>

                            </div>
                            <div class="horizontalgroup">
                                <legend class="homey-subtitle"><span data-i18n="settings.rightPanel"></span></legend>

                                <label class="homey-form-label" for="rightDevice"><span data-i18n="settings.device"></span></label>
                                <select class="homey-form-select" id="rightDevice">
                                    <option value="" selected disabled hidden><span data-i18n="settings.selectDevice"></span></option>
                                </select>

                                <span>
                                    <div id="rightCapabilityDiv">
                                        <label class="homey-form-label" id="rightCapabilityLabel" for="rightCapability"><span data-i18n="settings.capability"></span></label>
                                        <select class="homey-form-select" id="rightCapability">
                                            <option value="" selected disabled hidden><span data-i18n="settings.selectCapability"></span></option>
                                        </select>
                                    </div>
                                </span>

                                <label class="homey-form-label" for="rightTopText"><span data-i18n="settings.topLabel"></span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext" data-i18n="settings.topLabelExplanation"></span>
                                    </div>
                                </label>
                                <input class="homey-form-input" id="rightTopText" type="text" maxlength="20" value="" />

                                <span>
                                    <div id="rightOnTextDiv">
                                        <label class="homey-form-label" id="rightOnTextLabel" for="rightOnText"><span data-i18n="settings.labelOn"></span>
                                            <div class="tooltip"><i class="fi fi-rr-info"></i>
                                                <span class="tooltiptext" data-i18n="settings.labelOnExplantion"></span>
                                            </div>
                                        </label>
                                        <input class="homey-form-input" id="rightOnText" type="text" maxlength="20" value="" />
                                    </div>
                                </span>

                                <span>
                                    <div id="rightDimChangeDiv">
                                        <label class="homey-form-label" id="rightDimChangeLabel" for="rightDimChange"><span data-i18n="settings.dimValue"></span>
                                            <div class="tooltip"><i class="fi fi-rr-info"></i>
                                                <span class="tooltiptext" data-i18n="settings.dimChangeExplanation"></span>
                                            </div>
                                        </label>
                                        <input class="homey-form-input" id="rightDimChange" type="text" maxlength="20" value="" />
                                    </div>
                                </span>

                                <label class="homey-form-label" id="rightOffTextLabel" for="rightOffText"><span data-i18n="settings.labelOff"></span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext" data-i18n="settings.labelOffExplantion"></span>
                                    </div>
                                </label>
                                <input class="homey-form-input" id="rightOffText" type="text" maxlength="20" value="" />

                                <label class="homey-form-label" id="rightFrontLEDColorLabel" for="rightFrontLEDColor"><span data-i18n="settings.frontLEDColor"></span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext" data-i18n="settings.frontLEDColorExplanation"></span>
                                    </div>
                                </label>
                                <input class="homey-form-input" id="rightFrontLEDColor" type="color" value="" />

                                <label class="homey-form-label" id="rightWallLEDColorLabel" for="rightFrontLEDColor"><span data-i18n="settings.wallLEDColor"></span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext" data-i18n="settings.wallLEDColorExplanation"></span>
                                    </div>
                                </label>
                                <input class="homey-form-input" id="rightWallLEDColor" type="color" value="" />

                                <span>
                                    <div id="rightBrokerIdDiv">
                                        <label class="homey-form-label" for="rightBrokerId"><span data-i18n="settings.brokerId"></span>
                                            <div class="tooltip"><i class="fi fi-rr-info"></i>
                                                <span class="tooltiptext" data-i18n="settings.brokerIdExplanation"></span>
                                            </div>
                                        </label>
                                        <select class="homey-form-select" id="rightBrokerId">
                                        </select>
                                    </div>
                                </span>
                                <span>
                                    <div id="rightCustomMQTTDiv">
                                        <br>
                                        <div id="rightCustomMQTTTopicsSection"></div>
                                        <p><button class="homey-button-secondary-shadow" id="newRightCustomMQTTItem"><span data-i18n="settings.newCustomMQTTItem"></span></button></p>
                                    </div>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Display Configuration -->

            <div id="displayConfig" class="tabcontent">
                <div class="homey-form-group">
                    <div style="padding: 10px 10px 10px 10px; border: 1px solid lightblue; border-radius: 10px">
                        <div class="tooltip"><i class="fi fi-rr-info"></i>
                            <span class="tooltiptext" data-i18n="settings.displayExplanation"></span>
                        </div>

                        <select class="homey-form-select" id="displayConfigurationNo">
                        </select>
                    </div>
                    <div id="displayItemsSection"></div>
                </div>
                <p><button class="homey-button-secondary-shadow" id="newDisplayItem"><span data-i18n="settings.newDisplayItem"></span></button></p>
            </div>

            <!-- Broker Configuration -->

            <div id="brokerConfig" class="tabcontent">
                <div class="homey-form-group">
                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                        <span class="tooltiptext" data-i18n="settings.brokerExplanation"></span>
                    </div>

                    <div id="brokerItemsSection"></div>
                </div>
                <p><button class="homey-button-secondary-shadow" id="newBrokerItem"><span data-i18n="settings.newBrokerItem"></span></button></p>
            </div>

        </fieldset>
    </div>

    <!-- Save Configuration button -->

    <div class="bottomFixButtonComponent">
        <button class="homey-button-primary-full" id="save"><span data-i18n="settings.save"></span></button>
    </div>

    <!-- Code to handle page life -->

    <script type="text/javascript">
        // General declarations
        var buttonDevicesArray = [];
        var buttonDevicesFetched = false;
        var displayDevicesArray = [];
        var displayDevicesFetched = false;
        var autoConfigElement = document.getElementById('autoConfig');
        var configTypeElement = document.getElementById('configType');
        var saveButton = document.getElementById('save');

        // Declarations for the Button Bar Config page

        var buttonConfigurationNoElement = document.getElementById('ButtonPanelConfigurationNo');

        var leftTopTextElement = document.getElementById('leftTopText');
        var leftOnTextElement = document.getElementById('leftOnText');
        var leftOffTextElement = document.getElementById('leftOffText');
        var leftDimChangeElement = document.getElementById('leftDimChange');
        var leftDeviceElement = document.getElementById('leftDevice');
        var leftCapabilityElement = document.getElementById('leftCapability');
        var leftBrokerIdElement = document.getElementById('leftBrokerId');
        var newLeftCustomMQTTItemButton = document.getElementById('newLeftCustomMQTTItem');
        var leftFrontLEDColorElement = document.getElementById('leftFrontLEDColor');
        var leftWallLEDColorElement = document.getElementById('leftWallLEDColor');

        var rightTopTextElement = document.getElementById('rightTopText');
        var rightOnTextElement = document.getElementById('rightOnText');
        var rightOffTextElement = document.getElementById('rightOffText');
        var rightDimChangeElement = document.getElementById('rightDimChange');
        var rightDeviceElement = document.getElementById('rightDevice');
        var rightCapabilityElement = document.getElementById('rightCapability');
        var rightBrokerIdElement = document.getElementById('rightBrokerId');
        var newRightCustomMQTTItemButton = document.getElementById('newRightCustomMQTTItem');
        var rightFrontLEDColorElement = document.getElementById('rightFrontLEDColor');
        var rightWallLEDColorElement = document.getElementById('rightWallLEDColor');

        var buttonConfigurationsFetched = false;
        var localbuttonConfigurations = [];
        var currentButtonConfigurationNo = 0;
        var customMQTTItemsElements = [];

        // Declarations for the Display Config page

        var displayConfigurationNoElement = document.getElementById('displayConfigurationNo');
        var newDisplayItemButton = document.getElementById('newDisplayItem');

        var displayConfigurationsFetched = false;
        var localDisplayConfigurations = [];
        var currentDisplayConfigurationNo = 0;
        var displayCapabilityItems = [];

        // Declarations for the Broker Config page
        var newBrokerItemButton = document.getElementById('newBrokerItem');
        var localBrokerItems = [];
        var brokerItemsFetched = false;

        var itemDisplyType = "flex";

        // a method named 'onHomeyReady' must be present in your code
        function onHomeyReady(Homey)
        {
            itemDisplyType = document.getElementById('leftCapabilityDiv').style.display;

            fillConfigElement(buttonConfigurationNoElement, Homey.__("settings.buttonConfig"));
            fillConfigElement(displayConfigurationNoElement, Homey.__("settings.displayConfig"));

            getButtonDeivices();
            getDisplayDeivices();
            configTypeChanged('panelConfig');

            Homey.get('autoConfig', function(err, autoConfig)
            {
                if (err) return Homey.alert(err);
                autoConfigElement.checked = autoConfig;
                autoConfigChanged();
            });

            Homey.get('brokerConfigurationItems', function(err, brokerItems)
            {
                if (err) return Homey.alert(err);
                brokerItemsFetched = true;
                localBrokerItems = brokerItems;

                // Setup the list items for enabled brokers in the panel config
                for (let i = 0; i < localBrokerItems.length; i++)
                {
                    const brokerItem = localBrokerItems[i];
                    if (brokerItem.enabled)
                    {
                        var option = document.createElement("option");
                        option.value = brokerItem.brokerid;
                        option.text = brokerItem.brokerid;
                        leftBrokerIdElement.add(option);
                        if (buttonConfigurationsFetched)
                        {
                            leftBrokerIdElement.value = localbuttonConfigurations[currentButtonConfigurationNo].leftBrokerId;
                        }

                        var option = document.createElement("option");
                        option.value = brokerItem.brokerid;
                        option.text = brokerItem.brokerid;
                        rightBrokerIdElement.add(option);
                        if (buttonConfigurationsFetched)
                        {
                            rightBrokerIdElement.value = localbuttonConfigurations[currentButtonConfigurationNo].rightBrokerId;
                        }

                        // Add the broker to the custom MQTT topic broker lists
                        for (let k = 0; k < customMQTTItemsElements.length; k++)
                        {
                            var option = document.createElement("option");
                            option.value = brokerItem.brokerid;
                            option.text = brokerItem.brokerid;
                            customMQTTItemsElements[k].add(option);
                        }

                        if (displayConfigurationsFetched)
                        {
                            // Add the broker to the display config broker lists
                            const displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];
                            for (let j = 0; j < displayConfiguration.items.length; j++)
                            {
                                const displayItem = displayConfiguration.items[j];
                                var optionDisplay = document.createElement("option");
                                optionDisplay.value = brokerItem.brokerid;
                                optionDisplay.text = brokerItem.brokerid;
                                document.getElementById(`display${j}BrokerId`).add(optionDisplay);
                                document.getElementById(`display${j}BrokerId`).value = displayItem.brokerId;
                            }
                        }
                    }
                }

                drawBrokerItems();
            });

            autoConfigElement.addEventListener('click', function(e)
            {
                Homey.set('autoConfig', autoConfigElement.checked);
                autoConfigChanged();
            });

            configTypeElement.addEventListener('change', function(e)
            {
                configTypeChanged(configTypeElement.value);
            });

            saveButton.addEventListener('click', function(e)
            {
                if (autoConfigElement.checked)
                {
                    if (storeBrokerSettings())
                    {
                        Homey.set('brokerConfigurationItems', localBrokerItems);
                    }

                    if (leftCapabilityElement.value === 'dim')
                    {
                        const dimVal = parseInt(leftDimChangeElement.value, 10);
                        if (dimVal < -100 || dimVal > 100 || dimVal === 0)
                        {
                            Homey.alert(Homey.__("settings.dimError", { leftRight: Homey.__("settings.leftPanel") }));
                            return;
                        }
                    }

                    if (rightCapabilityElement.value === 'dim')
                    {
                        const dimVal = parseInt(rightDimChangeElement.value, 10);
                        if (dimVal < -100 || dimVal > 100 || dimVal === 0)
                        {
                            // Get the translated string and insert the Right text
                            Homey.alert(Homey.__("settings.dimError", { leftRight: Homey.__("settings.rightPanel") }));
                            return;
                        }
                    }

                    var ButtonPanelConfigurationNo = buttonConfigurationNoElement.value;
                    const ButtonPanelConfiguration = localbuttonConfigurations[ButtonPanelConfigurationNo]

                    storeCustomMQTTItems("left", ButtonPanelConfiguration);
                    storeCustomMQTTItems("right", ButtonPanelConfiguration);

                    // Copy the values from the controls to the buttonConfiguration
                    ButtonPanelConfiguration.leftTopText = leftTopTextElement.value,
                    ButtonPanelConfiguration.leftOnText = leftOnTextElement.value,
                    ButtonPanelConfiguration.leftOffText = leftOffTextElement.value,
                    ButtonPanelConfiguration.leftDevice = leftDeviceElement.value,
                    ButtonPanelConfiguration.leftCapability = leftCapabilityElement.value,
                    ButtonPanelConfiguration.leftBrokerId = leftBrokerIdElement.value,
                    ButtonPanelConfiguration.leftDimChange = leftDimChangeElement.value,
                    ButtonPanelConfiguration.leftFrontLEDColor = leftFrontLEDColorElement.value,
                    ButtonPanelConfiguration.leftWallLEDColor = leftWallLEDColorElement.value,

                    ButtonPanelConfiguration.rightTopText = rightTopTextElement.value,
                    ButtonPanelConfiguration.rightOnText = rightOnTextElement.value,
                    ButtonPanelConfiguration.rightOffText = rightOffTextElement.value,
                    ButtonPanelConfiguration.rightDevice = rightDeviceElement.value,
                    ButtonPanelConfiguration.rightCapability = rightCapabilityElement.value,
                    ButtonPanelConfiguration.rightBrokerId = rightBrokerIdElement.value,
                    ButtonPanelConfiguration.rightDimChange = rightDimChangeElement.value,
                    ButtonPanelConfiguration.rightFrontLEDColor = rightFrontLEDColorElement.value,
                    ButtonPanelConfiguration.rightWallLEDColor = rightWallLEDColorElement.value,

                    Homey.set('buttonConfigurations', localbuttonConfigurations);

                    //Copy the values from the controls to the displayConfiguration
                    storeDisplaySettings();
                    Homey.set('displayConfigurations', localDisplayConfigurations);

                    Homey.alert(Homey.__("settings.saved"));
                }
                else
                {
                    Homey.alert(Homey.__("settings.saveError1"));
                }
            });

            // Button Bar Config code

            Homey.get('buttonConfigurations', function(err, buttonConfigurations)
            {
                if (err) return Homey.alert(err);
                localbuttonConfigurations = buttonConfigurations;
                buttonConfigurationsFetched = true;
                console.log('buttonConfigurations: ' + JSON.stringify(buttonConfigurations));
                updateButtonPanelConfiguration();
            });

            buttonConfigurationNoElement.addEventListener('change', function(e)
            {
                // Store the current configuration
                var buttonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];

                buttonPanelConfiguration.leftTopText = leftTopTextElement.value;
                buttonPanelConfiguration.leftOnText = leftOnTextElement.value;
                buttonPanelConfiguration.leftOffText = leftOffTextElement.value;
                buttonPanelConfiguration.leftDevice = leftDeviceElement.value;
                buttonPanelConfiguration.leftCapability = leftCapabilityElement.value;
                buttonPanelConfiguration.leftBrokerId = leftBrokerIdElement.value;
                buttonPanelConfiguration.leftDimChange = leftDimChangeElement.value;
                buttonPanelConfiguration.leftFrontLEDColor = leftFrontLEDColorElement.value;
                buttonPanelConfiguration.leftWallLEDColor = leftWallLEDColorElement.value;
                buttonPanelConfiguration.leftCustomMQTTTopics = buttonPanelConfiguration.leftCustomMQTTTopics;


                buttonPanelConfiguration.rightTopText = rightTopTextElement.value;
                buttonPanelConfiguration.rightOnText = rightOnTextElement.value;
                buttonPanelConfiguration.rightOffText = rightOffTextElement.value;
                buttonPanelConfiguration.rightDevice = rightDeviceElement.value;
                buttonPanelConfiguration.rightCapability = rightCapabilityElement.value;
                buttonPanelConfiguration.rightBrokerId = rightBrokerIdElement.value;
                buttonPanelConfiguration.rightDimChange = rightDimChangeElement.value;
                buttonPanelConfiguration.rightFrontLEDColor = rightFrontLEDColorElement.value;
                buttonPanelConfiguration.rightWallLEDColor = rightWallLEDColorElement.value;
                buttonPanelConfiguration.rightCustomMQTTTopics = buttonPanelConfiguration.rightCustomMQTTTopics;

                // Fetch the new configuration
                updateButtonPanelConfiguration();
            });

            leftTopTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftTopText = leftTopTextElement.value;
            });

            leftOnTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftOnText = leftOnTextElement.value;
            });

            leftOffTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftOffText = leftOffTextElement.value;
            });

            leftDimChangeElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftDimChange = leftDimChangelement.value;
            });

            leftFrontLEDColorElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftFrontLEDColor = leftFrontLEDColorElement.value;
            });

            leftWallLEDColorElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftWallLEDColor = leftWallLEDColorElement.value;
            });

            rightTopTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightTopText = rightTopTextElement.value;
            });

            rightOnTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightOnText = rightOnTextElement.value;
            });

            rightOffTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightOffText = rightOffTextElement.value;
            });

            rightDimChangeElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightDimChange = rightDimChangelement.value;
            });

            rightFrontLEDColorElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightFrontLEDColor = rightFrontLEDColorElement.value;
            });

            rightWallLEDColorElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightWallLEDColor = rightWallLEDColorElement.value;
            });

            leftDeviceElement.addEventListener('change', function(e)
            {
                // Get the current button configuration
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];

                // Update the device in the local configuration
                ButtonPanelConfiguration.leftDevice = leftDeviceElement.value;

                // Update the capabilities
                getCapabilities("left", leftDeviceElement.value, ButtonPanelConfiguration.leftCapability);
            });

            rightDeviceElement.addEventListener('change', function(e)
            {
                // Get the current button configuration
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];

                // Update the device in the local configuration
                ButtonPanelConfiguration.rightDevice = rightDeviceElement.value;

                // Update the capabilities
                getCapabilities("right", rightDeviceElement.value, ButtonPanelConfiguration.rightCapability);
            });

            leftCapabilityElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftCapability = leftCapabilityElement.value;

                capabilityChanged("left", leftCapabilityElement.value);
            });

            rightCapabilityElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightCapability = rightCapabilityElement.value;

                capabilityChanged("right", rightCapabilityElement.value);
            });

            leftBrokerIdElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftBrokerId = leftBrokerIdElement.value;
            });

            rightBrokerIdElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightBrokerId = rightBrokerIdElement.value;
            });

            // Display Config code

            displayConfigurationNoElement.addEventListener('change', function(e)
            {
                // Store the current configuration
                storeDisplaySettings();

                // Fetch the new configuration
                updateDisplayConfiguration();
            });

            newDisplayItemButton.addEventListener('click', function(e)
            {
                if (displayConfigurationsFetched)
                {
                    // Make sure the current item is saved in the local display configuration
                    storeDisplaySettings();

                    // Create a new display item
                    displayConfigurationNo = displayConfigurationNoElement.value;
                    var displayConfiguration = localDisplayConfigurations[displayConfigurationNo];
                    if (displayConfiguration)
                    {
                        var displayItem = {
                            device: "none",
                            capability: "",
                            label: "",
                            unit: "",
                            numberRounding: 0,
                            xPos: 0,
                            yPos: 0,
                            width: 100,
                            fontSize: 1,
                            alignment: 0,
                            brokerId: 'homey',
                        };

                        // Add the new display item to the local display configuration
                        displayConfiguration.items.push(displayItem);
                        localDisplayConfigurations[displayConfigurationNo] = displayConfiguration;

                        // Redraw the display items
                        drawDisplayConfiguration(displayConfiguration);
                    }
                }
            });

            newLeftCustomMQTTItemButton.addEventListener('click', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                if (ButtonPanelConfiguration)
                {
                    var customMQTTItem = {
                        id: '',
                        type: 0,
                        topic: "",
                        payload: "",
                        brokerId: 'homey',
                        enable: true,
                    };

                    ButtonPanelConfiguration.leftCustomMQTTTopics.push(customMQTTItem);
                    drawCustomMQTTTopics("left", ButtonPanelConfiguration);
                }
            });

            newRightCustomMQTTItemButton.addEventListener('click', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                if (ButtonPanelConfiguration)
                {
                    var customMQTTItem = {
                        id: '',
                        type: 0,
                        topic: "",
                        payload: "",
                        brokerId: 'homey',
                        enable: true,
                    };

                    ButtonPanelConfiguration.rightCustomMQTTTopics.push(customMQTTItem);
                    drawCustomMQTTTopics("right", ButtonPanelConfiguration);
                }
            });

            Homey.get('displayConfigurations', function(err, displayConfigurations)
            {
                if (err) return Homey.alert(err);
                localDisplayConfigurations = displayConfigurations;
                displayConfigurationsFetched = (localDisplayConfigurations.length > 0);
                updateDisplayConfiguration();
            });

            newBrokerItemButton.addEventListener('click', function(e)
            {
                // Create a new broker item
                var brokerItem = {
                    brokerid: "Unnamed",
                    url: "",
                    port: 1883,
                    wsPort: 9001,
                    enabled: true,
                    protected: false,
                };

                // Add the new broker to the local broker list
                localBrokerItems.push(brokerItem);

                // Add the broker to the broker lists
                addBrokerToConfig(brokerItem);

                // Redraw the broker items
                drawBrokerItems();
            });

            var tooltips = document.querySelectorAll(".tooltip");
            tooltips.forEach(function(tooltip, index)
            {
                // Set a mouse over function for each tooltop element
                tooltip.addEventListener("mouseover", position_tooltip); // On hover, launch the function below
            })

            // Tell Homey we're ready to be displayed
            Homey.ready();
        }

        function position_tooltip()
        {
            // Get .tooltiptext sibling
            var tooltip = this.parentNode.querySelector(".tooltiptext");

            // Get tooltip coordinates and size
            var tooltip_rect = tooltip.getBoundingClientRect();

            // Corrections if out of window
            var maxRight = window.innerWidth - 50;
            var tipRight = tooltip_rect.x + tooltip_rect.width;

            if (tipRight > maxRight)
            {
                tipX = maxRight - tipRight;

                // Apply corrected position
                if (tooltip.style.left === "")
                {
                    tooltip.style.left = tipX + 'px';
                }
                else
                {
                    tooltip.style.left -= tipX + 'px';
                }
            }
        }

        function fillConfigElement(element, txt)
        {
            //fill the device lists with devices
            element.innerHTML = "";

            var option = document.createElement("option");
            for (let i = 0; i < 20; i++)
            {
                var option = document.createElement("option");
                option.value = i;
                option.text = `${txt} ${i + 1}`;
                element.add(option);
            }
        }

        function getButtonDeivices()
        {
            Homey.api('POST', '/Devices/', { type: 'boolean', id: ['dim'] }, function(err, devices)
            {
                if (err) return Homey.alert(err);

                buttonDevicesArray = Object.values(devices);
                buttonDevicesFetched = true;
                fillButtonDevices();
            });
        }

        function getDisplayDeivices()
        {
            Homey.api('POST', '/Devices/', {}, function(err, devices)
            {
                if (err) return Homey.alert(err);

                displayDevicesArray = Object.values(devices);
                displayDevicesFetched = true;
                fillDisplayDevices();
            });
        }

        function fillButtonDevices()
        {
            //fill the device lists with devices
            if (buttonDevicesFetched)
            {
                fillDevicesElement(leftDeviceElement, buttonDevicesArray, true);
                fillDevicesElement(rightDeviceElement, buttonDevicesArray, true);
                updateButtonPanelConfiguration();
            };
        }

        function fillDevicesElement(Element, DevicesArray, button)
        {
            if (Element && (DevicesArray.length > 0))
            {
                //fill the device lists with devices
                Element.innerHTML = "";

                if (button)
                {
                    var option = document.createElement("option");
                    option.text = Homey.__("settings.none");
                    option.value = "none";
                    Element.add(option);
                }
                else
                {
                    var option = document.createElement("option");
                    option.text = Homey.__("settings.variable");
                    option.value = "_variable_";
                    Element.add(option);
                }

                var option = document.createElement("option");
                option.text = Homey.__("settings.customMQTT");
                option.value = "customMQTT";
                Element.add(option);

                for (const device of DevicesArray)
                {
                    var option = document.createElement("option");
                    option.text = device.name;
                    option.value = device.id;
                    Element.add(option);
                }
            }
        }

        function getCapabilities(side, deviceId, selectedCapability)
        {
            // Clear the list options
            let capabilityElement = document.getElementById(`${side}Capability`);
            capabilityElement.innerHTML = "";

            let capabilityDivElement = document.getElementById(`${side}CapabilityDiv`);

            if (deviceId === "none")
            {
                // Hide the capability element items using the div
                capabilityDivElement.style.display = "none";

                // We don't want to show Dim Change value
                document.getElementById(`${side}DimChangeDiv`).style.display = "none";
                document.getElementById(`${side}BrokerIdDiv`).style.display = itemDisplyType;
                document.getElementById(`${side}CustomMQTTDiv`).style.display = "none";
                return;
            }

            if (deviceId === "customMQTT")
            {
                // Hide the capability element items using the div
                capabilityDivElement.style.display = "none";

                // We don't want to show Dim Change value
                document.getElementById(`${side}DimChangeDiv`).style.display = "none";
                document.getElementById(`${side}BrokerIdDiv`).style.display = "none";

                // Show the custom MQTT section
                document.getElementById(`${side}CustomMQTTDiv`).style.display = itemDisplyType;
                drawCustomMQTTTopics(side, localbuttonConfigurations[currentButtonConfigurationNo]);
                return;
            }

            // Request the capabilities for the selected device
            Homey.api('POST', '/device_capabilities/', { deviceId }, function(err, capabilities)
            {
                if (err) return Homey.alert(err);

                if (capabilities)
                {
                    // Add each of the capabilities to the item drop list
                    const capabilitiesArray = Object.values(capabilities);
                    for (const capability of capabilitiesArray)
                    {
                        if (capability.type === "boolean" || capability.id === "dim")
                        {
                            var option = document.createElement("option");
                            option.text = `${capability.title} (${capability.id}})`;
                            option.value = capability.id;
                            capabilityElement.add(option);
                        }
                    }

                    // Show the capability section
                    capabilityDivElement.style.display = itemDisplyType;
                    document.getElementById(`${side}BrokerIdDiv`).style.display = itemDisplyType;
                    document.getElementById(`${side}CustomMQTTDiv`).style.display = "none";

                    // Restore the previous capability selection
                    capabilityElement.value = selectedCapability;
                    capabilityChanged(side, selectedCapability);
                }
            });
        }

        function capabilityChanged(side, value)
        {
            if (value === "dim")
            {
                // For dim type capabilities we want to show the dim change value
                document.getElementById(`${side}DimChangeDiv`).style.display = itemDisplyType;

                // And we don't want to show the On or Off text
                document.getElementById(`${side}OnTextDiv`).style.display = "none";
                document.getElementById(`${side}OffText`).style.display = "none";
                document.getElementById(`${side}OffTextLabel`).style.display = "none";
            }
            else
            {
                // For Boolean types we don't want to show Dim Change value
                document.getElementById(`${side}DimChangeDiv`).style.display = "none";

                // And we want to show the On and Off text
                document.getElementById(`${side}OnTextDiv`).style.display = itemDisplyType;
                document.getElementById(`${side}OffText`).style.display = itemDisplyType;
                document.getElementById(`${side}OffTextLabel`).style.display = itemDisplyType;
            }
        }

        function updateButtonPanelConfiguration()
        {
            if ((buttonConfigurationsFetched == false) || (buttonDevicesFetched == false)) return;

            if (currentButtonConfigurationNo < 0 || currentButtonConfigurationNo >= localbuttonConfigurations.length)
            {
                currentButtonConfigurationNo = 0;
                buttonConfigurationNoElement.value = currentButtonConfigurationNo;
            }

            if (buttonConfigurationNoElement.value == "")
            {
                leftTopTextElement.value = "";
                leftOnTextElement.value = "";
                leftOffTextElement.value = "";
                leftDeviceElement.value = "";
                leftCapabilityElement.value = "";
                leftBrokerIdElement.value = "homey";
                leftDimChangeElement.value = "+10";
                leftFrontLEDColorElement.value = "#ff0000";
                leftWallLEDColorElement.value = "#ff0000";

                rightTopTextElement.value = "";
                rightOnTextElement.value = "";
                rightOffTextElement.value = "";
                rightDeviceElement.value = "";
                rightCapabilityElement.value = "";
                rightBrokerIdElement.value = "homey";
                rightDimChangeElement.value = "-10";
                rightFrontLEDColorElement.value = "#ff0000";
                rightWallLEDColorElement.value = "#ff0000";
            }
            else
            {
                currentButtonConfigurationNo = buttonConfigurationNoElement.value;
                let ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];

                leftTopTextElement.value = ButtonPanelConfiguration.leftTopText;
                leftOnTextElement.value = ButtonPanelConfiguration.leftOnText;
                leftOffTextElement.value = ButtonPanelConfiguration.leftOffText;
                leftDeviceElement.value = ButtonPanelConfiguration.leftDevice;
                getCapabilities("left", leftDeviceElement.value, ButtonPanelConfiguration.leftCapability);
                leftBrokerIdElement.value = ButtonPanelConfiguration.leftBrokerId;
                leftDimChangeElement.value = ButtonPanelConfiguration.leftDimChange;
                leftFrontLEDColorElement.value = ButtonPanelConfiguration.leftFrontLEDColor;
                leftWallLEDColorElement.value = ButtonPanelConfiguration.leftWallLEDColor;

                rightTopTextElement.value = ButtonPanelConfiguration.rightTopText;
                rightOnTextElement.value = ButtonPanelConfiguration.rightOnText;
                rightOffTextElement.value = ButtonPanelConfiguration.rightOffText;
                rightDeviceElement.value = ButtonPanelConfiguration.rightDevice;
                rightCapabilityElement.value = ButtonPanelConfiguration.rightCapability;
                getCapabilities("right", rightDeviceElement.value, ButtonPanelConfiguration.rightCapability);
                rightBrokerIdElement.value = ButtonPanelConfiguration.rightBrokerId;
                rightDimChangeElement.value = ButtonPanelConfiguration.rightDimChange;
                rightFrontLEDColorElement.value = ButtonPanelConfiguration.rightFrontLEDColor;
                rightWallLEDColorElement.value = ButtonPanelConfiguration.rightWallLEDColor;
            }
        }

        function autoConfigChanged()
        {
            if (!autoConfigElement.checked)
            {
                configTypeChanged("");
                document.getElementById('AutoConfigWarnOff').style.display = "block";
                document.getElementById('AutoConfigWarnOn').style.display = "none";
                saveButton.style.display = "none";
                configTypeElement.style.display = "none";
            }
            else
            {
                configTypeChanged(configTypeElement.value);
                document.getElementById('AutoConfigWarnOff').style.display = "none";
                document.getElementById('AutoConfigWarnOn').style.display = "block";
                saveButton.style.display = "block";
                configTypeElement.style.display = "block";
            }
        }

        function configTypeChanged(configSelected)
        {
            var i, tabcontent, tablinks;

            // Get all elements with class="tabcontent" and hide them
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = configSelected ? 0 : 1; i < tabcontent.length; i++)
            {
                tabcontent[i].style.display = "none";
            }
            if (configSelected !== "")
            {
                document.getElementById(configSelected).style.display = "block";
            }
        }

        // Code for Displaypanel configuration

        function updateDisplayConfiguration()
        {
            if (displayConfigurationsFetched)
            {
                currentDisplayConfigurationNo = displayConfigurationNoElement.value;

                var displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];

                if (displayConfiguration == null)
                {
                    displayConfiguration = {};
                    displayConfiguration.items = [];
                }

                displayCapabilityItems = [];

                drawDisplayConfiguration(displayConfiguration);
            }
        }

        function drawDisplayConfiguration(displayConfiguration)
        {
            document.getElementById('displayItemsSection').innerHTML = "";
            for (var itemNo = 0; itemNo < displayConfiguration.items.length; itemNo++)
            {
                const item = displayConfiguration.items[itemNo];
                const capabilities = {}
                displayCapabilityItems.push(capabilities);
                insertDisplayItemSection(item, itemNo);

                // add the brokers to the display config broker lists
                for (let i = 0; i < localBrokerItems.length; i++)
                {
                    const brokerItem = localBrokerItems[i];
                    if (brokerItem.enabled)
                    {
                        var option = document.createElement("option");
                        option.value = brokerItem.brokerid;
                        option.text = brokerItem.brokerid;
                        document.getElementById(`display${itemNo}BrokerId`).add(option);
                    }
                }
            }
            for (var itemNo = 0; itemNo < displayConfiguration.items.length; itemNo++)
            {
                const item = displayConfiguration.items[itemNo];
                document.getElementById(`display${itemNo}BrokerId`).value = item.brokerId;

                document.getElementById(`display${itemNo}FontSize`).value = item.fontSize;
                document.getElementById(`display${itemNo}Alignment`).value = item.alignment;
                document.getElementById(`display${itemNo}BrokerId`).value = item.brokerId;
            }

            fillDisplayDevices();
        }

        function insertDisplayItemSection(item, itemNo)
        {
            var section = document.getElementById('displayItemsSection').innerHTML;
            const ctrlLabels = {
                device: Homey.__("settings.device"),
                capability: Homey.__("settings.capability"),
                label: Homey.__("settings.label"),
                unit: Homey.__("settings.unit"),
                xPos: Homey.__("settings.xPos"),
                yPos: Homey.__("settings.yPos"),
                width: Homey.__("settings.width"),
                rounding: Homey.__("settings.rounding"),
                fontSize: Homey.__("settings.fontSize"),
                alignment: Homey.__("settings.alignment"),
                topLeft: Homey.__("settings.topLeft"),
                topCenter: Homey.__("settings.topCenter"),
                topRight: Homey.__("settings.topRight"),
                centerLeft: Homey.__("settings.centerLeft"),
                center: Homey.__("settings.center"),
                centerCenter: Homey.__("settings.centerCenter"),
                centerRight: Homey.__("settings.centerRight"),
                bottomLeft: Homey.__("settings.bottomLeft"),
                bottomCenter: Homey.__("settings.bottomCenter"),
                bottomRight: Homey.__("settings.bottomRight"),
                deleteItem: Homey.__("settings.deleteItem"),
                brokerId: Homey.__("settings.brokerId"),
            }
            const itemLegend = Homey.__("settings.displayItemlegend", { itemNo: itemNo + 1 });

            section = section +
                `<div class="horizontalcontainer">
                    <div class="horizontalgroup">
                        <legend class="homey-subtitle">${itemLegend}</legend>

                        <label class="homey-form-label" for="display${itemNo}Device">${ctrlLabels.device}</label>
                        <select class="homey-form-select" id="display${itemNo}Device" onChange="getDisplayCapabilities(${itemNo})">
                        </select>

                        <div id = "display${itemNo}NoCapability"
                            <br>
                            <label class="homey-form-label" for="display${itemNo}Capability">${ctrlLabels.capability}</label>
                            <select class="homey-form-select" id="display${itemNo}Capability" onChange="selectDisplayCapabilities(${itemNo})">
                            </select>
                        </div>
                        <div id = "display${itemNo}NoDisplay"
                            <br>
                            <label class="homey-form-label" for="display${itemNo}Label">${ctrlLabels.label}</label>
                            <input class="homey-form-input" id="display${itemNo}Label" type="text" value="${item.label}" />

                            <label class="homey-form-label" for="display${itemNo}Unit">${ctrlLabels.unit}</label>
                            <input class="homey-form-input" id="display${itemNo}Unit" type="text" value="${item.unit}" />

                            <label class="homey-form-label" for="display${itemNo}X">${ctrlLabels.xPos}</label>
                            <input class="homey-form-input" id="display${itemNo}X" type="number" value="${item.xPos}" />

                            <label class="homey-form-label" for="display${itemNo}Y">${ctrlLabels.yPos}</label>
                            <input class="homey-form-input" id="display${itemNo}Y" type="number" value="${item.yPos}" />

                            <label class="homey-form-label" for="display${itemNo}Width">${ctrlLabels.width}</label>
                            <input class="homey-form-input" id="display${itemNo}Width" type="number" value="${item.width}" />

                            <label class="homey-form-label" for="display${itemNo}Rounding">${ctrlLabels.rounding}</label>
                            <input class="homey-form-input" id="display${itemNo}Rounding" type="number" value="${item.rounding}" />

                            <label class="homey-form-label" for="display${itemNo}FontSize">${ctrlLabels.fontSize}</label>
                            <select class="homey-form-select" id="display${itemNo}FontSize">
                                <option value=1>1</option>
                                <option value=2>2</option>
                                <option value=3>3</option>
                                <option value=4>4</option>
                            </select>

                            <label class="homey-form-label" for="display${itemNo}Alignment">${ctrlLabels.alignment}</label>
                            <select class="homey-form-select" id="display${itemNo}Alignment">
                                <option value=0>${ctrlLabels.topLeft}</option>
                                <option value=1>${ctrlLabels.topCenter}</option>
                                <option value=2>${ctrlLabels.topRight}</option>
                                <option value=3>${ctrlLabels.centerLeft}</option>
                                <option value=4>${ctrlLabels.center}</option>
                                <option value=5>${ctrlLabels.centerRight}</option>
                                <option value=6>${ctrlLabels.bottomLeft}</option>
                                <option value=7>${ctrlLabels.bottomCenter}</option>
                                <option value=8>${ctrlLabels.bottomRight}</option>
                            </select><br>
                        </div>
                        <label class="homey-form-label" for="display${itemNo}BrokerId">${ctrlLabels.brokerId}</label>
                            <select class="homey-form-select" id="display${itemNo}BrokerId">
                            </select>
                            <br>
                        <p><button class="homey-button-secondary-shadow" id="deleteItem" onClick="deleteItem(${itemNo})" style="font-size: 30px;"><i class="fi fi-rr-trash"></i> </button></p>
                    </div>
                </div>`;

            document.getElementById('displayItemsSection').innerHTML = section;
        }

        function fillDisplayDevices()
        {
            if (displayDevicesFetched)
            {
                // Get the current display configuration
                var displayConfig = localDisplayConfigurations[displayConfigurationNoElement.value];

                if (displayConfig)
                {
                    for (var itemNo = 0; itemNo < displayConfig.items.length; itemNo++)
                    {
                        fillDevicesElement(document.getElementById(`display${itemNo}Device`), displayDevicesArray);
                        document.getElementById(`display${itemNo}Device`).value = displayConfig.items[itemNo].device;
                        getDisplayCapabilities(itemNo);
                    }
                }
            }
        }

        function getDisplayCapabilities(item)
        {
            var deviceId = document.getElementById(`display${item}Device`).value;
            var capabilitiesElement = document.getElementById(`display${item}Capability`);
            capabilitiesElement.innerHTML = "";
            if ((deviceId != "") && (deviceId != 'none'))
            {
                if (deviceId === 'customMQTT')
                {
                    document.getElementById(`display${item}NoCapability`).style.display = "none";
                    document.getElementById(`display${item}NoDisplay`).style.display = itemDisplyType;
                    return;
                }
                if (deviceId === '_variable_')
                {
                    // Resquest the list of variables
                    Homey.api('POST', '/get_variables/', {}, function(err, variables)
                    {
                        if (err) return Homey.alert(err);

                        if (variables)
                        {
                            displayCapabilityItems[item].capabilities = variables;
                            const variablesArray = Object.values(variables);
                            for (const variable of variablesArray)
                            {
                                var option = document.createElement("option");
                                option.text = `${variable.name}`;
                                option.value = variable.id;
                                capabilitiesElement.add(option);
                            }

                            document.getElementById(`display${item}NoCapability`).style.display = itemDisplyType;
                            document.getElementById(`display${item}NoDisplay`).style.display = itemDisplyType;

                            var displayConfig = localDisplayConfigurations[displayConfigurationNoElement.value];
                            if (displayConfig)
                            {
                                const variableID = displayConfig.items[item].capability;
                                if (variables[variableID])
                                {
                                    capabilitiesElement.value = variableID;
                                    if (document.getElementById(`display${item}Label`).value === '')
                                    {
                                        document.getElementById(`display${item}Label`).value = variables[variableID].name;
                                    }
                                    if (document.getElementById(`display${item}Unit`).value === '')
                                    {
                                        document.getElementById(`display${item}Unit`).value = "";
                                    }
                                }
                                else
                                {
                                    capabilitiesElement.value = "";
                                }
                            }
                        }
                    });
                    return;
                }
                Homey.api('POST', '/device_capabilities/', { deviceId }, function(err, capabilities)
                {
                    if (err) return Homey.alert(err);

                    if (capabilities)
                    {
                        displayCapabilityItems[item].capabilities = capabilities;
                        const capabilitiesArray = Object.values(capabilities);
                        for (const capability of capabilitiesArray)
                        {
                            var option = document.createElement("option");
                            option.text = `${capability.title} (${capability.id}})`;
                            option.value = capability.id;
                            capabilitiesElement.add(option);
                        }

                        document.getElementById(`display${item}NoCapability`).style.display = itemDisplyType;
                        document.getElementById(`display${item}NoDisplay`).style.display =itemDisplyType;

                        var displayConfig = localDisplayConfigurations[displayConfigurationNoElement.value];
                        if (displayConfig)
                        {
                            const capabilityID = displayConfig.items[item].capability;
                            if (capabilities[capabilityID])
                            {
                                capabilitiesElement.value = capabilityID;
                                if (document.getElementById(`display${item}Label`).value === '')
                                {
                                    document.getElementById(`display${item}Label`).value = capabilities[capabilityID].title;
                                }
                                if (document.getElementById(`display${item}Unit`).value === '')
                                {
                                    document.getElementById(`display${item}Unit`).value = capabilities[capabilityID].unit ? capabilities[capabilityID].unit : "";
                                }
                            }
                            else
                            {
                                capabilitiesElement.value = "";
                            }
                        }
                    }
                });
            }
            else
            {
                document.getElementById(`display${item}NoCapability`).style.display = "none";
                document.getElementById(`display${item}NoDisplay`).style.display = "none";
            }
        }

        function selectDisplayCapabilities(item)
        {
            const capabilities = displayCapabilityItems[item].capabilities
            var capabilityID = document.getElementById(`display${item}Capability`).value;
            if (capabilityID != "" && capabilities[capabilityID])
            {
                document.getElementById(`display${item}Label`).value = capabilities[capabilityID].title ? capabilities[capabilityID].title : capabilities[capabilityID].name;
                document.getElementById(`display${item}Unit`).value = capabilities[capabilityID].units ? capabilities[capabilityID].units : "";
            }
        }

        function deleteItem(itemNo)
        {
            // Save all the settings so they don't get lost when the controls are redawn
            storeDisplaySettings();

            var displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];

            if (displayConfiguration != null)
            {
                displayConfiguration.items.splice(itemNo, 1);
                drawDisplayConfiguration(displayConfiguration);
            }
        }

        function storeDisplaySettings()
        {
            var displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];

            if (displayConfiguration != null)
            {
                for (var itemNo = 0; itemNo < displayConfiguration.items.length; itemNo++)
                {
                    displayConfiguration.items[itemNo].device = document.getElementById(`display${itemNo}Device`).value;
                    displayConfiguration.items[itemNo].capability = document.getElementById(`display${itemNo}Capability`).value;
                    displayConfiguration.items[itemNo].label = document.getElementById(`display${itemNo}Label`).value;
                    displayConfiguration.items[itemNo].unit = document.getElementById(`display${itemNo}Unit`).value;
                    displayConfiguration.items[itemNo].xPos = document.getElementById(`display${itemNo}X`).value;
                    displayConfiguration.items[itemNo].yPos = document.getElementById(`display${itemNo}Y`).value;
                    displayConfiguration.items[itemNo].width = document.getElementById(`display${itemNo}Width`).value;
                    displayConfiguration.items[itemNo].rounding = document.getElementById(`display${itemNo}Rounding`).value;
                    displayConfiguration.items[itemNo].fontSize = document.getElementById(`display${itemNo}FontSize`).value;
                    displayConfiguration.items[itemNo].alignment = document.getElementById(`display${itemNo}Alignment`).value;
                    displayConfiguration.items[itemNo].brokerId = document.getElementById(`display${itemNo}BrokerId`).value;
                }
            }
        }

        /// Broker Config code
        function drawBrokerItems()
        {
            document.getElementById('brokerItemsSection').innerHTML = "";
            for (var itemNo = 0; itemNo < localBrokerItems.length; itemNo++)
            {
                const item = localBrokerItems[itemNo];
                insertBrokerItemSection(item, itemNo);
            }
        }

        function insertBrokerItemSection(item, itemNo)
        {
            const ctrlLabels = {
                id: Homey.__("settings.id"),
                address: Homey.__("settings.address"),
                port: Homey.__("settings.port"),
                wsPort: Homey.__("settings.wsPort"),
                enabled: Homey.__("settings.enabled"),
            };
            const itemLegend = Homey.__("settings.brokerItemlegend", { itemNo: itemNo + 1 });
            const protected = item.protected ? "disabled" : "";
            const enableOption = item.enabled ? "checked" : "";
            let deleteButton = "";
            if (!item.protected)
            {
                deleteButton = `<p><button class="homey-button-secondary-shadow" id="deleteBrokerItem${itemNo}" onClick="deleteBrokerItem(${itemNo})" style="font-size: 30px;"><i class="fi fi-rr-trash"></i> </button></p>`;
            }

            let brokerDescription = "";
            if (item.brokerid === "homey")
            {
                brokerDescription = Homey.__("settings.brokerHomey");
            }
            else if (item.brokerid === "buttonplus")
            {
                brokerDescription = Homey.__("settings.brokerButtonPlus");
            }
            else
            {
                brokerDescription = Homey.__("settings.brokerUser");
            }

            var section = document.getElementById('brokerItemsSection').innerHTML;
            section = section +
                `<div class="horizontalcontainer">
                    <div class="horizontalgroup">
                        <legend class="homey-subtitle">${itemLegend}</legend>
                        <p>${brokerDescription}</p>

                        <label class="homey-form-label" for="broker${itemNo}Id">${ctrlLabels.id}</label>
                        <input class="homey-form-input" id="broker${itemNo}Id" type="text" value="${item.brokerid}" ${protected} onChange="updateBrokerLists(${itemNo})"/>

                        <label class="homey-form-label" for="broker${itemNo}Address">${ctrlLabels.address}</label>
                        <input class="homey-form-input" id="broker${itemNo}Address" type="text" value="${item.url}" ${protected} />

                        <label class="homey-form-label" for="broker${itemNo}Port">${ctrlLabels.port}</label>
                        <input class="homey-form-input" id="broker${itemNo}Port" type="number" value="${item.port}" />

                        <label class="homey-form-label" for="broker${itemNo}WSPort">${ctrlLabels.wsPort}</label>
                        <input class="homey-form-input" id="broker${itemNo}WSPort" type="number" value="${item.wsport}" />

                        <label class="homey-form-checkbox">
                            <input class="homey-form-checkbox-input" id="broker${itemNo}Enabled" onClick="rebuildBrokerLists(${itemNo})" type="checkbox" ${enableOption}/>
                            <span class="homey-form-checkbox-checkmark"></span>
                            <span class="homey-form-checkbox-text">${ctrlLabels.enabled}</span>
                        </label>

                        ${deleteButton}
                    </div>
                </div>`;

            document.getElementById('brokerItemsSection').innerHTML = section;
        }

        function updateBrokerLists(itemNo)
        {
            // Update the broker in the left and right broker list in the panel config
            const leftBrokerIdElement = document.getElementById('leftBrokerId');
            leftBrokerIdElement.options[itemNo].text = document.getElementById(`broker${itemNo}Id`).value;

            const rightBrokerIdElement = document.getElementById('rightBrokerId');
            rightBrokerIdElement.options[itemNo].text = document.getElementById(`broker${itemNo}Id`).value;

            // Update the broker in the all the custom MQTT topics in the panel config
            for (let k = 0; k < customMQTTItemsElements.length; k++)
            {
                customMQTTItemsElements[k].options[itemNo].text = document.getElementById(`broker${itemNo}Id`).value;
            }

            // Update the broker lists in the display config
            const displayConfig = localDisplayConfigurations[currentDisplayConfigurationNo];
            for (var displayItemNo = 0; displayItemNo < displayConfig.items.length; displayItemNo++)
            {
                const brokerIdElement = document.getElementById(`display${displayItemNo}BrokerId`);
                brokerIdElement.options[itemNo].text = document.getElementById(`broker${itemNo}Id`).value;
            }
        }

        function deleteBrokerItem(itemNo)
        {
            if (localBrokerItems.length > 2 && !localBrokerItems[itemNo].protected)
            {
                localBrokerItems.splice(itemNo, 1);
                drawBrokerItems();

                // Remove the broker from the broker list in the panel and display config
                removeBrokerFromConfig(itemNo);
            }
            else
            {
                Homey.alert(Homey.__("settings.deleteBrokerItemError"));
            }
        }

        function rebuildBrokerLists(itemNo)
        {
            localBrokerItems[itemNo].enabled = document.getElementById(`broker${itemNo}Enabled`).checked;
            
            // Fetch current settings so we can restore them after the rebuild
            localbuttonConfigurations[currentButtonConfigurationNo].leftBrokerId = leftBrokerIdElement.value;
            localbuttonConfigurations[currentButtonConfigurationNo].rightBrokerId = rightBrokerIdElement.value;

            // reset the broker lists in all the config items
            leftBrokerIdElement.length = 0;
            rightBrokerIdElement.length = 0;
            for (let k = 0; k < customMQTTItemsElements.length; k++)
            {
                customMQTTItemsElements[k].length = 0;
            }

            const displayConfig = localDisplayConfigurations[currentDisplayConfigurationNo];
            for (let displayItemNo = 0; displayItemNo < displayConfig.items.length; displayItemNo++)
            {
                const displayItem = displayConfig.items[displayItemNo];
                const brokerIdElement = document.getElementById(`display${displayItemNo}BrokerId`);
                displayItem.brokerId = brokerIdElement.value;

                brokerIdElement.length = 0;
            }

            // Add the brokers to the broker list in the panel and display config
            for (var itemNo = 0; itemNo < localBrokerItems.length; itemNo++)
            {
                // Add the broker to the broker list in the panel and display config
                var brokerItem = localBrokerItems[itemNo];
                if (brokerItem.enabled)
                {
                    addBrokerToConfig(brokerItem);
                }
            }

            // select the broker in the broker list in the panel and display config
            leftBrokerIdElement.value = localbuttonConfigurations[currentButtonConfigurationNo].leftBrokerId;
            rightBrokerIdElement.value = localbuttonConfigurations[currentButtonConfigurationNo].rightBrokerId;

            for (let displayItemNo = 0; displayItemNo < displayConfig.items.length; displayItemNo++)
            {
                const displayItem = displayConfiguration.items[displayItemNo];
                const brokerIdElement = document.getElementById(`display${displayItemNo}BrokerId`);
                brokerIdElement.value = displayItem.brokerId;
            }
        }

        function addBrokerToConfig(brokerItem)
        {
            // Add the new broker to the panel config broker lists
            var optionLeft = document.createElement("option");
            optionLeft.value = brokerItem.brokerid;
            optionLeft.text = brokerItem.brokerid;
            leftBrokerIdElement.add(optionLeft);

            var optionRight = document.createElement("option");
            optionRight.value = brokerItem.brokerid;
            optionRight.text = brokerItem.brokerid;
            rightBrokerIdElement.add(optionRight);

            // Add the new broker to the custom MQTT topic broker lists
            for (let k = 0; k < customMQTTItemsElements.length; k++)
            {
                var option = document.createElement("option");
                option.value = brokerItem.brokerid;
                option.text = brokerItem.brokerid;
                customMQTTItemsElements[k].add(option);
            }

            // Add the new broker to the display config broker lists
            const displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];
            for (let j = 0; j < displayConfiguration.items.length; j++)
            {
                const displayItem = displayConfiguration.items[j];
                var option = document.createElement("option");
                option.value = brokerItem.brokerid;
                option.text = brokerItem.brokerid;
                let brokerIdElement = document.getElementById(`display${j}BrokerId`);
                brokerIdElement.add(option);
            }
        }

        function removeBrokerFromConfig(itemNo)
        {
            // Remove the broker from the left and right broker list in the panel config
            const leftBrokerIdElement = document.getElementById('leftBrokerId');
            leftBrokerIdElement.remove(itemNo);

            const rightBrokerIdElement = document.getElementById('rightBrokerId');
            rightBrokerIdElement.remove(itemNo);

            // Remove the broker from the all the custom MQTT topics in the panel config
            for (let k = 0; k < customMQTTItemsElements.length; k++)
            {
                customMQTTItemsElements[k].remove(itemNo);
            }

            // Remove the broker from all the lists in the display config items
            const displayConfig = localDisplayConfigurations[currentDisplayConfigurationNo];
            for (var displayItemNo = 0; displayItemNo < displayConfig.items.length; displayItemNo++)
            {
                const item = displayConfig.items[displayItemNo];
                const brokerIdElement = document.getElementById(`display${displayItemNo}BrokerId`);
                brokerIdElement.remove(itemNo);
            }
        }

        function storeBrokerSettings()
        {
            for (var itemNo = 0; itemNo < localBrokerItems.length; itemNo++)
            {
                // Make sure there isn't already a broker with this id
                newBrokerid = document.getElementById(`broker${itemNo}Id`).value;

                for (var itemNo2 = 0; itemNo2 < itemNo; itemNo2++)
                {
                    if (newBrokerid.toUpperCase() === localBrokerItems[itemNo2].brokerid.toUpperCase())
                    {
                        Homey.alert(Homey.__("settings.duplicateBrokerIdError", { brokerId: newBrokerid }));
                        return false;
                    }
                }
                localBrokerItems[itemNo].enabled = document.getElementById(`broker${itemNo}Enabled`).checked;
                localBrokerItems[itemNo].brokerid = newBrokerid;
                localBrokerItems[itemNo].url = document.getElementById(`broker${itemNo}Address`).value;
                localBrokerItems[itemNo].port = document.getElementById(`broker${itemNo}Port`).value;
                localBrokerItems[itemNo].wsport = document.getElementById(`broker${itemNo}WSPort`).value;
            }

            return true;
        }

        /// Custom MQTT code
        function drawCustomMQTTTopics(side, buttonPanelConfiguration)
        {
            document.getElementById(`${side}CustomMQTTTopicsSection`).innerHTML = "";
            customMQTTItemsElements = [];

            const customMQTTTopics = buttonPanelConfiguration[`${side}CustomMQTTTopics`];

            for (var itemNo = 0; itemNo < customMQTTTopics.length; itemNo++)
            {
                const item = customMQTTTopics[itemNo];
                insertCustomMQTTTopicSection(item, itemNo, side);
            }

            var tooltips = document.querySelectorAll(".tooltip");
            tooltips.forEach(function(tooltip, index)
            {
                // Set a mouse over function for each tooltop element
                tooltip.addEventListener("mouseover", position_tooltip); // On hover, launch the function below
            })
        }

        function insertCustomMQTTTopicSection(item, itemNo, side)
        {
            const ctrlLabels = {
                brokerId: Homey.__("settings.brokerId"),
                brokerIdExplanation: Homey.__("settings.brokerIdExplanation"),
                id: Homey.__("settings.MQTTId"),
                idExplanation: Homey.__("settings.MQTTIdExplanation"),
                type: Homey.__("settings.type"),
                typeExplanation: Homey.__("settings.typeExplanation"),
                topic: Homey.__("settings.topic"),
                topicExplanation: Homey.__("settings.topicExplanation"),
                payload: Homey.__("settings.payload"),
                payloadExplanation: Homey.__("settings.payloadExplanation"),
                enabled: Homey.__("settings.enabled"),
                click: Homey.__("settings.click"),
                longPress: Homey.__("settings.longPress"),
                led: Homey.__("settings.led"),
            };
            const itemLegend = Homey.__("settings.customMQTTItemlegend", { itemNo: itemNo + 1 });
            const enableOption = item.enabled ? "checked" : "";

            var section = document.getElementById(`${side}CustomMQTTTopicsSection`).innerHTML;
            section = section +
                `<div class="horizontalcontainer">
                    <div class="horizontalgroup">
                        <legend class="homey-subtitle">${itemLegend}</legend>

                        <label class="homey-form-label" for="${side}CustomMQTT${itemNo}Id">${ctrlLabels.id}
                            <div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
                                <span class="tooltiptext">${ctrlLabels.idExplanation}</span>
                            </div>
                        </label>
                        <input class="homey-form-input" id="${side}CustomMQTT${itemNo}Id" type="text" value="${item.id}"/>

                        <label class="homey-form-label" for="${side}CustomMQTT${itemNo}Type">${ctrlLabels.type}
                            <div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
                                <span class="tooltiptext">${ctrlLabels.typeExplanation}</span>
                            </div>
                        </label>
                        <select class="homey-form-select" id="${side}CustomMQTT${itemNo}Type">
                            <option value=0>${ctrlLabels.click}</option>
                            <option value=1>${ctrlLabels.longPress}</option>
                            <option value=14>${ctrlLabels.led}</option>
                        </select><br>

                        <label class="homey-form-label" for="${side}CustomMQTT${itemNo}topic">${ctrlLabels.topic}
                            <div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
                                <span class="tooltiptext">${ctrlLabels.topicExplanation}</span>
                            </div>
                        </label>
                        <input class="homey-form-input" id="${side}CustomMQTT${itemNo}topic" type="text" value="${item.topic}" />

                        <label class="homey-form-label" for="${side}CustomMQTT${itemNo}payload">${ctrlLabels.payload}
                            <div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
                                <span class="tooltiptext">${ctrlLabels.payloadExplanation}</span>
                            </div>
                        </label>
                        <input class="homey-form-input" id="${side}CustomMQTT${itemNo}payload" type="text" value="${item.payload}" />

                        <label class="homey-form-label" for="${side}CustomMQTT${itemNo}BrokerId">${ctrlLabels.brokerId}
                            <div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
                                <span class="tooltiptext">${ctrlLabels.brokerIdExplanation}</span>
                            </div>
                        </label>
                        <select class="homey-form-select" id="${side}CustomMQTT${itemNo}BrokerId">
                        </select><br>

                        <label class="homey-form-checkbox">
                            <input class="homey-form-checkbox-input" id="${side}CustomMQTT${itemNo}Enabled" type="checkbox" ${enableOption}/>
                            <span class="homey-form-checkbox-checkmark"></span>
                            <span class="homey-form-checkbox-text">${ctrlLabels.enabled}</span>
                        </label>

                        <p><button class="homey-button-secondary-shadow" id="${side}DeleteItem${itemNo}" onClick="deleteCustomMQTTItem(${itemNo}, '${side}')" style="font-size: 30px;"><i class="fi fi-rr-trash"></i> </button></p>
                    </div>
                </div>`;

            document.getElementById(`${side}CustomMQTTTopicsSection`).innerHTML = section;
            customMQTTItemsElements.push(document.getElementById(`${side}CustomMQTT${itemNo}BrokerId`));

            // Add the brokers to the broker list
            for (var brokerNo = 0; brokerNo < localBrokerItems.length; brokerNo++)
            {
                const brokerItem = localBrokerItems[brokerNo];
                var option = document.createElement("option");
                option.text = brokerItem.brokerid;
                option.value = brokerItem.brokerid;
                customMQTTItemsElements[itemNo].add(option);
                customMQTTItemsElements[itemNo].value = item.brokerId;
            }
        }

        // Delete the specified custom item from the button panel configuration and redraw the list
        function deleteCustomMQTTItem(itemNo, side)
        {
            var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
            const customMQTTTopics = ButtonPanelConfiguration[`${side}CustomMQTTTopics`];

            customMQTTTopics.splice(itemNo, 1);
            drawCustomMQTTTopics(side, ButtonPanelConfiguration);
        }

        //  Copy the contents of the specified custom item controls to the button panel configuration
        function storeCustomMQTTItem(side, buttonPanelConfiguration, itemNo)
        {
            // Get the custom MQTT topics array
            const customMQTTTopics = buttonPanelConfiguration[`${side}CustomMQTTTopics`];
            
            // Check if customMQTTTopics is defined and length is not 0
            if (!customMQTTTopics || customMQTTTopics.length === 0) return;

            // Fetch the item from the array or create a new one
            let item = customMQTTTopics[itemNo];
            if (!item)
            {
                item = {};
                customMQTTTopics.push(item);
            }

            // Update the item
            item.id = document.getElementById(`${side}CustomMQTT${itemNo}Id`).value;
            item.type = document.getElementById(`${side}CustomMQTT${itemNo}Type`).value;
            item.topic = document.getElementById(`${side}CustomMQTT${itemNo}topic`).value;
            item.payload = document.getElementById(`${side}CustomMQTT${itemNo}payload`).value;
            item.brokerId = document.getElementById(`${side}CustomMQTT${itemNo}BrokerId`).value;
            item.enabled = document.getElementById(`${side}CustomMQTT${itemNo}Enabled`).checked;
        }

        // Copy the contents of the all the custom items controls to the button panel configuration
        function storeCustomMQTTItems(side, buttonPanelConfiguration)
        {
            for (var itemNo = 0; itemNo < customMQTTItemsElements.length; itemNo++)
            {
                storeCustomMQTTItem(side, buttonPanelConfiguration, itemNo);
            }
        }

    </script>
</body>

</html>