<!doctype html>
<html>

<head>
    <!-- The '/homey.js' script must be included in your settings view to work -->
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
    <link rel="stylesheet" type="text/css" href="extraStyles.css">
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css'>
</head>

<body>
    <fieldset class="homey-form-fieldset">
        <legend class="homey-form-legend"><span data-i18n="settings.Settings"></span></legend>
        <label class="homey-form-checkbox">
            <input class="homey-form-checkbox-input" id="autoConfig" type="checkbox" value="auto" />
            <span class="homey-form-checkbox-checkmark"></span>
            <span class="homey-form-checkbox-text"><span data-i18n="settings.autoConfig"></span></span>
        </label>
        <div id="AutoConfigWarnOff"><span data-i18n="settings.autoConfigWarning1"></span></div>
        <div id="AutoConfigWarnOn"><span data-i18n="settings.autoConfigWarning2"></span></div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
        <label class="homey-form-label" for="configType"><span data-i18n="settings.view"></span></label>
        <select class="homey-form-select" id="configType">
            <option value="panelConfig" data-i18n="settings.buttonConfigs"></option>
            <option value="displayConfig" data-i18n="settings.displayConfigs"></option>
            <option value="brokerConfig" data-i18n="settings.brokerConfigs"></option>
        </select>

        <!-- Button Bar Configuration -->

        <div id="panelConfig" class="tabcontent">
            <div class="homey-form-group">
                <div style="padding: 10px 10px 10px 10px; border: 1px solid lightblue; border-radius: 10px">
                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                        <span class="tooltiptext" data-i18n="settings.buttonExplanation"></span>
                    </div>

                    <select class="homey-form-select" id="ButtonPanelConfigurationNo">
                    </select>
                    <div class="horizontalcontainer">
                        <div class="horizontalgroup">
                            <legend class="homey-subtitle"><span data-i18n="settings.leftPanel"></span></legend>

                            <label class="homey-form-label" for="leftDevice"><span data-i18n="settings.device"></span>
                                <div class="tooltip"><i class="fi fi-rr-info"></i>
                                    <span class="tooltiptext" data-i18n="settings.deviceExplanation"></span>
                                </div>
                            </label>
                            <select class="homey-form-select" id="leftDevice">
                                <option value="" selected disabled hidden><span data-i18n="settings.device"></option>
                            </select>

                            <span>
                                <div id="leftCapabilityDiv">
                                    <label class="homey-form-label" id="leftCapabilityLabel" for="leftCapability"><span data-i18n="settings.capability"></span>
                                    </label>
                                    <select class="homey-form-select" id="leftCapability">
                                        <option value="" selected disabled hidden><span data-i18n="settings.selectCapability"></span></option>
                                    </select>
                                </div>
                            </span>

                            <label class="homey-form-label" for="leftTopText"><span data-i18n="settings.topLabel"></span>
                                <div class="tooltip"><i class="fi fi-rr-info"></i>
                                    <span class="tooltiptext" data-i18n="settings.topLabelExplanation"></span>
                                </div>
                            </label>
                            <input class="homey-form-input" id="leftTopText" type="text" maxlength="20" value="" />

                            <span>
                                <div id="leftOnTextDiv">
                                    <label class="homey-form-label" id="leftOnTextLabel" for="leftOnText"><span data-i18n="settings.labelOn"></span>
                                        <div class="tooltip"><i class="fi fi-rr-info"></i>
                                            <span class="tooltiptext" data-i18n="settings.labelOnExplantion"></span>
                                        </div>
                                    </label>
                                    <input class="homey-form-input" id="leftOnText" type="text" maxlength="20" value="" />
                                </div>
                            </span>

                            <span>
                                <div id="leftDimChangeDiv">
                                    <label class="homey-form-label" id="leftDimChangeLabel" for="leftDimChange"><span data-i18n="settings.dimValue"></span>
                                        <div class="tooltip"><i class="fi fi-rr-info"></i>
                                            <span class="tooltiptext" data-i18n="settings.dimChangeExplanation"></span>
                                        </div>
                                    </label>
                                    <input class="homey-form-input" id="leftDimChange" type="text" maxlength="20" value="" />
                                </div>
                            </span>

                            <label class="homey-form-label" id="leftOffTextLabel" for="leftOffText"><span data-i18n="settings.labelOff"></span>
                                <div class="tooltip"><i class="fi fi-rr-info"></i>
                                    <span class="tooltiptext" data-i18n="settings.labelOffExplantion"></span>
                                </div>
                            </label>
                            <input class="homey-form-input" id="leftOffText" type="text" maxlength="20" value="" />

                            <label class="homey-form-label" for="leftBrokerId"><span data-i18n="settings.brokerId"></span>
                                <div class="tooltip"><i class="fi fi-rr-info"></i>
                                    <span class="tooltiptext" data-i18n="settings.brokerIdExplanation"></span>
                                </div>
                            </label>
                            <select class="homey-form-select" id="leftBrokerId">
                            </select>
                        </div>
                        <div class="horizontalgroup">
                            <legend class="homey-subtitle"><span data-i18n="settings.rightPanel"></span></legend>

                            <label class="homey-form-label" for="rightDevice"><span data-i18n="settings.device"></span></label>
                            <select class="homey-form-select" id="rightDevice">
                                <option value="" selected disabled hidden><span data-i18n="settings.selectDevice"></span></option>
                            </select>

                            <span>
                                <div id="rightCapabilityDiv">
                                    <label class="homey-form-label" id="rightCapabilityLabel" for="rightCapability"><span data-i18n="settings.capability"></span></label>
                                    <select class="homey-form-select" id="rightCapability">
                                        <option value="" selected disabled hidden><span data-i18n="settings.selectCapability"></span></option>
                                    </select>
                                </div>
                            </span>

                            <label class="homey-form-label" for="rightTopText"><span data-i18n="settings.topLabel"></span>
                                <div class="tooltip"><i class="fi fi-rr-info"></i>
                                    <span class="tooltiptext" data-i18n="settings.topLabelExplanation"></span>
                                </div>
                            </label>
                            <input class="homey-form-input" id="rightTopText" type="text" maxlength="20" value="" />

                            <span>
                                <div id="rightOnTextDiv">
                                    <label class="homey-form-label" id="rightOnTextLabel" for="rightOnText"><span data-i18n="settings.labelOn"></span>
                                        <div class="tooltip"><i class="fi fi-rr-info"></i>
                                            <span class="tooltiptext" data-i18n="settings.labelOnExplantion"></span>
                                        </div>
                                    </label>
                                    <input class="homey-form-input" id="rightOnText" type="text" maxlength="20" value="" />
                                </div>
                            </span>

                            <span>
                                <div id="rightDimChangeDiv">
                                    <label class="homey-form-label" id="rightDimChangeLabel" for="rightDimChange"><span data-i18n="settings.dimValue"></span>
                                        <div class="tooltip"><i class="fi fi-rr-info"></i>
                                            <span class="tooltiptext" data-i18n="settings.dimChangeExplanation"></span>
                                        </div>
                                    </label>
                                    <input class="homey-form-input" id="rightDimChange" type="text" maxlength="20" value="" />
                                </div>
                            </span>

                            <label class="homey-form-label" id="rightOffTextLabel" for="rightOffText"><span data-i18n="settings.labelOff"></span>
                                <div class="tooltip"><i class="fi fi-rr-info"></i>
                                    <span class="tooltiptext" data-i18n="settings.labelOffExplantion"></span>
                                </div>
                            </label>
                            <input class="homey-form-input" id="rightOffText" type="text" maxlength="20" value="" />

                            <label class="homey-form-label" for="rightBrokerId"><span data-i18n="settings.brokerId"></span>
                                <div class="tooltip"><i class="fi fi-rr-info"></i>
                                    <span class="tooltiptext" data-i18n="settings.brokerIdExplanation"></span>
                                </div>
                            </label>
                            <select class="homey-form-select" id="rightBrokerId">
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Display Configuration -->

        <div id="displayConfig" class="tabcontent">
            <div class="homey-form-group">
                <div style="padding: 10px 10px 10px 10px; border: 1px solid lightblue; border-radius: 10px">
                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                        <span class="tooltiptext" data-i18n="settings.displayExplanation"></span>
                    </div>

                    <select class="homey-form-select" id="displayConfigurationNo">
                    </select>
                </div>
                <div id="displayItemsSection"></div>
            </div>
            <p><button class="homey-button-secondary-shadow" id="newDisplayItem"><span data-i18n="settings.newDisplayItem"></span></button></p>
        </div>

        <!-- Broker Configuration -->

        <div id="brokerConfig" class="tabcontent">
            <div class="homey-form-group">
                <div class="tooltip"><i class="fi fi-rr-info"></i>
                    <span class="tooltiptext" data-i18n="settings.brokerExplanation"></span>
                </div>

                <div id="brokerItemsSection"></div>
            </div>
            <p><button class="homey-button-secondary-shadow" id="newBrokerItem"><span data-i18n="settings.newBrokerItem"></span></button></p>
        </div>

    </fieldset>

    <!-- Save Configuration button -->

    <p><button class="homey-button-primary-full" id="save"><span data-i18n="settings.save"></span></button></p>

    <!-- Code to handle page life -->

    <script type="text/javascript">
        // General declarations
        var devicesArray = [];
        var devicesFetched = false;
        var autoConfigElement = document.getElementById('autoConfig');
        var configTypeElement = document.getElementById('configType');
        var saveButton = document.getElementById('save');

        // Declarations for the Button Bar Config page

        var buttonConfigurationNoElement = document.getElementById('ButtonPanelConfigurationNo');

        var leftTopTextElement = document.getElementById('leftTopText');
        var leftOnTextElement = document.getElementById('leftOnText');
        var leftOffTextElement = document.getElementById('leftOffText');
        var leftDimChangeElement = document.getElementById('leftDimChange');
        var leftDeviceElement = document.getElementById('leftDevice');
        var leftCapabilityElement = document.getElementById('leftCapability');
        var leftBrokerIdElement = document.getElementById('leftBrokerId');

        var rightTopTextElement = document.getElementById('rightTopText');
        var rightOnTextElement = document.getElementById('rightOnText');
        var rightOffTextElement = document.getElementById('rightOffText');
        var rightDimChangeElement = document.getElementById('rightDimChange');
        var rightDeviceElement = document.getElementById('rightDevice');
        var rightCapabilityElement = document.getElementById('rightCapability');
        var rightBrokerIdElement = document.getElementById('rightBrokerId');

        var buttonConfigurationsFetched = false;
        var localbuttonConfigurations = [];
        var currentButtonConfigurationNo = 0;

        // Declarations for the Display Config page

        var displayConfigurationNoElement = document.getElementById('displayConfigurationNo');
        var newDisplayItemButton = document.getElementById('newDisplayItem');

        var displayConfigurationsFetched = false;
        var localDisplayConfigurations = [];
        var currentDisplayConfigurationNo = 0;
        var displayCapabilityItems = [];

        // Declarations for the Broker Config page
        var newBrokerItemButton = document.getElementById('newBrokerItem');
        var localBrokerItems = [];

        var itemDisplyType = "flex";

        // a method named 'onHomeyReady' must be present in your code
        function onHomeyReady(Homey)
        {
            // General code
            itemDisplyType = document.getElementById('leftCapabilityDiv').style.display;

            fillConfigElement(buttonConfigurationNoElement, Homey.__("settings.buttonConfig"));
            fillConfigElement(displayConfigurationNoElement, Homey.__("settings.displayConfig"));

            getDeivices();
            configTypeChanged('panelConfig');

            Homey.get('autoConfig', function(err, autoConfig)
            {
                if (err) return Homey.alert(err);
                autoConfigElement.checked = autoConfig;
                autoConfigChanged();
            });

            Homey.get('brokerConfigurationItems', function(err, brokerItems)
            {
                if (err) return Homey.alert(err);
                localBrokerItems = brokerItems;

                // Setup the list items for enabled brokers in the panel config
                for (let i = 0; i < localBrokerItems.length; i++)
                {
                    const brokerItem = localBrokerItems[i];
                    if (brokerItem.enabled)
                    {
                        var option = document.createElement("option");
                        option.value = brokerItem.brokerid;
                        option.text = brokerItem.brokerid;
                        leftBrokerIdElement.add(option);

                        var option = document.createElement("option");
                        option.value = brokerItem.brokerid;
                        option.text = brokerItem.brokerid;
                        rightBrokerIdElement.add(option);


                        // Add the broker to the display config broker lists
                        for (let i = 0; i < localDisplayConfigurations.length; i++)
                        {
                            const displayConfiguration = localDisplayConfigurations[i];
                            for (let j = 0; j < displayConfiguration.items.length; j++)
                            {
                                const displayItem = displayConfiguration.items[j];
                                var optionLeft = document.createElement("option");
                                optionLeft.value = brokerItem.brokerid;
                                optionLeft.text = brokerItem.brokerid;
                                document.getElementById(`display${j}BrokerId`).add(optionLeft);
                            }
                        }
                    }
                }

                drawBrokerItems();
            });

            autoConfigElement.addEventListener('click', function(e)
            {
                Homey.set('autoConfig', autoConfigElement.checked);
                autoConfigChanged();
            });

            configTypeElement.addEventListener('change', function(e)
            {
                configTypeChanged(configTypeElement.value);
            });

            saveButton.addEventListener('click', function(e)
            {
                if (autoConfigElement.checked)
                {
                    if (storeBrokerSettings())
                    {
                        Homey.set('brokerConfigurationItems', localBrokerItems);
                    }

                    if (leftCapabilityElement.value === 'dim')
                    {
                        const dimVal = parseInt(leftDimChangeElement.value, 10);
                        if (dimVal < -100 || dimVal > 100 || dimVal === 0)
                        {
                            Homey.alert(Homey.__("settings.dimError", { leftRight: Homey.__("settings.leftPanel") }));
                            return;
                        }
                    }

                    if (rightCapabilityElement.value === 'dim')
                    {
                        const dimVal = parseInt(rightDimChangeElement.value, 10);
                        if (dimVal < -100 || dimVal > 100 || dimVal === 0)
                        {
                            // Get the translated string and insert the Right text
                            Homey.alert(Homey.__("settings.dimError", { leftRight: Homey.__("settings.rightPanel") }));
                            return;
                        }
                    }

                    var ButtonPanelConfigurationNo = buttonConfigurationNoElement.value;

                    // Copy the values from the controls to the buttonConfiguration
                    var ButtonPanelConfiguration = {
                        leftTopText: leftTopTextElement.value,
                        leftOnText: leftOnTextElement.value,
                        leftOffText: leftOffTextElement.value,
                        leftDevice: leftDeviceElement.value,
                        leftCapability: leftCapabilityElement.value,
                        leftBrokerId: leftBrokerIdElement.value,
                        leftDimChange: leftDimChangeElement.value,

                        rightTopText: rightTopTextElement.value,
                        rightOnText: rightOnTextElement.value,
                        rightOffText: rightOffTextElement.value,
                        rightDevice: rightDeviceElement.value,
                        rightCapability: rightCapabilityElement.value,
                        rightBrokerId: rightBrokerIdElement.value,
                        rightDimChange: rightDimChangeElement.value,
                    };

                    localbuttonConfigurations[ButtonPanelConfigurationNo] = ButtonPanelConfiguration;
                    Homey.set('buttonConfigurations', localbuttonConfigurations);

                    //Copy the values from the controls to the displayConfiguration
                    storeDisplaySettings();
                    Homey.set('displayConfigurations', localDisplayConfigurations);
                }
                else
                {
                    Homey.alert(Homey.__("settings.saveError1"));
                }
            });

            // Button Bar Config code

            Homey.get('buttonConfigurations', function(err, buttonConfigurations)
            {
                if (err) return Homey.alert(err);
                localbuttonConfigurations = buttonConfigurations;
                buttonConfigurationsFetched = true;
                console.log('buttonConfigurations: ' + JSON.stringify(buttonConfigurations));
                updateButtonPanelConfiguration();
            });

            buttonConfigurationNoElement.addEventListener('change', function(e)
            {
                // Store the current configuration
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];

                ButtonPanelConfiguration.leftTopText = leftTopTextElement.value;
                ButtonPanelConfiguration.leftOnText = leftOnTextElement.value;
                ButtonPanelConfiguration.leftOffText = leftOffTextElement.value;
                ButtonPanelConfiguration.leftDevice = leftDeviceElement.value;
                ButtonPanelConfiguration.leftCapability = leftCapabilityElement.value;
                ButtonPanelConfiguration.leftbrokerId = leftBrokerIdElement.value;
                ButtonPanelConfiguration.leftDimChange = leftDimChangeElement.value;

                ButtonPanelConfiguration.rightTopText = rightTopTextElement.value;
                ButtonPanelConfiguration.rightOnText = rightOnTextElement.value;
                ButtonPanelConfiguration.rightOffText = rightOffTextElement.value;
                ButtonPanelConfiguration.rightDevice = rightDeviceElement.value;
                ButtonPanelConfiguration.rightCapability = rightCapabilityElement.value;
                ButtonPanelConfiguration.rightbrokerId = rightBrokerIdElement.value;
                ButtonPanelConfiguration.rightDimChange = rightDimChangeElement.value;

                // Fetch the new configuration
                updateButtonPanelConfiguration();
            });

            leftTopTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftTopText = leftTextTopElement.value;
            });

            leftOnTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftOnText = leftOnTextElement.value;
            });

            leftOffTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftOffText = leftOffTextElement.value;
            });

            leftDimChangeElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftDimChange = leftDimChangelement.value;
            });

            rightTopTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightTopText = rightTopTextElement.value;
            });

            rightOnTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightOnText = rightOnTextElement.value;
            });

            rightOffTextElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightOffText = rightOffTextElement.value;
            });

            rightDimChangeElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightDimChange = rightDimChangelement.value;
            });

            leftDeviceElement.addEventListener('change', function(e)
            {
                // Get the current button configuration
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];

                // Update the device in the local configuration
                ButtonPanelConfiguration.leftDevice = leftDeviceElement.value;

                // Update the capabilities
                getCapabilities("left", leftDeviceElement.value, ButtonPanelConfiguration.leftCapability);
            });

            rightDeviceElement.addEventListener('change', function(e)
            {
                // Get the current button configuration
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];

                // Update the device in the local configuration
                ButtonPanelConfiguration.rightDevice = rightDeviceElement.value;

                // Update the capabilities
                getCapabilities("right", rightDeviceElement.value, ButtonPanelConfiguration.rightCapability);
            });

            leftCapabilityElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftCapability = leftCapabilityElement.value;

                capabilityChanged("left", leftCapabilityElement.value);
            });

            rightCapabilityElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightCapability = rightCapabilityElement.value;

                capabilityChanged("right", rightCapabilityElement.value);
            });

            leftBrokerIdElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.leftBrokerId = leftBrokerIdElement.value;
            });

            rightBrokerIdElement.addEventListener('change', function(e)
            {
                var ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];
                ButtonPanelConfiguration.rightBrokerId = rightBrokerIdElement.value;
            });

            // Display Config code

            displayConfigurationNoElement.addEventListener('change', function(e)
            {
                // Store the current configuration
                storeDisplaySettings();

                // Fetch the new configuration
                updateDisplayConfiguration();
            });

            newDisplayItemButton.addEventListener('click', function(e)
            {
                if (displayConfigurationsFetched)
                {
                    displayConfigurationNo = displayConfigurationNoElement.value;
                    var displayConfiguration = localDisplayConfigurations[displayConfigurationNo];
                    if (displayConfiguration)
                    {
                        var displayItem = {
                            device: "none",
                            capability: "",
                            label: "",
                            units: "",
                            numberRounding: 0,
                            xPos: 0,
                            yPos: 0,
                            width: 100,
                            fontSize: 1,
                            alignment: 0,
                            brokerId: 'homey',
                        };

                        displayConfiguration.items.push(displayItem);

                        localDisplayConfigurations[displayConfigurationNo] = displayConfiguration;
                        Homey.set('displayConfigurations', localDisplayConfigurations);
                        drawDisplayConfiguration(displayConfiguration);
                    }
                }
            });

            Homey.get('displayConfigurations', function(err, displayConfigurations)
            {
                if (err) return Homey.alert(err);
                localDisplayConfigurations = displayConfigurations;
                displayConfigurationsFetched = (localDisplayConfigurations.length > 0);
                updateDisplayConfiguration();
            });

            newBrokerItemButton.addEventListener('click', function(e)
            {
                // Create a new broker item
                var brokerItem = {
                    brokerid: "Unnamed",
                    url: "",
                    port: 1883,
                    wsPort: 9001,
                    enabled: true,
                    protected: false,
                };

                // Add the new broker to the local broker list
                localBrokerItems.push(brokerItem);

                // Add the new broker to the panel config broker lists
                var optionLeft = document.createElement("option");
                optionLeft.value = brokerItem.brokerid;
                optionLeft.text = brokerItem.brokerid;
                leftBrokerIdElement.add(optionLeft);

                var optionRight = document.createElement("option");
                optionRight.value = brokerItem.brokerid;
                optionRight.text = brokerItem.brokerid;
                rightBrokerIdElement.add(optionRight);

                // Add the new broker to the display config broker lists
                for (let i = 0; i < localDisplayConfigurations.length; i++)
                {
                    const displayConfiguration = localDisplayConfigurations[i];
                    for (let j = 0; j < displayConfiguration.items.length; j++)
                    {
                        const displayItem = displayConfiguration.items[j];
                        var optionLeft = document.createElement("option");
                        optionLeft.value = brokerItem.brokerid;
                        optionLeft.text = brokerItem.brokerid;
                        document.getElementById(`display${j}BrokerId`).add(optionLeft);
                    }
                }

                // Redraw the broker items
                drawBrokerItems();
            });

            var tooltips = document.querySelectorAll(".tooltip");
            tooltips.forEach(function(tooltip, index)
            {
                // Set a mouse over function for each tooltop element
                tooltip.addEventListener("mouseover", position_tooltip); // On hover, launch the function below
            })

            // Tell Homey we're ready to be displayed
            Homey.ready();
        }

        function position_tooltip()
        {
            // Get .tooltiptext sibling
            var tooltip = this.parentNode.querySelector(".tooltiptext");

            // Get tooltip coordinates and size
            var tooltip_rect = tooltip.getBoundingClientRect();

            // Corrections if out of window
            var maxRight = window.innerWidth - 50;
            var tipRight = tooltip_rect.x + tooltip_rect.width;

            if (tipRight > maxRight)
            {
                tipX = maxRight - tipRight;

                // Apply corrected position
                if (tooltip.style.left === "")
                {
                    tooltip.style.left = tipX + 'px';
                }
                else
                {
                    tooltip.style.left -= tipX + 'px';
                }
            }
        }

        function fillConfigElement(element, txt)
        {
            //fill the device lists with devices
            element.innerHTML = "";

            var option = document.createElement("option");
            for (let i = 0; i < 20; i++)
            {
                var option = document.createElement("option");
                option.value = i;
                option.text = `${txt} ${i + 1}`;
                element.add(option);
            }
        }

        function getDeivices()
        {
            Homey.api('POST', '/Devices/', { type: 'boolean', id: ['dim'] }, function(err, devices)
            {
                if (err) return Homey.alert(err);

                devicesArray = Object.values(devices);
                devicesFetched = true;
                fillPanelDevices();
                fillDisplayDevices();
            });
        }

        function fillPanelDevices()
        {
            //fill the device lists with devices
            if (devicesFetched)
            {
                fillDevicesElement(leftDeviceElement);
                fillDevicesElement(rightDeviceElement);
                updateButtonPanelConfiguration();
            };
        }

        function fillDevicesElement(element)
        {
            if (devicesFetched && element)
            {
                //fill the device lists with devices
                element.innerHTML = "";

                var option = document.createElement("option");
                option.text = "none";
                option.value = "none";
                element.add(option);

                for (const device of devicesArray)
                {
                    var option = document.createElement("option");
                    option.text = device.name;
                    option.value = device.id;
                    element.add(option);
                }
            }
        }

        function getCapabilities(side, deviceId, selectedCapability)
        {
            // Clear the list options
            let capabilityElement = document.getElementById(`${side}Capability`);
            capabilityElement.innerHTML = "";

            let capabilityDivElement = document.getElementById(`${side}CapabilityDiv`);

            if (deviceId === "none")
            {
                // Hide the capability element items using the div
                capabilityDivElement.style.display = "none";

                // We don't want to show Dim Change value
                document.getElementById(`${side}DimChangeDiv`).style.display = "none";
                return;
            }

            // Request the capabilities for the selected device
            Homey.api('POST', '/device_capabilities/', { deviceId }, function(err, capabilities)
            {
                if (err) return Homey.alert(err);

                if (capabilities)
                {
                    // Add each of the capabilities to the item drop list
                    const capabilitiesArray = Object.values(capabilities);
                    for (const capability of capabilitiesArray)
                    {
                        if (capability.type === "boolean" || capability.id === "dim")
                        {
                            var option = document.createElement("option");
                            option.text = `${capability.title} (${capability.id}})`;
                            option.value = capability.id;
                            capabilityElement.add(option);
                        }
                    }

                    // Show the capability section
                    capabilityDivElement.style.display = itemDisplyType;

                    // Restore the previous capability selection
                    capabilityElement.value = selectedCapability;
                    capabilityChanged(side, selectedCapability);
                }
            });
        }

        function capabilityChanged(side, value)
        {
            if (value === "dim")
            {
                // For dim type capabilities we want to show the dim change value
                document.getElementById(`${side}DimChangeDiv`).style.display = itemDisplyType;

                // And we don't want to show the On or Off text
                document.getElementById(`${side}OnTextDiv`).style.display = "none";
                document.getElementById(`${side}OffText`).style.display = "none";
                document.getElementById(`${side}OffTextLabel`).style.display = "none";
            }
            else
            {
                // For Boolean types we don't want to show Dim Change value
                document.getElementById(`${side}DimChangeDiv`).style.display = "none";

                // And we want to show the On and Off text
                document.getElementById(`${side}OnTextDiv`).style.display = itemDisplyType;
                document.getElementById(`${side}OffText`).style.display = itemDisplyType;
                document.getElementById(`${side}OffTextLabel`).style.display = itemDisplyType;
            }
        }

        function updateButtonPanelConfiguration()
        {
            if ((buttonConfigurationsFetched == false) || (devicesFetched == false)) return;

            if (currentButtonConfigurationNo < 0 || currentButtonConfigurationNo >= localbuttonConfigurations.length)
            {
                currentButtonConfigurationNo = 0;
                buttonConfigurationNoElement.value = currentButtonConfigurationNo;
            }

            if (buttonConfigurationNoElement.value == "")
            {
                leftTopTextElement.value = "";
                leftOnTextElement.value = "";
                leftOffTextElement.value = "";
                leftDeviceElement.value = "";
                leftCapabilityElement.value = "";
                leftBrokerIdElement.value = "homey";
                leftDimChangeElement.value = "+10";

                rightTopTextElement.value = "";
                rightOnTextElement.value = "";
                rightOffTextElement.value = "";
                rightDeviceElement.value = "";
                rightCapabilityElement.value = "";
                rightBrokerIdElement.value = "homey";
                rightDimChangeElement.value = "-10";
            }
            else
            {
                currentButtonConfigurationNo = buttonConfigurationNoElement.value;
                let ButtonPanelConfiguration = localbuttonConfigurations[currentButtonConfigurationNo];

                leftTopTextElement.value = ButtonPanelConfiguration.leftTopText;
                leftOnTextElement.value = ButtonPanelConfiguration.leftOnText;
                leftOffTextElement.value = ButtonPanelConfiguration.leftOffText;
                leftDeviceElement.value = ButtonPanelConfiguration.leftDevice;
                getCapabilities("left", leftDeviceElement.value, ButtonPanelConfiguration.leftCapability);
                leftBrokerIdElement.value = ButtonPanelConfiguration.leftBrokerId;
                leftDimChangeElement.value = ButtonPanelConfiguration.leftDimChange;

                rightTopTextElement.value = ButtonPanelConfiguration.rightTopText;
                rightOnTextElement.value = ButtonPanelConfiguration.rightOnText;
                rightOffTextElement.value = ButtonPanelConfiguration.rightOffText;
                rightDeviceElement.value = ButtonPanelConfiguration.rightDevice;
                rightCapabilityElement.value = ButtonPanelConfiguration.rightCapability;
                getCapabilities("right", rightDeviceElement.value, ButtonPanelConfiguration.rightCapability);
                rightBrokerIdElement.value = ButtonPanelConfiguration.rightBrokerId;
                rightDimChangeElement.value = ButtonPanelConfiguration.rightDimChange;
            }
        }

        function autoConfigChanged()
        {
            if (!autoConfigElement.checked)
            {
                configTypeChanged("");
                document.getElementById('AutoConfigWarnOff').style.display = "block";
                document.getElementById('AutoConfigWarnOn').style.display = "none";
                saveButton.style.display = "none";
                configTypeElement.style.display = "none";
            }
            else
            {
                configTypeChanged(configTypeElement.value);
                document.getElementById('AutoConfigWarnOff').style.display = "none";
                document.getElementById('AutoConfigWarnOn').style.display = "block";
                saveButton.style.display = "block";
                configTypeElement.style.display = "block";
            }
        }

        function configTypeChanged(configSelected)
        {
            var i, tabcontent, tablinks;

            // Get all elements with class="tabcontent" and hide them
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++)
            {
                tabcontent[i].style.display = "none";
            }
            if (configSelected !== "")
            {
                document.getElementById(configSelected).style.display = "block";
            }
        }

        // Code for Displaypanel configuration

        function updateDisplayConfiguration()
        {
            if (displayConfigurationsFetched)
            {
                currentDisplayConfigurationNo = displayConfigurationNoElement.value;

                var displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];

                if (displayConfiguration == null)
                {
                    displayConfiguration = {};
                    displayConfiguration.items = [];
                }

                displayCapabilityItems = [];

                drawDisplayConfiguration(displayConfiguration);
            }
        }

        function drawDisplayConfiguration(displayConfiguration)
        {
            document.getElementById('displayItemsSection').innerHTML = "";
            for (var itemNo = 0; itemNo < displayConfiguration.items.length; itemNo++)
            {
                const item = displayConfiguration.items[itemNo];
                const capabilities = {}
                displayCapabilityItems.push(capabilities);
                insertDisplayItemSection(item, itemNo);
            }

            fillDisplayDevices();
        }

        function insertDisplayItemSection(item, itemNo)
        {
            var section = document.getElementById('displayItemsSection').innerHTML;
            const ctrlLabels = {
                device: Homey.__("settings.device"),
                capability: Homey.__("settings.capability"),
                label: Homey.__("settings.label"),
                units: Homey.__("settings.units"),
                xPos: Homey.__("settings.xPos"),
                yPos: Homey.__("settings.yPos"),
                width: Homey.__("settings.width"),
                rounding: Homey.__("settings.rounding"),
                fontSize: Homey.__("settings.fontSize"),
                alignment: Homey.__("settings.alignment"),
                topLeft: Homey.__("settings.topLeft"),
                topCenter: Homey.__("settings.topCenter"),
                topRight: Homey.__("settings.topRight"),
                centerLeft: Homey.__("settings.centerLeft"),
                centerCenter: Homey.__("settings.centerCenter"),
                centerRight: Homey.__("settings.centerRight"),
                bottomLeft: Homey.__("settings.bottomLeft"),
                bottomCenter: Homey.__("settings.bottomCenter"),
                bottomRight: Homey.__("settings.bottomRight"),
                deleteDisplayItem: Homey.__("settings.deleteDisplayItem"),
                brokerId: Homey.__("settings.brokerId"),
            }
            const itemLegend = Homey.__("settings.displayItemlegend", { itemNo: itemNo + 1 });

            section = section +
                `<div class="horizontalcontainer">
                    <div class="horizontalgroup">
                        <legend class="homey-subtitle">${itemLegend}</legend>

                        <label class="homey-form-label" for="display${itemNo}Device">${ctrlLabels.device}</label>
                        <select class="homey-form-select" id="display${itemNo}Device" onChange="getDisplayCapabilities(${itemNo})">
                        </select>

                        <label class="homey-form-label" for="display${itemNo}Capability">${ctrlLabels.capability}</label>
                        <select class="homey-form-select" id="display${itemNo}Capability" onChange="selectDisplayCapabilities(${itemNo})">
                        </select>

                        <label class="homey-form-label" for="display${itemNo}Label">${ctrlLabels.label}</label>
                        <input class="homey-form-input" id="display${itemNo}Label" type="text" value="${item.label}" />

                        <label class="homey-form-label" for="display${itemNo}Units">${ctrlLabels.units}</label>
                        <input class="homey-form-input" id="display${itemNo}Units" type="text" value="${item.units}" />

                        <label class="homey-form-label" for="display${itemNo}X">${ctrlLabels.xPos}</label>
                        <input class="homey-form-input" id="display${itemNo}X" type="number" value="${item.xPos}" />

                        <label class="homey-form-label" for="display${itemNo}Y">${ctrlLabels.yPos}</label>
                        <input class="homey-form-input" id="display${itemNo}Y" type="number" value="${item.yPos}" />

                        <label class="homey-form-label" for="display${itemNo}Width">${ctrlLabels.width}</label>
                        <input class="homey-form-input" id="display${itemNo}Width" type="number" value="${item.width}" />

                        <label class="homey-form-label" for="display${itemNo}Rounding">${ctrlLabels.rounding}</label>
                        <input class="homey-form-input" id="display${itemNo}Rounding" type="number" value="${item.rounding}" />

                        <label class="homey-form-label" for="display${itemNo}FontSize">${ctrlLabels.fontSize}</label>
                        <select class="homey-form-select" id="display${itemNo}FontSize">
                            <option value=1>1</option>
                            <option value=2>2</option>
                            <option value=3>3</option>
                            <option value=4>4</option>
                        </select>

                        <label class="homey-form-label" for="display${itemNo}Alignment">${ctrlLabels.alignment}</label>
                        <select class="homey-form-select" id="display${itemNo}Alignment">
                            <option value=0>${ctrlLabels.topLeft}</option>
                            <option value=1>${ctrlLabels.topCenter}</option>
                            <option value=2>${ctrlLabels.topRight}</option>
                            <option value=3>${ctrlLabels.centerLeft}</option>
                            <option value=4>${ctrlLabels.center}</option>
                            <option value=5>${ctrlLabels.centerRight}</option>
                            <option value=6>${ctrlLabels.bottomLeft}</option>
                            <option value=7>${ctrlLabels.bottomCenter}</option>
                            <option value=8>${ctrlLabels.bottomRight}</option>
                        </select><br>

                        <label class="homey-form-label" for="display${itemNo}BrokerId">${ctrlLabels.brokerId}</label>
                            <select class="homey-form-select" id="display${itemNo}BrokerId">
                                <option value='homey'>Homey</option>
                                <option value='buttonplus'>Button+</option>
                            </select>
                            <br>
                        <p><button class="homey-button-secondary-shadow" id="deleteDisplayItem" onClick="deleteItem(${itemNo})" style="font-size: 30px;"><i class="fi fi-rr-trash"></i> </button></p>
                    </div>
                </div>`;

            document.getElementById('displayItemsSection').innerHTML = section;

            document.getElementById(`display${itemNo}FontSize`).value = item.fontSize;
            document.getElementById(`display${itemNo}Alignment`).value = item.alignment;
            document.getElementById(`display${itemNo}BrokerId`).value = item.brokerId;
        }

        function fillDisplayDevices()
        {
            // Get the current display configuration
            var displayConfig = localDisplayConfigurations[displayConfigurationNoElement.value];

            if (displayConfig)
            {
                for (var itemNo = 0; itemNo < displayConfig.items.length; itemNo++)
                {
                    fillDevicesElement(document.getElementById(`display${itemNo}Device`));
                    document.getElementById(`display${itemNo}Device`).value = displayConfig.items[itemNo].device;
                    getDisplayCapabilities(itemNo);
                }
            }
        }

        function getDisplayCapabilities(item)
        {
            var deviceId = document.getElementById(`display${item}Device`).value;
            var capabilitiesElement = document.getElementById(`display${item}Capability`);
            capabilitiesElement.innerHTML = "";
            if ((deviceId != "") && (deviceId != 'none'))
            {
                Homey.api('POST', '/device_capabilities/', { deviceId }, function(err, capabilities)
                {
                    if (err) return Homey.alert(err);

                    if (capabilities)
                    {
                        displayCapabilityItems[item].capabilities = capabilities;
                        const capabilitiesArray = Object.values(capabilities);
                        for (const capability of capabilitiesArray)
                        {
                            var option = document.createElement("option");
                            option.text = `${capability.title} (${capability.id}})`;
                            option.value = capability.id;
                            capabilitiesElement.add(option);
                        }
                        capabilitiesElement.style.display = itemDisplyType;

                        var displayConfig = localDisplayConfigurations[displayConfigurationNoElement.value];
                        if (displayConfig)
                        {
                            const capabilityID = displayConfig.items[item].capability;
                            if (capabilities[capabilityID])
                            {
                                capabilitiesElement.value = capabilityID;
                                document.getElementById(`display${item}Label`).value = capabilities[capabilityID].title;
                                document.getElementById(`display${item}Units`).value = capabilities[capabilityID].units ? capabilities[capabilityID].units : "";
                            }
                            else
                            {
                                capabilitiesElement.value = "";
                            }
                        }
                    }
                });
            }
        }

        function selectDisplayCapabilities(item)
        {
            const capabilities = displayCapabilityItems[item].capabilities
            var capabilityID = document.getElementById(`display${item}Capability`).value;
            if (capabilityID != "" && capabilities[capabilityID])
            {
                document.getElementById(`display${item}Label`).value = capabilities[capabilityID].title
                document.getElementById(`display${item}Units`).value = capabilities[capabilityID].units ? capabilities[capabilityID].units : "";
            }
        }

        function deleteItem(itemNo)
        {
            // Save all the settings so they don't get lost when the controls are redawn
            storeDisplaySettings();

            var displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];

            if (displayConfiguration != null)
            {
                displayConfiguration.items.splice(itemNo, 1);
                drawDisplayConfiguration(displayConfiguration);
            }
        }

        function storeDisplaySettings()
        {
            var displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];

            if (displayConfiguration != null)
            {
                for (var itemNo = 0; itemNo < displayConfiguration.items.length; itemNo++)
                {
                    displayConfiguration.items[itemNo].device = document.getElementById(`display${itemNo}Device`).value;
                    displayConfiguration.items[itemNo].capability = document.getElementById(`display${itemNo}Capability`).value;
                    displayConfiguration.items[itemNo].label = document.getElementById(`display${itemNo}Label`).value;
                    displayConfiguration.items[itemNo].units = document.getElementById(`display${itemNo}Units`).value;
                    displayConfiguration.items[itemNo].xPos = document.getElementById(`display${itemNo}X`).value;
                    displayConfiguration.items[itemNo].yPos = document.getElementById(`display${itemNo}Y`).value;
                    displayConfiguration.items[itemNo].width = document.getElementById(`display${itemNo}Width`).value;
                    displayConfiguration.items[itemNo].rounding = document.getElementById(`display${itemNo}Rounding`).value;
                    displayConfiguration.items[itemNo].fontSize = document.getElementById(`display${itemNo}FontSize`).value;
                    displayConfiguration.items[itemNo].alignment = document.getElementById(`display${itemNo}Alignment`).value;
                    displayConfiguration.items[itemNo].brokerId = document.getElementById(`display${itemNo}BrokerId`).value;
                }
            }
        }

        function drawBrokerItems()
        {
            document.getElementById('brokerItemsSection').innerHTML = "";
            for (var itemNo = 0; itemNo < localBrokerItems.length; itemNo++)
            {
                const item = localBrokerItems[itemNo];
                insertBrokerItemSection(item, itemNo);
            }
        }

        function insertBrokerItemSection(item, itemNo)
        {
            const ctrlLabels = {
                id: Homey.__("settings.id"),
                address: Homey.__("settings.address"),
                port: Homey.__("settings.port"),
                wsPort: Homey.__("settings.wsPort"),
                enabled: Homey.__("settings.enabled"),
            };
            const itemLegend = Homey.__("settings.brokerItemlegend", { itemNo: itemNo + 1 });
            const protected = item.protected ? "disabled" : "";
            const enableOption = item.enabled ? "checked" : "";
            let deleteButton = "";
            if (!item.protected)
            {
                deleteButton = `<p><button class="homey-button-secondary-shadow" id="deleteBrokerItem${itemNo}" onClick="deleteBrokerItem(${itemNo})" style="font-size: 30px;"><i class="fi fi-rr-trash"></i> </button></p>`;
            }

            let brokerDescription = "";
            if (item.brokerid === "homey")
            {
                brokerDescription = Homey.__("settings.brokerHomey");
            }
            else if (item.brokerid === "buttonplus")
            {
                brokerDescription = Homey.__("settings.brokerButtonPlus");
            }
            else
            {
                brokerDescription = Homey.__("settings.brokerUser");
            }

            var section = document.getElementById('brokerItemsSection').innerHTML;
            section = section +
                `<div class="horizontalcontainer">
                    <div class="horizontalgroup">
                        <legend class="homey-subtitle">${itemLegend}</legend>
                        <p>${brokerDescription}</p>

                        <label class="homey-form-label" for="broker${itemNo}Id">${ctrlLabels.id}</label>
                        <input class="homey-form-input" id="broker${itemNo}Id" type="text" value="${item.brokerid}" ${protected} onChange="updateBrokerLists(${itemNo})"/>

                        <label class="homey-form-label" for="broker${itemNo}Address">${ctrlLabels.address}</label>
                        <input class="homey-form-input" id="broker${itemNo}Address" type="text" value="${item.url}" ${protected} />

                        <label class="homey-form-label" for="broker${itemNo}Port">${ctrlLabels.port}</label>
                        <input class="homey-form-input" id="broker${itemNo}Port" type="number" value="${item.port}" />

                        <label class="homey-form-label" for="broker${itemNo}WSPort">${ctrlLabels.wsPort}</label>
                        <input class="homey-form-input" id="broker${itemNo}WSPort" type="number" value="${item.wsport}" />

                        <label class="homey-form-checkbox">
                            <input class="homey-form-checkbox-input" id="broker${itemNo}Enabled" onClick="removeBrokerFromConfig(${itemNo})" type="checkbox" ${enableOption}/>
                            <span class="homey-form-checkbox-checkmark"></span>
                            <span class="homey-form-checkbox-text">${ctrlLabels.enabled}</span>
                        </label>

                        ${deleteButton}
                    </div>
                </div>`;

            document.getElementById('brokerItemsSection').innerHTML = section;
        }

        function updateBrokerLists(itmeNo)
        {
            // Update the broker in the left and right broker list in the panel config
            const leftBrokerIdElement = document.getElementById('leftBrokerId');
            leftBrokerIdElement.options[itmeNo].text = document.getElementById(`broker${itmeNo}Id`).value;
            const rightBrokerIdElement = document.getElementById('rightBrokerId');
            rightBrokerIdElement.options[itmeNo].text = document.getElementById(`broker${itmeNo}Id`).value;

            // Update the broker lists in the display config items
            for (var displayItemNo = 0; displayItemNo < localDisplayConfigurations.length; displayItemNo++)
            {
                const displayItem = localDisplayConfigurations[displayItemNo];
                for (var itemNo = 0; itemNo < displayItem.items.length; itemNo++)
                {
                    const item = displayItem.items[itemNo];
                    const brokerIdElement = document.getElementById(`display${itemNo}BrokerId`);
                    brokerIdElement.options[itmeNo].text = document.getElementById(`broker${itmeNo}Id`).value;
                }
            }
        }

        function deleteBrokerItem(itemNo)
        {
            if (localBrokerItems.length > 2 && !localBrokerItems[itemNo].protected)
            {
                localBrokerItems.splice(itemNo, 1);
                drawBrokerItems();

                // Remove the broker from the broker list in the panel and display config
                removeBrokerFromConfig(itemNo);
            }
            else
            {
                Homey.alert(Homey.__("settings.deleteBrokerItemError"));
            }
        }

        function removeBrokerFromConfig(itemNo)
        {
            // Remove the broker from the left and right broker list in the panel config
            const leftBrokerIdElement = document.getElementById('leftBrokerId');
            leftBrokerIdElement.remove(itemNo);

            const rightBrokerIdElement = document.getElementById('rightBrokerId');
            rightBrokerIdElement.remove(itemNo);

            // Remove the broker from the broker all the lists in the display config items
            for (var displayItemNo = 0; displayItemNo < localDisplayConfigurations.length; displayItemNo++)
            {
                const displayItem = localDisplayConfigurations[displayItemNo];
                for (var itemNo = 0; itemNo < displayItem.items.length; itemNo++)
                {
                    const item = displayItem.items[itemNo];
                    const brokerIdElement = document.getElementById(`display${itemNo}BrokerId`);
                    brokerIdElement.remove(itemNo);
                }
            }
        }

        function storeBrokerSettings()
        {
            for (var itemNo = 0; itemNo < localBrokerItems.length; itemNo++)
            {
                // Make sure there isn't already a broker with this id
                newBrokerid = document.getElementById(`broker${itemNo}Id`).value;

                for (var itemNo2 = 0; itemNo2 < itemNo; itemNo2++)
                {
                    if (newBrokerid.toUpperCase() === localBrokerItems[itemNo2].brokerid.toUpperCase())
                    {
                        Homey.alert(Homey.__("settings.duplicateBrokerIdError", { brokerId: newBrokerid }));
                        return false;
                    }
                }
                localBrokerItems[itemNo].enabled = document.getElementById(`broker${itemNo}Enabled`).checked;
                localBrokerItems[itemNo].brokerid = newBrokerid;
                localBrokerItems[itemNo].url = document.getElementById(`broker${itemNo}Address`).value;
                localBrokerItems[itemNo].port = document.getElementById(`broker${itemNo}Port`).value;
                localBrokerItems[itemNo].wsport = document.getElementById(`broker${itemNo}WSPort`).value;
            }

            return true;
        }
    </script>
</body>

</html>