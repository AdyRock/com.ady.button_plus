<!doctype html>
<html>

<head>
	<!-- The '/homey.js' script must be included in your settings view to work -->
	<script type="text/javascript" src="/homey.js" data-origin="settings"></script>
	<link rel="stylesheet" type="text/css" href="extraStyles.css">
	<link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css'>
</head>

<body>
	<div class="fixedTop">
		<label class="homey-form-label" for="configType" style="margin-top:0px"><span
				data-i18n="settings.view"></span></label>
		<select class="homey-form-select" id="configType">
			<option value="settings" data-i18n="settings.Settings"></option>
			<option value="panelConfig" data-i18n="settings.buttonConfigs"></option>
			<option value="displayConfig" data-i18n="settings.displayConfigs"></option>
			<option value="brokerConfig" data-i18n="settings.brokerConfigs"></option>
			<option value="diagnosticLog" data-i18n="settings.diagnosticsLog"></option>
			<option value="importExport" data-i18n="settings.importExport"></option>
		</select>
		<hr style="margin-top:8px;margin-bottom:0px;background-color:lightblue">
	</div>

	<div class="main">
		<!-- Settings page -->

		<div id="settings" class="tabcontent">
			<fieldset class="homey-form-fieldset">
				<label class="homey-form-checkbox">
					<input class="homey-form-checkbox-input" id="autoConfig" type="checkbox" value="auto" />
					<span class="homey-form-checkbox-checkmark"></span>
					<span class="homey-form-checkbox-text"><span data-i18n="settings.autoConfig"></span></span>
				</label>
				<div id="AutoConfigWarnOff"><span data-i18n="settings.autoConfigWarning1"></span></div>
				<div id="AutoConfigWarnOn"><span data-i18n="settings.autoConfigWarning2"></span></div>
			</fieldset>
			<fieldset class="homey-form-fieldset">
				<legend class="homey-form-legend"><span data-i18n="settings.webview"></span></legend>
				<p></p>
				<label class="homey-form-label" for="webviewip" style="margin-top:0px"><span
						data-i18n="settings.webviewip"></span>
					<div class="tooltip"><i class="fi fi-rr-info"></i>
						<span class="tooltiptext" data-i18n="settings.webviewExplanation"></span>
					</div>
				</label>
				<select class="homey-form-select" id="webviewip">
				</select>
				<p></p>
				<p><button class="homey-button-secondary-shadow" id="openwebview"><span
							data-i18n="settings.openwebview"></span></button></p>
			</fieldset>
		</div>

		<!-- Diagnostics Log -->
		<div id="diagnosticLog" class="tabcontent">
			<fieldset class="homey-form-fieldset">
				<label class="homey-form-checkbox">
					<input class="homey-form-checkbox-input" id="enableLog" type="checkbox" value="auto" />
					<span class="homey-form-checkbox-checkmark"></span>
					<span class="homey-form-checkbox-text"><span data-i18n="settings.enableLog"></span></span>
					<div class="tooltip"><i class="fi fi-rr-info"></i>
						<span class="tooltiptext" data-i18n="settings.enableLLogExplanation"></span>
					</div>
				</label>
				<div class="field row">
					<label class="homey-form-label" for="email"><span data-i18n="settings.email"></span>
						<div class="tooltip"><i class="fi fi-rr-info"></i>
							<span class="tooltiptext" data-i18n="settings.emailExplanation"></span>
						</div>
					</label>
					<input class="homey-form-input" id="email" type="text" value />
					<label class="homey-form-label" for="description"><span data-i18n="settings.description"></span>
						<div class="tooltip"><i class="fi fi-rr-info"></i>
							<span class="tooltiptext" data-i18n="settings.descriptionExplanation"></span>
						</div>
					</label>
					<input class="homey-form-input" id="description" type="text" value />
					<p></p>
				</div>
				<p><button class="homey-button-secondary-shadow" id="clearLog"><span
							data-i18n="settings.clearLog"></span></button>
					<button class="homey-button-secondary-shadow" id="sendLog"><span
							data-i18n="settings.sendLog"></span></button>
					<button class="homey-button-secondary-shadow" id="getListeners"><span
							data-i18n="settings.getListeners"></span></button>
				</p>
				<div class="field row">
					<textarea id="diagLog" class="homey-form-textarea"></textarea>
				</div>
			</fieldset>
		</div>

		<!-- Button Bar Configuration -->

		<div id="panelConfig" class="tabcontent">
			<div class="homey-form-group">
				<div style="padding: 10px 10px 10px 10px; border: 1px solid lightblue; border-radius: 10px">
					<label class="homey-form-label" for="ButtonPanelConfigurationNo"><span
							data-i18n="settings.configtoedit"></span>
						<div class="tooltip"><i class="fi fi-rr-info"></i>
							<span class="tooltiptext" data-i18n="settings.buttonExplanation"></span>
						</div>
					</label>
					<select class="homey-form-select" id="ButtonPanelConfigurationNo">
					</select>

					<label class="homey-form-label" for="configName"><span data-i18n="settings.configName"></span>
						<div class="tooltip"><i class="fi fi-rr-info"></i>
							<span class="tooltiptext" data-i18n="settings.configNameExplanation"></span>
						</div>
					</label>
					<input class="homey-form-input" id="configName" type="text" maxlength="20" value />

					<div id="buttonItemsSection"></div>

					<p>
						<button class="homey-button-secondary-shadow" id="addButtonPage"><span
								data-i18n="settings.addPage"></span></button>
					</p>
					<p>
						<button class="homey-button-secondary-shadow" id="copyButtonConfig"><span
								data-i18n="settings.copy"></span></button>
						<button class="homey-button-secondary-shadow" id="pasteButtonConfig"><span
								data-i18n="settings.paste"></span></button>
					</p>
				</div>
			</div>
		</div>

		<!-- Display Configuration -->

		<div id="displayConfig" class="tabcontent">
			<div class="homey-form-group">
				<div style="padding: 10px 10px 10px 10px; border: 1px solid lightblue; border-radius: 10px">
					<div style="padding: 10px 10px 10px 10px; border: 1px solid lightblue; border-radius: 10px">
						<label class="homey-form-label" for="displayConfigurationNo"><span
								data-i18n="settings.configtoedit"></span>
							<div class="tooltip"><i class="fi fi-rr-info"></i>
								<span class="tooltiptext" data-i18n="settings.displayExplanation"></span>
							</div>
						</label>
						<select class="homey-form-select" id="displayConfigurationNo">
						</select>

						<label class="homey-form-label" for="displayConfigName"><span
								data-i18n="settings.configName"></span>
							<div class="tooltip"><i class="fi fi-rr-info"></i>
								<span class="tooltiptext" data-i18n="settings.configNameExplanation"></span>
							</div>
						</label>
						<input class="homey-form-input" id="displayConfigName" type="text" maxlength="20" value />
					</div>
					<div id="displayItemsSection"></div>
					<p><button class="homey-button-secondary-shadow" id="newDisplayItem"><span
								data-i18n="settings.newDisplayItem"></span></button></p>
					<p>
						<button class="homey-button-secondary-shadow" id="copyDisplayConfig"><span
								data-i18n="settings.copy"></span></button>
						<button class="homey-button-secondary-shadow" id="pasteDisplayConfig"><span
								data-i18n="settings.paste"></span></button>
					</p>
				</div>
			</div>
		</div>

		<!-- Broker Configuration -->

		<div id="brokerConfig" class="tabcontent">
			<div class="homey-form-group">
				<div style="padding: 10px 10px 10px 10px; border: 1px solid lightblue; border-radius: 10px">
					<div style="padding: 10px 10px 10px 10px; border: 1px solid lightblue; border-radius: 10px">
						<label class="homey-form-label" for="defaultBroker"><span
								data-i18n="settings.defaultBroker"></span>
							<div class="tooltip"><i class="fi fi-rr-info"></i>
								<span class="tooltiptext" data-i18n="settings.brokerExplanation"></span>
							</div>
						</label>
						<select class="homey-form-select" id="defaultBroker">
						</select>
					</div>
					<div id="brokerItemsSection"></div>
					<p><button class="homey-button-secondary-shadow" id="newBrokerItem"><span
								data-i18n="settings.newBrokerItem"></span></button></p>
				</div>
			</div>
		</div>
	</div>

	<!-- Import / Export page -->

	<div id="importExport" class="tabcontent">
		<div class="homey-form-group">
			<div style="padding: 10px 10px 10px 10px; border: 1px solid lightblue; border-radius: 10px">
				<div class="field row">
					<label class="homey-form-label" for="copyText"><span data-i18n="settings.importExport"></span>
						<div class="tooltip"><i class="fi fi-rr-info"></i>
							<span class="tooltiptext" data-i18n="settings.importExportExplanation"></span>
						</div>
					</label>
					<textarea id="copyText" class="homey-form-textarea"></textarea>
					<p></p>
				</div>
				<div class="field row">
					<button class="homey-button-secondary-shadow" id="import"><span
							data-i18n="settings.import"></span></button>
					<button class="homey-button-secondary-shadow" id="export"><span
							data-i18n="settings.export"></span></button>
				</div>
			</div>
		</div>
	</div>

	<!-- Save Configuration button -->

	<div id="saveBlock" class="bottomFixButtonComponent">
		<button class="homey-button-primary-full" id="save"><span data-i18n="settings.save"></span></button>
	</div>

	<!-- Code to handle page life -->

	<script type="text/javascript">
		// General declarations
		const MAX_BUTTON_CONFIGURATIONS = 40;
		const MAX_DISPLAY_CONFIGURATIONS = 20;
		var buttonDevicesArray = [];
		var buttonDevicesFetched = false;
		var variablesArray = [];
		var variablesFetched = false;
		var displayDevicesArray = [];
		var displayDevicesFetched = false;
		var autoConfigElement = document.getElementById('autoConfig');
		var configTypeElement = document.getElementById('configType');
		var saveButton = document.getElementById('save');
		var saveBlock = document.getElementById('saveBlock');

		// Declarations for the Button Bar Config page

		var buttonConfigurationNoElement = document.getElementById('ButtonPanelConfigurationNo');
		var configNameElement = document.getElementById('configName');

		var addButtonPageElement = document.getElementById('addButtonPage');
		var copyButtonConfigElement = document.getElementById('copyButtonConfig');
		var pasteButtonConfigElement = document.getElementById('pasteButtonConfig');

		var buttonConfigurationsFetched = false;
		var localButtonConfigurations = [];
		var currentButtonConfigurationNo = 0;
		var customMQTTItemsElements = [];
		var customDisplayMQTTItemsElements = [];

		var openWebViewElement = document.getElementById('openwebview');
		var webViewIpElement = document.getElementById('webviewip');

		// Declarations for the Display Config page

		var displayConfigurationNoElement = document.getElementById('displayConfigurationNo');
		var displayConfigNameElement = document.getElementById('displayConfigName');
		var newDisplayItemButton = document.getElementById('newDisplayItem');

		var displayConfigurationsFetched = false;
		var localDisplayConfigurations = [];
		var currentDisplayConfigurationNo = 0;
		var displayCapabilityItems = new Map();
		var copyDisplayConfigElement = document.getElementById('copyDisplayConfig');
		var pasteDisplayConfigElement = document.getElementById('pasteDisplayConfig');

		// Declarations for the Broker Config page
		var defaultBrokerElement = document.getElementById('defaultBroker');
		var newBrokerItemButton = document.getElementById('newBrokerItem');
		var localBrokerItems = [];
		var brokerItemsFetched = false;

		var diagLogEnabledElement = document.getElementById('enableLog');
		var diagLogElement = document.getElementById('diagLog');
		var emailElement = document.getElementById('email');
		var descriptionElement = document.getElementById('description');
		var clearLogElement = document.getElementById('clearLog');
		var sendLogElement = document.getElementById('sendLog');
		var getListenersElement = document.getElementById('getListeners');

		var copyTextElement = document.getElementById('copyText');
		var importElement = document.getElementById('import');
		var exportElement = document.getElementById('export');

		var itemDisplyType = "flex";

		// a method named 'onHomeyReady' must be present in your code
		function onHomeyReady(Homey)
		{
			itemDisplyType = document.getElementById('ButtonPanelConfigurationNo').style.display;

			getButtonList();

			fillButtonConfigListElement(buttonConfigurationNoElement, Homey.__("settings.buttonConfig"), localButtonConfigurations, MAX_BUTTON_CONFIGURATIONS);
			fillButtonConfigListElement(displayConfigurationNoElement, Homey.__("settings.displayConfig"), localDisplayConfigurations, MAX_DISPLAY_CONFIGURATIONS);

			getDevices();

			Homey.get('autoConfig', function (err, autoConfig)
			{
				if (err) return Homey.alert(err);
				autoConfigElement.checked = autoConfig;
				autoConfigChanged();
			});

			Homey.get('brokerConfigurationItems', function (err, brokerItems)
			{
				if (err) return Homey.alert(err);
				brokerItemsFetched = true;
				localBrokerItems = brokerItems;
			});

			autoConfigElement.addEventListener('click', function (e)
			{
				Homey.set('autoConfig', autoConfigElement.checked);
				autoConfigChanged();
			});

			diagLogEnabledElement.addEventListener('click', function (e)
			{
				Homey.set('logEnabled', diagLogEnabledElement.checked);
			});

			configTypeElement.addEventListener('change', function (e)
			{
				configTypeChanged(configTypeElement.value);
			});

			clearLogElement.addEventListener('click', function (e)
			{
				Homey.api('POST', '/clearLog/',
					{
						notify: true
					}, function (err, result)
				{
					if (err)
					{
						return Homey.alert(err);
					}
				});
			});

			openWebViewElement.addEventListener('click', function (e)
			{
				let ip = webViewIpElement.value;
				Homey.openURL(`http://${ip}`);
			});

			sendLogElement.addEventListener('click', function (e)
			{
				if (descriptionElement.value === '')
				{
					Homey.alert(Homey.__("settings.descriptionExplanation"));
					return;
				}
				Homey.confirm(Homey.__("settings.sendLogConfirm"), null, function (e, ok)
				{
					if (ok)
					{
						Homey.api('POST', '/SendLog/',
							{
								notify: true,
								email: emailElement.value,
								description: descriptionElement.value,
							}, function (err, result)
						{
							if (err)
							{
								Homey.alert(err);
							}
							else
							{
								Homey.alert(Homey.__("settings.logSent"));
							}
						});
					}
				});
			});

			getListenersElement.addEventListener('click', function (e)
			{

				Homey.api('GET', '/get_capability_listeners/', { notify: true }, function (err, result)
				{
					if (err)
					{
						Homey.alert(err);
					}
					else
					{
						// Add the listeners to the log view
						diagLogElement.value += JSON.stringify(result, null, 2);
					}
				});
			});

			Homey.on('com.ady.button_plus.logupdated', function (data)
			{
				diagLogElement.value = data.log;
			});

			saveButton.addEventListener('click', async function (e)
			{
				if (autoConfigElement.checked)
				{
					if (!storeBrokerSettings())
					{
						return;
					}

					Homey.set('brokerConfigurationItems', localBrokerItems);
					Homey.set('defaultBroker', defaultBrokerElement.value);

					// Store the current button configuration
					var buttonPanelConfigurationNo = buttonConfigurationNoElement.value;
					var ButtonPanelConfiguration = localButtonConfigurations[buttonPanelConfigurationNo]

					storeButtonSettings(ButtonPanelConfiguration);

					await Homey.set('buttonConfigurations', localButtonConfigurations);

					//Copy the values from the controls to the displayConfiguration
					storeDisplaySettings();
					await Homey.set('displayConfigurations', localDisplayConfigurations);

					Homey.api('POST', '/settings_changed/', {}, function (err, variables)
					{
						if (err) return Homey.alert(err);

						Homey.alert(Homey.__("settings.saved"));
					});

				}
			});

			function storeButtonSettings(ButtonPanelConfiguration)
			{
				for (page = 0; page < ButtonPanelConfiguration.length; page++)
				{
					ButtonPanelConfiguration[page].PageNum = document.getElementById(`${page}PageNum`).value;

					// Copy the values from the controls for each page to the displayConfiguration page
					storeButtonSettingsSection('left', page, ButtonPanelConfiguration[page]);
					storeButtonSettingsSection('right', page, ButtonPanelConfiguration[page]);
				}
			}

			function storeButtonSettingsSection(side, page, ButtonPanelConfiguration)
			{
				var topTextElement = document.getElementById(`${side}${page}TopText`);
				var onTextElement = document.getElementById(`${side}${page}OnText`);
				var offTextElement = document.getElementById(`${side}${page}OffText`);
				var dimChangeElement = document.getElementById(`${side}${page}DimChange`);
				var pageNumElement = document.getElementById(`${side}${page}PageNum`);
				var deviceElement = document.getElementById(`${side}${page}Device`);
				var capabilityElement = document.getElementById(`${side}${page}Capability`);
				var brokerIdElement = document.getElementById(`${side}${page}BrokerId`);
				var newCustomMQTTItemButton = document.getElementById(`new${side}${page}CustomMQTTItem`);
				var frontLEDOnColorElement = document.getElementById(`${side}${page}FrontLEDOnColor`);
				var wallLEDOnColorElement = document.getElementById(`${side}${page}WallLEDOnColor`);
				var frontLEDOffColorElement = document.getElementById(`${side}${page}FrontLEDOffColor`);
				var wallLEDOffColorElement = document.getElementById(`${side}${page}WallLEDOffColor`);
				var longRepeatElement = document.getElementById(`${side}${page}DisableLongRepeat`);

				if (capabilityElement.value === 'dim')
				{
					const dimVal = parseInt(dimChangeElement.value, 10);
					if (dimVal < -100 || dimVal > 100 || dimVal === 0)
					{
						Homey.alert(Homey.__("settings.dimError", { leftRight: Homey.__(`settings.${side}Panel`) }));
						return;
					}
				}

				storeCustomMQTTItems(side, ButtonPanelConfiguration);
				storeCustomMQTTItems(side, ButtonPanelConfiguration);

				// Copy the values from the controls to the buttonConfiguration
				ButtonPanelConfiguration[`${side}TopText`] = topTextElement.value;
				ButtonPanelConfiguration[`${side}OnText`] = onTextElement.value;
				ButtonPanelConfiguration[`${side}OffText`] = offTextElement.value;
				ButtonPanelConfiguration[`${side}Device`] = deviceElement.value;

				if (deviceElement.selectedIndex >= 0)
				{
					ButtonPanelConfiguration[`${side}DeviceName`] = deviceElement.options && deviceElement.options[deviceElement.selectedIndex] ? deviceElement.options[deviceElement.selectedIndex].text : deviceElement.value;
				}
				else
				{
					ButtonPanelConfiguration[`${side}DeviceName`] = deviceElement.value;
				}

				// Remove any leading spaces from the device name
				ButtonPanelConfiguration[`${side}DeviceName`] = ButtonPanelConfiguration[`${side}DeviceName`].trim();

				// Remove all occurrences of ' (Missing Devices)' from the capability name
				ButtonPanelConfiguration[`${side}DeviceName`] = ButtonPanelConfiguration[`${side}DeviceName`].replace(/ \(Missing Devices\)/g, '');

				ButtonPanelConfiguration[`${side}Capability`] = capabilityElement.value;
				if (capabilityElement.selectedIndex >= 0)
				{
					ButtonPanelConfiguration[`${side}CapabilityName`] = capabilityElement.options && capabilityElement.options[capabilityElement.selectedIndex] ? capabilityElement.options[capabilityElement.selectedIndex].text : capabilityElement.value;
				}
				else
				{
					ButtonPanelConfiguration[`${side}CapabilityName`] = capabilityElement.value;
				}

				// Remove ' (Missing)' from the capability name
				ButtonPanelConfiguration[`${side}CapabilityName`] = ButtonPanelConfiguration[`${side}CapabilityName`].replace(/ \(Missing\)/g, '');

				ButtonPanelConfiguration[`${side}BrokerId`] = brokerIdElement.value;
				ButtonPanelConfiguration[`${side}DimChange`] = dimChangeElement.value;
				ButtonPanelConfiguration[`${side}FrontLEDOnColor`] = frontLEDOnColorElement.value;
				ButtonPanelConfiguration[`${side}WallLEDOnColor`] = wallLEDOnColorElement.value;
				ButtonPanelConfiguration[`${side}FrontLEDOffColor`] = frontLEDOffColorElement.value;
				ButtonPanelConfiguration[`${side}WallLEDOffColor`] = wallLEDOffColorElement.value;
				ButtonPanelConfiguration[`${side}DisableLongRepeat`] = !longRepeatElement.checked;
			};

			// Read the button configuration from the settings and write the controls
			Homey.get('buttonConfigurations', function (err, buttonConfigurations)
			{
				if (err) return Homey.alert(err);
				localButtonConfigurations = buttonConfigurations;
				buttonConfigurationsFetched = true;
				console.log('buttonConfigurations: ' + JSON.stringify(buttonConfigurations));

				// Make sure currentButtonConfigurationNo is set and within range
				if (!currentButtonConfigurationNo || (currentButtonConfigurationNo >= localButtonConfigurations.length))
				{
					currentButtonConfigurationNo = 0;
				}

				// Get the current configuration
				var buttonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];

				writeButtonsections(buttonPanelConfiguration.length);
				updateButtonPanelControls();
			});

			buttonConfigurationNoElement.addEventListener('change', function (e)
			{
				// Store the current configuration
				var buttonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];
				storeButtonSettings(buttonPanelConfiguration);

				currentButtonConfigurationNo = buttonConfigurationNoElement.value;

				// Make sure currentButtonConfigurationNo is set and within range
				if (!currentButtonConfigurationNo || (currentButtonConfigurationNo >= localButtonConfigurations.length))
				{
					currentButtonConfigurationNo = 0;
				}

				// Get the current configuration
				var buttonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];

				writeButtonsections(buttonPanelConfiguration.length);
				updateButtonPanelControls();
			});

			displayConfigNameElement.addEventListener('change', function (e)
			{
				var DisplayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];
				DisplayConfiguration.name = displayConfigNameElement.value;

				// Update the configuration list
				let txt = Homey.__("settings.displayConfig");
				var option = displayConfigurationNoElement.options[displayConfigurationNoElement.selectedIndex];
				option.text = `${txt} ${parseInt(currentDisplayConfigurationNo, 10) + 1} - ${displayConfigNameElement.value}`
			});

			// Display Config code

			displayConfigurationNoElement.addEventListener('change', function (e)
			{
				redisplayDisplyConfig();
			});

			addButtonPageElement.addEventListener('click', function (e)
			{
				var buttonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];

				// save the controls into the local configuration
				storeButtonSettings(buttonPanelConfiguration);

				// Add a new page to the current button configuration
				var newPage = JSON.parse(JSON.stringify(buttonPanelConfiguration[0]));
				newPage.PageNum = buttonPanelConfiguration.length;
				buttonPanelConfiguration.push(newPage);

				// Create and display the new page
				writeButtonsections(buttonPanelConfiguration.length);
				updateButtonPanelControls();
			});

			copyButtonConfigElement.addEventListener('click', function (e)
			{
				try
				{
					// Copy the current button configuration to the clipboard in JSON format
					var buttonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];
					var copy = {};
					copy.copySource = "ButtonPanel";
					copy.butons = buttonPanelConfiguration;
					const jsonString = JSON.stringify(copy, null, 2);

					copyTextElement.value = jsonString;

					// Notify the user
					Homey.alert(Homey.__("settings.copied"));
				}
				catch (err)
				{
					Homey.alert(Homey.__("settings.clipboardError", { error: err }));
				}
			});

			pasteButtonConfigElement.addEventListener('click', function (e)
			{
				try
				{
					// Parse the JSON string
					const copy = JSON.parse(copyTextElement.value);
					if (copy.copySource !== "ButtonPanel")
					{
						Homey.alert(Homey.__("settings.clipboardError", { error: "Invalid source" }));
						return;
					}

					let buttonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];
					let newButtonPanelConfiguration = copy.butons;

					for (let page = 0; page < newButtonPanelConfiguration.length; page++)
					{
						// if the page doesn't exist, add it
						if (!buttonPanelConfiguration[page])
						{
							buttonPanelConfiguration[page] = {};
						}

						// Copy the values from the new configuration to the current configuration
						buttonPanelConfiguration[page].PageNum = page;

						if (newButtonPanelConfiguration[page].leftTopText !== undefined) buttonPanelConfiguration[page].leftTopText = newButtonPanelConfiguration[page].leftTopText;
						if (newButtonPanelConfiguration[page].leftOnText !== undefined) buttonPanelConfiguration[page].leftOnText = newButtonPanelConfiguration[page].leftOnText;
						if (newButtonPanelConfiguration[page].leftOffText !== undefined) buttonPanelConfiguration[page].leftOffText = newButtonPanelConfiguration[page].leftOffText;
						if (newButtonPanelConfiguration[page].leftDevice !== undefined) buttonPanelConfiguration[page].leftDevice = newButtonPanelConfiguration[page].leftDevice;
						if (newButtonPanelConfiguration[page].leftDeviceName !== undefined) buttonPanelConfiguration[page].leftDeviceName = newButtonPanelConfiguration[page].leftDeviceName;
						if (newButtonPanelConfiguration[page].leftCapability !== undefined) buttonPanelConfiguration[page].leftCapability = newButtonPanelConfiguration[page].leftCapability;
						if (newButtonPanelConfiguration[page].leftCapabilityName !== undefined) buttonPanelConfiguration[page].leftCapabilityName = newButtonPanelConfiguration[page].leftCapabilityName;
						if (newButtonPanelConfiguration[page].leftBrokerId !== undefined) buttonPanelConfiguration[page].leftBrokerId = newButtonPanelConfiguration[page].leftBrokerId;
						if (newButtonPanelConfiguration[page].leftDimChange !== undefined) buttonPanelConfiguration[page].leftDimChange = newButtonPanelConfiguration[page].leftDimChange;
						if (newButtonPanelConfiguration[page].leftFrontLEDOnColor !== undefined) buttonPanelConfiguration[page].leftFrontLEDOnColor = newButtonPanelConfiguration[page].leftFrontLEDOnColor;
						if (newButtonPanelConfiguration[page].leftWallLEDOnColor !== undefined) buttonPanelConfiguration[page].leftWallLEDOnColor = newButtonPanelConfiguration[page].leftWallLEDOnColor;
						if (newButtonPanelConfiguration[page].leftFrontLEDOffColor !== undefined) buttonPanelConfiguration[page].leftFrontLEDOffColor = newButtonPanelConfiguration[page].leftFrontLEDOffColor;
						if (newButtonPanelConfiguration[page].leftWallLEDOffColor !== undefined) buttonPanelConfiguration[page].leftWallLEDOffColor = newButtonPanelConfiguration[page].leftWallLEDOffColor;
						if (newButtonPanelConfiguration[page].leftCustomMQTTTopics !== undefined) buttonPanelConfiguration[page].leftCustomMQTTTopics = newButtonPanelConfiguration[page].leftCustomMQTTTopics;
						if (newButtonPanelConfiguration[page].leftDisableLongRepeat !== undefined) buttonPanelConfiguration[page].leftDisableLongRepeat = newButtonPanelConfiguration[page].leftDisableLongRepeat;

						if (newButtonPanelConfiguration[page].rightTopText !== undefined) buttonPanelConfiguration[page].rightTopText = newButtonPanelConfiguration[page].rightTopText;
						if (newButtonPanelConfiguration[page].rightOnText !== undefined) buttonPanelConfiguration[page].rightOnText = newButtonPanelConfiguration[page].rightOnText;
						if (newButtonPanelConfiguration[page].rightOffText !== undefined) buttonPanelConfiguration[page].rightOffText = newButtonPanelConfiguration[page].rightOffText;
						if (newButtonPanelConfiguration[page].rightDevice !== undefined) buttonPanelConfiguration[page].rightDevice = newButtonPanelConfiguration[page].rightDevice;
						if (newButtonPanelConfiguration[page].rightDeviceName !== undefined) buttonPanelConfiguration[page].rightDeviceName = newButtonPanelConfiguration[page].rightDeviceName;
						if (newButtonPanelConfiguration[page].rightCapability !== undefined) buttonPanelConfiguration[page].rightCapability = newButtonPanelConfiguration[page].rightCapability;
						if (newButtonPanelConfiguration[page].rightCapabilityName !== undefined) buttonPanelConfiguration[page].rightCapabilityName = newButtonPanelConfiguration[page].rightCapabilityName;
						if (newButtonPanelConfiguration[page].rightBrokerId !== undefined) buttonPanelConfiguration[page].rightBrokerId = newButtonPanelConfiguration[page].rightBrokerId;
						if (newButtonPanelConfiguration[page].rightDimChange !== undefined) buttonPanelConfiguration[page].rightDimChange = newButtonPanelConfiguration[page].rightDimChange;
						if (newButtonPanelConfiguration[page].rightFrontLEDOnColor !== undefined) buttonPanelConfiguration[page].rightFrontLEDOnColor = newButtonPanelConfiguration[page].rightFrontLEDOnColor;
						if (newButtonPanelConfiguration[page].rightWallLEDOnColor !== undefined) buttonPanelConfiguration[page].rightWallLEDOnColor = newButtonPanelConfiguration[page].rightWallLEDOnColor;
						if (newButtonPanelConfiguration[page].rightFrontLEDOffColor !== undefined) buttonPanelConfiguration[page].rightFrontLEDOffColor = newButtonPanelConfiguration[page].rightFrontLEDOffColor;
						if (newButtonPanelConfiguration[page].rightWallLEDOffColor !== undefined) buttonPanelConfiguration[page].rightWallLEDOffColor = newButtonPanelConfiguration[page].rightWallLEDOffColor;
						if (newButtonPanelConfiguration[page].rightCustomMQTTTopics !== undefined) buttonPanelConfiguration[page].rightCustomMQTTTopics = newButtonPanelConfiguration[page].rightCustomMQTTTopics;
						if (newButtonPanelConfiguration[page].rightLongRepeat !== undefined) buttonPanelConfiguration[page].rightLongRepeat = newButtonPanelConfiguration[page].rightLongRepeat;
					}
					// Update the controls
					writeButtonsections(buttonPanelConfiguration.length);
					updateButtonPanelControls();
				}
				catch (err)
				{
					Homey.alert(Homey.__("settings.clipboardError", { error: err }));
				}
			});

			copyDisplayConfigElement.addEventListener('click', function (e)
			{
				try
				{
					// Copy the current button configuration to the clipboard in JSON format
					var displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];
					displayConfiguration.copySource = "Display";
					const jsonString = JSON.stringify(displayConfiguration, null, 2);

					copyTextElement.value = jsonString;

					// Notify the user
					Homey.alert(Homey.__("settings.copied"));
				}
				catch (err)
				{
					Homey.alert(Homey.__("settings.clipboardError", { error: err }));
				}
			});

			pasteDisplayConfigElement.addEventListener('click', function (e)
			{
				try
				{
					// Parse the JSON string
					const newDisplayConfiguration = JSON.parse(copyTextElement.value);
					if (newDisplayConfiguration.copySource !== "Display")
					{
						Homey.alert(Homey.__("settings.clipboardError", { error: "Invalid source" }));
						return;
					}

					let displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];

					// Copy the values from the new configuration to the current configuration
					displayConfiguration.items = newDisplayConfiguration.items;

					// Update the controls
					updateDisplayConfiguration();
				}
				catch (err)
				{
					Homey.alert(Homey.__("settings.clipboardError", { error: err }));
				}
			});

			// Import button click handler
			importElement.addEventListener('click', function (e)
			{
				try
				{
					// Parse the JSON string
					const newConfigurations = JSON.parse(copyTextElement.value);

					if (newConfigurations.copySource !== "Export")
					{
						Homey.alert(Homey.__("settings.clipboardError", { error: "Invalid source" }));
						return;
					}

					// Copy the values from the new configuration to the current configuration
					localButtonConfigurations = newConfigurations.buttonConfigurations;
					localDisplayConfigurations = newConfigurations.displayConfigurations;
					localBrokerItems = newConfigurations.brokerItems;

					// Update the controls
					// Get the current configuration
					var buttonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];

					writeButtonsections(buttonPanelConfiguration.length);
					updateButtonPanelControls();
					updateDisplayConfiguration();
					drawBrokerItems();

					// Notify the user
					Homey.alert(Homey.__("settings.imported"));
				}
				catch (err)
				{
					Homey.alert(Homey.__("settings.clipboardError", { error: err }));
				}
			});

			// Export button click handler
			exportElement.addEventListener('click', function (e)
			{
				try
				{
					// Copy the current configurations to the clipboard in JSON format
					const jsonString = JSON.stringify(
						{
							copySource: "Export",
							buttonConfigurations: localButtonConfigurations,
							displayConfigurations: localDisplayConfigurations,
							brokerItems: localBrokerItems,
						}, null, 2);

					copyTextElement.value = jsonString;

					// Notify the user
					Homey.alert(Homey.__("settings.exported"));
				}
				catch (err)
				{
					Homey.alert(Homey.__("settings.clipboardError", { error: err }));
				}
			});

			newDisplayItemButton.addEventListener('click', function (e)
			{
				if (displayConfigurationsFetched)
				{
					// Make sure the current item is saved in the local display configuration
					storeDisplaySettings();

					// Create a new display item
					displayConfigurationNo = displayConfigurationNoElement.value;
					var displayConfiguration = localDisplayConfigurations[displayConfigurationNo];
					if (displayConfiguration)
					{
						let itemId = displayConfiguration.items.length;

						var displayItem = {
							itemId,
							device: "none",
							deviceName: "none",
							capability: "",
							capabilityName: "",
							label: "",
							unit: "",
							numberRounding: -1,
							xPos: 0,
							yPos: 0,
							width: 100,
							fontSize: 1,
							brokerId: 'Default',
							page: 0,
							customMQTTTopics: [],
						};

						// Add the new display item to the local display configuration
						displayConfiguration.items.push(displayItem) - 1;
						localDisplayConfigurations[displayConfigurationNo] = displayConfiguration;

						// Redraw the display items
						drawDisplayConfiguration(displayConfiguration, itemId);
					}
				}
			});

			// newLeftCustomMQTTItemButton.addEventListener('click', function (e)
			// {
			// 	var ButtonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];
			// 	if (ButtonPanelConfiguration)
			// 	{
			// 		storeCustomMQTTItems("left", ButtonPanelConfiguration);

			// 		var customMQTTItem = {
			// 			id: '',
			// 			type: 0,
			// 			topic: "",
			// 			payload: "",
			// 			brokerId: 'Default',
			// 			enable: true,
			// 		};

			// 		ButtonPanelConfiguration.leftCustomMQTTTopics.push(customMQTTItem);
			// 		drawCustomMQTTTopics("left", ButtonPanelConfiguration);
			// 	}
			// });

			// newRightCustomMQTTItemButton.addEventListener('click', function (e)
			// {
			// 	var ButtonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];
			// 	if (ButtonPanelConfiguration)
			// 	{
			// 		storeCustomMQTTItems("right", ButtonPanelConfiguration);
			// 		var customMQTTItem = {
			// 			id: '',
			// 			type: 0,
			// 			topic: "",
			// 			payload: "",
			// 			brokerId: 'Default',
			// 			enable: true,
			// 		};

			// 		ButtonPanelConfiguration.rightCustomMQTTTopics.push(customMQTTItem);
			// 		drawCustomMQTTTopics("right", ButtonPanelConfiguration);
			// 	}
			// });

			Homey.get('displayConfigurations', function (err, displayConfigurations)
			{
				if (err) return Homey.alert(err);
				localDisplayConfigurations = displayConfigurations;
				displayConfigurationsFetched = (localDisplayConfigurations.length > 0);
				// add the itemId and validate the page number to each item
				for (let i = 0; i < localDisplayConfigurations.length; i++)
				{
					const displayConfiguration = localDisplayConfigurations[i];
					for (let j = 0; j < displayConfiguration.items.length; j++)
					{
						displayConfiguration.items[j].itemId = j;
						if (displayConfiguration.items[j].page === undefined)
						{
							displayConfiguration.items[j].page = 0;
						}
					}
				}

				updateDisplayConfiguration();
			});

			newBrokerItemButton.addEventListener('click', function (e)
			{
				// Create a new broker item
				var brokerItem = {
					brokerid: "Unnamed",
					url: "",
					port: 1883,
					wsPort: 9001,
					enabled: true,
					protected: false,
				};

				// Add the new broker to the local broker list
				localBrokerItems.push(brokerItem);

				// Add the broker to the broker lists
				addBrokerToConfig(brokerItem);

				// Redraw the broker items
				drawBrokerItems();
			});

			var tooltips = document.querySelectorAll(".tooltip");
			tooltips.forEach(function (tooltip, index)
			{
				// Set a mouse over function for each tooltop element
				tooltip.addEventListener("mouseover", position_tooltip); // On hover, launch the function below
			})

			// Tell Homey we're ready to be displayed
			Homey.ready();

			configTypeChanged('settings');
		}

		function position_tooltip()
		{
			// Get .tooltiptext sibling
			var tooltip = this.parentNode.querySelector(".tooltiptext");

			// Get tooltip coordinates and size
			var tooltip_rect = tooltip.getBoundingClientRect();

			// Corrections if out of window
			var maxRight = window.innerWidth - 50;
			var tipRight = tooltip_rect.x + tooltip_rect.width;

			if (tipRight > maxRight)
			{
				tipX = maxRight - tipRight;

				// Apply corrected position
				if (tooltip.style.left === "")
				{
					tooltip.style.left = tipX + 'px';
				}
				else
				{
					tooltip.style.left -= tipX + 'px';
				}
			}
		}

		function fillButtonConfigListElement(element, txt, configurations, NumConfigurations)
		{
			//fill the configuration list with configuration number / names
			element.innerHTML = "";

			var option = document.createElement("option");
			for (let i = 0; i < NumConfigurations; i++)
			{
				let config = configurations[i];

				var option = document.createElement("option");
				option.value = i;
				option.text = `${txt} ${i + 1} - ${(config && config.name) ? config.name : ''}`;
				element.add(option);
			}
		}

		function fillDefaultBrokerList()
		{
			if (brokerItemsFetched)
			{
				//fill the broker lists with brokers
				defaultBrokerElement.innerHTML = "";
				for (let i = 0; i < localBrokerItems.length; i++)
				{
					const brokerItem = localBrokerItems[i];
					if (brokerItem.enabled)
					{
						var option = document.createElement("option");
						option.value = brokerItem.brokerid;
						option.text = brokerItem.brokerid;
						defaultBrokerElement.add(option);
					}
				}
			}
		}

		function onButtonPageChange(element, side)
		{

		}

		function onButtonLabelChange(element, side)
		{
			document.getElementById(`button${side}Legend`).innerHTML = `<b><em>${Homey.__(`settings.${side}Panel`)}</em></b> - ${element.value}`;
		}

		function sortDevices(devicesArray)
		{
			return devicesArray.sort((a, b) =>
			{
				const zoneA = a.zone.name ?? a.zoneName;
				const zoneB = b.zone.name ?? b.zoneName;

				if (zoneA < zoneB)
				{
					return -1;
				}
				if (zoneA > zoneB)
				{
					return 1;
				}
				return 0;
			});
		}

		function filterButtonDevices(devices)
		{
			return devices.filter((device) =>
			{
				// Check if at least one capability has type "boolean"
				if (device.capabilitiesObj)
				{
					return Object.values(device.capabilitiesObj).some((capability) =>
					{
						return ((capability.type === "boolean") || (capability.id === "dim") || (capability.id === "windowcoverings_state"));
					});
				}
			});
		}

		// Fetch the devices and then update the displays
		function getDevices()
		{
			Homey.api('POST', '/Devices/', {}, function (err, devices)
			{
				if (err) return Homey.alert(err);

				devices = Object.values(devices);

				displayDevicesArray = sortDevices(devices);
				displayDevicesFetched = true;
				fillDisplayDevices();

				buttonDevicesArray = sortDevices(filterButtonDevices(devices));
				buttonDevicesFetched = true;

				// Get the current configuration
				var buttonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];

				writeButtonsections(buttonPanelConfiguration.length);
				updateButtonPanelControls();
			});
		}

		function fillButtonDevices()
		{
			//fill the device lists with devices
			if (buttonDevicesFetched)
			{
				// Get the number of pages in the current configuration
				var buttonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];
				var numPages = Array.isArray(buttonPanelConfiguration) ? buttonPanelConfiguration.length : 1;

				for (let i = 0; i < numPages; i++)
				{
					const leftElement = document.getElementById(`left${i}Device`);
					fillDevicesElement(leftElement, buttonDevicesArray);

					const rightElement = document.getElementById(`right${i}Device`);
					fillDevicesElement(rightElement, buttonDevicesArray);
				}
			};
		}

		function fillDevicesElement(Element, DevicesArray)
		{
			if (Element && (DevicesArray.length > 0))
			{
				//fill the device lists with devices
				Element.innerHTML = "";

				var option = document.createElement("option");
				option.text = Homey.__("settings.none");
				option.value = "none";
				Element.add(option);

				var option = document.createElement("option");
				option.text = Homey.__("settings.variable");
				option.value = "_variable_";
				Element.add(option);

				var option = document.createElement("option");
				option.text = Homey.__("settings.customMQTT");
				option.value = "customMQTT";
				Element.add(option);

				let deviceGroup;
				for (const device of DevicesArray)
				{
					const zoneName = device.zone.name ?? device.zoneName;
					if (deviceGroup != zoneName)
					{
						var option = document.createElement("option");
						deviceGroup = zoneName;
						option.text = deviceGroup;
						option.value = deviceGroup;
						option.disabled = true;
						Element.add(option);
					}

					var option = document.createElement("option");
					option.text = "\xA0\xA0" + device.name;
					option.text += ` (${zoneName})`;
					option.value = device.id;
					Element.add(option);
				}
			}
		}

		function fillButtonVariablesElement(side, page, capabilityElement, selectedCapability, selectedCapabilityName)
		{
			// Remove the ' (Missing)' from the selectedCapabilityName
			selectedCapabilityName = selectedCapabilityName.replace(/ \(Missing\)/g, "");

			for (const variable of variablesArray)
			{
				if (variable.type === "boolean")
				{
					var option = document.createElement("option");
					option.text = variable.name;
					option.value = variable.id;
					capabilityElement.add(option);
				}
			}

			// Restore the previous variable selection
			capabilityElement.value = selectedCapability;
			if (capabilityElement.value !== selectedCapability)
			{
				// The variable must be missing, so add it to the list
				var option = document.createElement("option");
				option.text = selectedCapabilityName + " (Missing)";
				option.value = selectedCapability;
				capabilityElement.add(option);

				capabilityElement.value = selectedCapability;
			}

			capabilityChanged(side, page, selectedCapability);
		}

		function getCapabilities(side, page, deviceId, selectedCapability, selectedCapabilityName)
		{
			// Remove any ' (Missing)' text from the selectedCapabilityName
			selectedCapabilityName = selectedCapabilityName ? selectedCapabilityName.replace(/ \(Missing\)/g, "") : selectedCapabilityName;

			// Clear the list options
			let capabilityElement = document.getElementById(`${side}${page}Capability`);
			capabilityElement.innerHTML = "";

			let capabilityDivElement = document.getElementById(`${side}${page}CapabilityDiv`);

			if ((deviceId === "none") || (deviceId === ""))
			{
				// Hide the capability element items using the div
				capabilityDivElement.style.display = "none";

				// We don't want to show Dim Change value
				document.getElementById(`${side}${page}DimChangeDiv`).style.display = "none";
				document.getElementById(`${side}${page}BrokerIdDiv`).style.display = itemDisplyType;
				document.getElementById(`${side}${page}CustomMQTTDiv`).style.display = "none";
				return;
			}

			if (deviceId === "customMQTT")
			{
				// Hide the capability element items using the div
				capabilityDivElement.style.display = "none";

				// We don't want to show Dim Change value
				document.getElementById(`${side}${page}DimChangeDiv`).style.display = "none";
				document.getElementById(`${side}${page}BrokerIdDiv`).style.display = "none";

				// Show the custom MQTT section
				document.getElementById(`${side}${page}CustomMQTTDiv`).style.display = itemDisplyType;
				drawCustomMQTTTopics(side, localButtonConfigurations[currentButtonConfigurationNo]);
				return;
			}

			if (deviceId === '_variable_')
			{
				if (variablesFetched)
				{
					// Add each of the variables to the item drop list
					fillButtonVariablesElement(side, page, capabilityElement, selectedCapability, selectedCapabilityName);
				}
				else
				{
					// Resquest the list of variables
					Homey.api('POST', '/get_variables/', {}, function (err, variables)
					{
						if (err) return Homey.alert(err);

						if (variables)
						{
							// Add each of the variables to the item drop list
							variablesArray = Object.values(variables);
							variablesFetched = true;
							fillButtonVariablesElement(side, page, capabilityElement, selectedCapability, selectedCapabilityName);
						}
					});
				}

				// Show the capability section
				capabilityDivElement.style.display = itemDisplyType;
				document.getElementById(`${side}${page}BrokerIdDiv`).style.display = itemDisplyType;
				document.getElementById(`${side}${page}CustomMQTTDiv`).style.display = "none";
				return;
			}

			const devIdx = buttonDevicesArray.findIndex((device) => device.id === deviceId)
			if (devIdx >= 0)
			{
				const device = buttonDevicesArray[devIdx];
				const zoneName = device.zone.name ?? device.zoneName;
				if (zoneName === "Missing Devices")
				{
					// Remove ' (Missing Devices)' from the selectedCapabilityName
					selectedCapabilityName = selectedCapabilityName.replace(/ \(Missing Devices\)/g, "");

					// There won't be any capabilities defined for this device, so add the capability for the missing device from the ButtonPanelConfiguration.'side'Capability setting
					var option = document.createElement("option");
					option.text = selectedCapabilityName;
					option.value = selectedCapability;
					capabilityElement.add(option);

					capabilityDivElement.style.display = itemDisplyType;
					document.getElementById(`${side}${page}BrokerIdDiv`).style.display = itemDisplyType;
					document.getElementById(`${side}${page}CustomMQTTDiv`).style.display = "none";

					// Restore the previous capability selection
					capabilityElement.value = selectedCapability;
					capabilityChanged(side, page, selectedCapability);
					return;
				}
			}

			// Request the capabilities for the selected device
			Homey.api('POST', '/device_capabilities/', { deviceId }, function (err, capabilities)
			{
				if (err) return Homey.alert(err);

				if (capabilities)
				{
					// Add each of the capabilities to the item drop list
					const capabilitiesArray = Object.values(capabilities);
					for (const capability of capabilitiesArray)
					{
						if (capability.type === "boolean" || capability.id === "dim" || capability.id === "windowcoverings_state")
						{
							var option = document.createElement("option");
							option.text = `${capability.title} (${capability.id})`;
							option.value = capability.id;
							capabilityElement.add(option);
						}
					}

					// Show the capability section
					capabilityDivElement.style.display = itemDisplyType;
					document.getElementById(`${side}${page}BrokerIdDiv`).style.display = itemDisplyType;
					document.getElementById(`${side}${page}CustomMQTTDiv`).style.display = "none";

					// Restore the previous capability selection
					capabilityElement.value = selectedCapability;
					capabilityChanged(side, page, selectedCapability);
				}
			});
		}

		function capabilityChanged(side, page, value)
		{
			if (value === "dim")
			{
				// For dim type capabilities we want to show the dim change value
				document.getElementById(`${side}${page}DimChangeDiv`).style.display = itemDisplyType;

				// And we don't want to show the On or Off text
				document.getElementById(`${side}${page}OnTextDiv`).style.display = "none";
				document.getElementById(`${side}${page}OffText`).style.display = "none";
				document.getElementById(`${side}${page}OffTextLabel`).style.display = "none";
			}
			else
			{
				// For Boolean types we don't want to show Dim Change value
				document.getElementById(`${side}${page}DimChangeDiv`).style.display = "none";

				// And we want to show the On and Off text
				document.getElementById(`${side}${page}OnTextDiv`).style.display = itemDisplyType;
				document.getElementById(`${side}${page}OffText`).style.display = itemDisplyType;
				document.getElementById(`${side}${page}OffTextLabel`).style.display = itemDisplyType;
			}
			//document.getElementById(`${side}TopText`).value = document.getElementById(`${side}TopText`).value ? document.getElementById(`${side}TopText`).value : value;

		}

		// If the config and devices have been fetched, update all the control values
		function updateButtonPanelControls()
		{
			if ((buttonConfigurationsFetched == false) || (buttonDevicesFetched == false)) return;

			if (currentButtonConfigurationNo < 0 || currentButtonConfigurationNo >= localButtonConfigurations.length)
			{
				currentButtonConfigurationNo = 0;
				buttonConfigurationNoElement.value = currentButtonConfigurationNo;
			}

			let config = localButtonConfigurations[currentButtonConfigurationNo];

			for (let page = 0; page < config.length; page++)
			{
				document.getElementById(`${page}PageNum`).value = page === 0 ? 'Default' : config[page].PageNum;

				updateButtonPanelControlsSection("left", page, config[page]);
				updateButtonPanelControlsSection("right", page, config[page]);
			}

			fillButtonDevices();
			setupButtonBrokerItems();
		}

		// Update the controls for the specified side and page
		function updateButtonPanelControlsSection(side, page, ButtonPanelConfiguration)
		{
			if (buttonConfigurationNoElement.value == "")
			{
				// fillButtonConfigListElement(buttonConfigurationNoElement, Homey.__("settings.buttonConfig"), localButtonConfigurations, MAX_BUTTON_CONFIGURATIONS);

				configNameElement.value = "";
				document.getElementById(`${side}${page}TopText`).value = "";
				document.getElementById(`${side}${page}OnText`).value = "";
				document.getElementById(`${side}${page}OffText`).value = "";
				document.getElementById(`${side}${page}Device`).value = "";
				document.getElementById(`${side}${page}Capability`).value = "";
				document.getElementById(`${side}${page}BrokerId`).value = 'Default';
				document.getElementById(`${side}${page}DimChange`).value = "+10";
				document.getElementById(`${side}${page}FrontLEDOnColor`).value = "#ff0000";
				document.getElementById(`${side}${page}WallLEDOnColor`).value = "#ff0000";
				document.getElementById(`${side}${page}FrontLEDOffColor`).value = "#000000";
				document.getElementById(`${side}${page}WallLEDOffColor`).value = "#000000";
				document.getElementById(`${side}${page}DisableLongRepeat`).checked = true;
			}
			else
			{
				currentButtonConfigurationNo = buttonConfigurationNoElement.value;

				// fillButtonConfigListElement(buttonConfigurationNoElement, Homey.__("settings.buttonConfig"), localButtonConfigurations, MAX_BUTTON_CONFIGURATIONS);

				buttonConfigurationNoElement.value = currentButtonConfigurationNo;

				// let ButtonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];
				// configNameElement.value = ButtonPanelConfiguration.name ? ButtonPanelConfiguration.name : "";

				// Fill button panel
				const panelText = Homey.__(`settings.${side}Panel`);
				document.getElementById(`${side}${page}TopText`).value = ButtonPanelConfiguration[`${side}TopText`];
				document.getElementById(`button${side}${page}Legend`).innerHTML = `<b><em>${panelText}</em></b> - ${document.getElementById(`${side}${page}TopText`).value}`;
				document.getElementById(`${side}${page}OnText`).value = ButtonPanelConfiguration[`${side}OnText`];
				document.getElementById(`${side}${page}OffText`).value = ButtonPanelConfiguration[`${side}OffText`];
				document.getElementById(`${side}${page}Device`).value = ButtonPanelConfiguration[`${side}Device`];
				// If the element is not in the list, add it
				if (document.getElementById(`${side}${page}Device`).value != ButtonPanelConfiguration[`${side}Device`])
				{
					if (buttonDevicesArray.findIndex((device) => device.id === ButtonPanelConfiguration[`${side}Device`]) < 0)
					{
						var name = ButtonPanelConfiguration[`${side}DeviceName`] ? ButtonPanelConfiguration[`${side}DeviceName`] : ButtonPanelConfiguration[`${side}Device`];

						// Remove any leading spaces from the device name
						name = name.trim();

						// Remove all occurrences of ' (Missing Devices)' from the name
						name = name.replace(/ \(Missing Devices\)/g, "");

						buttonDevicesArray.push({ id: ButtonPanelConfiguration[`${side}Device`], name, zone: { name: "Missing Devices" } });
						buttonDevicesArray = sortDevices(buttonDevicesArray);
						fillButtonDevices();
						document.getElementById(`${side}${page}Device`).value = ButtonPanelConfiguration[`${side}Device`];
					}
				}

				getCapabilities(side, page, document.getElementById(`${side}${page}Device`).value, ButtonPanelConfiguration[`${side}Capability`], ButtonPanelConfiguration[`${side}CapabilityName`]);
				document.getElementById(`${side}${page}BrokerId`).value = ButtonPanelConfiguration[`${side}BrokerId`];
				document.getElementById(`${side}${page}DimChange`).value = ButtonPanelConfiguration[`${side}DimChange`];
				document.getElementById(`${side}${page}FrontLEDOnColor`).value = ButtonPanelConfiguration[`${side}FrontLEDOnColor`];
				document.getElementById(`${side}${page}WallLEDOnColor`).value = ButtonPanelConfiguration[`${side}WallLEDOnColor`];
				document.getElementById(`${side}${page}FrontLEDOffColor`).value = ButtonPanelConfiguration[`${side}FrontLEDOffColor`];
				document.getElementById(`${side}${page}WallLEDOffColor`).value = ButtonPanelConfiguration[`${side}WallLEDOffColor`];
				document.getElementById(`${side}${page}DisableLongRepeat`).checked = !ButtonPanelConfiguration[`${side}DisableLongRepeat`];
			}
		}

		function autoConfigChanged()
		{
			if (!autoConfigElement.checked)
			{
				configTypeChanged("");
				document.getElementById('AutoConfigWarnOff').style.display = "block";
				document.getElementById('AutoConfigWarnOn').style.display = "none";
				saveBlock.style.display = "none";
				configTypeElement.style.display = "none";
			}
			else
			{
				configTypeChanged(configTypeElement.value);
				document.getElementById('AutoConfigWarnOff').style.display = "none";
				document.getElementById('AutoConfigWarnOn').style.display = "block";
				if (configTypeElement.value === "settings" || configTypeElement.value === "diagnosticLog")
				{
					saveBlock.style.display = "none";
				}
				else
				{
					saveBlock.style.display = "block";
				}
				configTypeElement.style.display = "block";
			}
		}

		function configTypeChanged(configSelected)
		{
			var i, tabcontent, tablinks;

			// Get all elements with class="tabcontent" and hide them
			tabcontent = document.getElementsByClassName("tabcontent");
			for (i = configSelected ? 0 : 1; i < tabcontent.length; i++)
			{
				tabcontent[i].style.display = "none";
			}
			if (configSelected !== "")
			{
				// Hide the save button for the settings and diagnostics pages
				if ((configSelected === "settings") || (configSelected === "diagnosticLog") || (configSelected === "importExport"))
				{
					saveBlock.style.display = "none";
				}
				else
				{
					saveBlock.style.display = "block";
				}
				document.getElementById(configSelected).style.display = "block";

				if (configSelected === "diagnosticLog")
				{
					// Refresh the log data
					Homey.get('logEnabled', function (err, logLevel)
					{
						if (err) return Homey.alert(err);
						enableLog.checked = logLevel;
					});

					Homey.api('GET', '/getLog/',
						{
							notify: true
						}, function (err, result)
					{
						if (err)
						{
							return Homey.alert(err);
						}
						else
						{
							diagLogElement.value = result;
						}
					});

					// Make the log text area fill the page
					diagLogElement.style.width = (emailElement.offsetWidth) + 'px';
					diagLogElement.style.height = (window.innerHeight - diagLogElement.offsetTop - 35) + 'px';
				}
				else if (configSelected === "importExport")
				{
					// Make the log text area fill the page
					copyTextElement.style.height = (window.innerHeight - copyTextElement.offsetTop - 120) + 'px';
				}
			}
		}

		// Store the current display settings and then apply the new ones
		function redisplayDisplyConfig(activeItemNo = -1)
		{
			// Store the current configuration
			storeDisplaySettings();

			// Fetch the new configuration
			updateDisplayConfiguration(activeItemNo);
		}

		// If the config has been fetched, update all the control values
		function updateDisplayConfiguration(expandItem = -1)
		{
			if (displayConfigurationsFetched)
			{
				currentDisplayConfigurationNo = displayConfigurationNoElement.value;

				var displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];

				let expandItemId = -1;
				if (displayConfiguration == null)
				{
					displayConfiguration = {};
					displayConfiguration.items = [];
				}
				else
				{
					if (expandItem >= 0)
					{
						expandItemId = displayConfiguration.items[expandItem].itemId;
					}
				}

				drawDisplayConfiguration(displayConfiguration, expandItemId);
			}
		}

		// Create all the display items for the specified display configuration
		function drawDisplayConfiguration(displayConfiguration, expandItemId = -1)
		{
			// Sort the display items by page number, then by Y position and finally by X position
			displayConfiguration.items.sort((a, b) =>
			{
				if (a.page < b.page)
				{
					return -1;
				}
				if (a.page > b.page)
				{
					return 1;
				}
				if (a.yPos < b.yPos)
				{
					return -1;
				}
				if (a.yPos > b.yPos)
				{
					return 1;
				}
				if (a.xPos < b.xPos)
				{
					return -1;
				}
				if (a.xPos > b.xPos)
				{
					return 1;
				}
				return 0;
			});

			let page = -1;
			// document.getElementById('displayItemsSection').innerHTML = "";
			displayConfigNameElement.value = displayConfiguration.name
			let htmlText = "";
			for (var itemNo = 0; itemNo < displayConfiguration.items.length; itemNo++)
			{
				const item = displayConfiguration.items[itemNo];
				// const capabilities = {}
				// displayCapabilityItems.push(capabilities);

				if (page != item.page)
				{
					// Insert a page number heading
					if (page >= 0)
					{
						htmlText += `</div></div>`;
					}

					page = item.page;
					htmlText += `<div class="horizontalcontainer"><div class="horizontalgroup"><h2>${Homey.__("settings.page")} ${item.page === 0 ? 'All' : item.page} <div class="tooltip"><i class="fi fi-rr-info"></i><span class="tooltiptext">${Homey.__("settings.pageExplanation")}</span></div></h2>`;
				}

				htmlText += insertDisplayItemSection(item, itemNo, (item.itemId === expandItemId));
			}
			htmlText += `</div></div>`;
			document.getElementById('displayItemsSection').innerHTML = htmlText;

			for (var itemNo = 0; itemNo < displayConfiguration.items.length; itemNo++)
			{
				// Add a 'Default' broker entry to the lists
				var defaultText = Homey.__("settings.default");

				var option = document.createElement("option");
				option.value = 'Default';
				option.text = defaultText;
				document.getElementById(`display${itemNo}BrokerId`).add(option);

				// add the brokers to the display config broker lists
				for (let i = 0; i < localBrokerItems.length; i++)
				{
					const brokerItem = localBrokerItems[i];
					if (brokerItem.enabled)
					{
						var option = document.createElement("option");
						option.value = brokerItem.brokerid;
						option.text = brokerItem.brokerid;
						document.getElementById(`display${itemNo}BrokerId`).add(option);
					}
				}

				const item = displayConfiguration.items[itemNo];
				document.getElementById(`display${itemNo}BrokerId`).value = item.brokerId;

				document.getElementById(`display${itemNo}FontSize`).value = item.fontSize;
				document.getElementById(`display${itemNo}BrokerId`).value = item.brokerId;
				document.getElementById(`display${itemNo}BoxType`).value = item.boxType || 0;
				//				document.getElementById(`display${itemNo}CustomMQTTTopic`).value = item.customMQTTTopic || "";
			}

			fillDisplayDevices();

			for (var itemNo = 0; itemNo < displayConfiguration.items.length; itemNo++)
			{
				const item = displayConfiguration.items[itemNo];

				drawDisplayCustomMQTTTopics(itemNo, item.customMQTTTopics);
			}
		}


		function newDisplayMQTTTopic(Item)
		{
			var displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];
			if (displayConfiguration)
			{
				// Save the current settings
				storeDisplayCustomMQTTItems(Item, displayConfiguration.items[Item].customMQTTTopics);

				var customMQTTItem = {
					id: '',
					type: 0,
					topic: "",
					payload: "",
					brokerId: 'Default',
					enable: true,
				};

				// make sure the customMQTTTopics is an array
				if (!displayConfiguration.items[Item].customMQTTTopics || (Array.isArray(displayConfiguration.items[Item].customMQTTTopics) === false))
				{
					displayConfiguration.items[Item].customMQTTTopics = [];
				}


				displayConfiguration.items[Item].customMQTTTopics.push(customMQTTItem);
				drawDisplayCustomMQTTTopics(Item, displayConfiguration.items[Item].customMQTTTopics);
			}
		};

		/// Custom MQTT code
		function drawDisplayCustomMQTTTopics(Item, Topics)
		{
			if (!Topics || Topics.length === 0) return;

			document.getElementById(`display${Item}CustomMQTTTopicsSection`).innerHTML = "";
			customDisplayMQTTItemsElements = [];

			for (var itemNo = 0; itemNo < Topics.length; itemNo++)
			{
				const topic = Topics[itemNo];
				insertDisplayCustomMQTTTopicSection(topic, itemNo, Item);
			}

			// Set the value for the brokerID in each custom MQTT topics section
			for (var itemNo = 0; itemNo < Topics.length; itemNo++)
			{
				const topic = Topics[itemNo];
				document.getElementById(`display${Item}CustomMQTT${itemNo}BrokerId`).value = topic.brokerId;
			}

			var tooltips = document.querySelectorAll(".tooltip");
			tooltips.forEach(function (tooltip, index)
			{
				// Set a mouse over function for each tooltop element
				tooltip.addEventListener("mouseover", position_tooltip); // On hover, launch the function below
			})
		}

		function insertDisplayCustomMQTTTopicSection(Topic, ItemNo, Item)
		{
			const ctrlLabels = {
				brokerId: Homey.__("settings.brokerId"),
				brokerIdExplanation: Homey.__("settings.brokerIdExplanation"),
				id: Homey.__("settings.MQTTId"),
				idExplanation: Homey.__("settings.MQTTIdExplanation"),
				type: Homey.__("settings.type"),
				typeExplanation: Homey.__("settings.typeExplanation"),
				topic: Homey.__("settings.topic"),
				topicExplanation: Homey.__("settings.topicExplanation"),
				payload: Homey.__("settings.payload"),
				payloadExplanation: Homey.__("settings.payloadExplanation"),
				enabled: Homey.__("settings.enabled"),
				value: Homey.__("settings.value"),
				label: Homey.__("settings.label"),
				unit: Homey.__("settings.unit"),
			};
			const itemLegend = Homey.__("settings.customMQTTItemlegend", { itemNo: ItemNo + 1 });
			const enableOption = Topic.enabled ? "checked" : "";

			var section = document.getElementById(`display${Item}CustomMQTTTopicsSection`).innerHTML;
			section = section +
				`<div class="horizontalcontainer">
					<div class="horizontalgroup">
						<legend class="homey-subtitle">${itemLegend}</legend>

						<label class="homey-form-label" for="display${Item}CustomMQTT${ItemNo}Id">${ctrlLabels.id}
							<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
								<span class="tooltiptext">${ctrlLabels.idExplanation}</span>
							</div>
						</label>
						<input class="homey-form-input" id="display${Item}CustomMQTT${ItemNo}Id" type="text" value="${Topic.id}"/>

						<label class="homey-form-label" for="display${Item}CustomMQTT${ItemNo}Type">${ctrlLabels.type}
							<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
								<span class="tooltiptext">${ctrlLabels.typeExplanation}</span>
							</div>
						</label>
						<select class="homey-form-select" id="display${Item}CustomMQTT${ItemNo}Type">
							<option value=15>${ctrlLabels.value}</option>
							<option value=16>${ctrlLabels.label}</option>
							<option value=17>${ctrlLabels.unit}</option>
						</select><br>

						<label class="homey-form-label" for="display${Item}CustomMQTT${ItemNo}topic">${ctrlLabels.topic}
							<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
								<span class="tooltiptext">${ctrlLabels.topicExplanation}</span>
							</div>
						</label>
						<input class="homey-form-input" id="display${Item}CustomMQTT${ItemNo}topic" type="text" value="${Topic.topic}" />

						<label class="homey-form-label" for="display${Item}CustomMQTT${ItemNo}payload">${ctrlLabels.payload}
							<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
								<span class="tooltiptext">${ctrlLabels.payloadExplanation}</span>
							</div>
						</label>
						<input class="homey-form-input" id="display${Item}CustomMQTT${ItemNo}payload" type="text" value="${Topic.payload}" />

						<label class="homey-form-label" for="display${Item}CustomMQTT${ItemNo}BrokerId">${ctrlLabels.brokerId}
							<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
								<span class="tooltiptext">${ctrlLabels.brokerIdExplanation}</span>
							</div>
						</label>
						<select class="homey-form-select" id="display${Item}CustomMQTT${ItemNo}BrokerId">
						</select><br>

						<label class="homey-form-checkbox">
							<input class="homey-form-checkbox-input" id="display${Item}CustomMQTT${ItemNo}Enabled" type="checkbox" ${enableOption}/>
							<span class="homey-form-checkbox-checkmark"></span>
							<span class="homey-form-checkbox-text">${ctrlLabels.enabled}</span>
						</label>

						<p><button class="homey-button-secondary-shadow" id="display${Item}DeleteItem${ItemNo}" onClick="deleteDisplayCustomMQTTItem(${ItemNo}, ${Item})" style="font-size: 30px;"><i class="fi fi-rr-trash"></i> </button></p>
					</div>
				</div>`;

			document.getElementById(`display${Item}CustomMQTTTopicsSection`).innerHTML = section;
			const idx = customDisplayMQTTItemsElements.push(document.getElementById(`display${Item}CustomMQTT${ItemNo}BrokerId`)) - 1;

			// Add the brokers to the broker list
			var option = document.createElement("option");
			option.text = 'Default';
			option.value = 'Default';
			customDisplayMQTTItemsElements[idx].add(option);

			for (var brokerNo = 0; brokerNo < localBrokerItems.length; brokerNo++)
			{
				const brokerItem = localBrokerItems[brokerNo];
				option = document.createElement("option");
				option.text = brokerItem.brokerid;
				option.value = brokerItem.brokerid;
				customDisplayMQTTItemsElements[idx].add(option);
			}
		}


		// Delete the specified custom item from the display panel configuration and redraw the list
		function deleteDisplayCustomMQTTItem(ItemNo, Item)
		{
			var displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];
			const customMQTTTopics = displayConfiguration.items[Item].customMQTTTopics;

			customMQTTTopics.splice(ItemNo, 1);
			drawDisplayCustomMQTTTopics(Item, customMQTTTopics);
		}

		//  Copy the contents of the specified custom item controls to the display panel configuration
		function storeDisplayCustomMQTTItem(Item, Topics, itemNo)
		{
			if (!Topics)
			{
				Topics = [];
			}

			// Fetch the item from the array or create a new one
			let item = Topics[itemNo];
			if (!item)
			{
				item = {};
				Topics.push(item);
			}

			// Update the item
			item.id = document.getElementById(`display${Item}CustomMQTT${itemNo}Id`).value;
			item.type = document.getElementById(`display${Item}CustomMQTT${itemNo}Type`).value;
			item.topic = document.getElementById(`display${Item}CustomMQTT${itemNo}topic`).value;
			item.payload = document.getElementById(`display${Item}CustomMQTT${itemNo}payload`).value;
			item.brokerId = document.getElementById(`display${Item}CustomMQTT${itemNo}BrokerId`).value;
			item.enabled = document.getElementById(`display${Item}CustomMQTT${itemNo}Enabled`).checked;
		}

		// Copy the contents of the all the custom items controls to the button panel configuration
		function storeDisplayCustomMQTTItems(Item, Topics)
		{
			if (!Topics || Topics.length === 0) return;

			for (var itemNo = 0; itemNo < Topics.length; itemNo++)
			{
				storeDisplayCustomMQTTItem(Item, Topics, itemNo);
			}
		}


		// Add the HTML for the specified display item
		function insertDisplayItemSection(item, itemNo, expanded = false)
		{
			var section = ""; // document.getElementById('displayItemsSection').innerHTML;
			const ctrlLabels = {
				device: Homey.__("settings.device"),
				capability: Homey.__("settings.capability"),
				label: Homey.__("settings.topLabel"),
				text: Homey.__("settings.text"),
				unit: Homey.__("settings.unit"),
				xPos: Homey.__("settings.xPos"),
				yPos: Homey.__("settings.yPos"),
				width: Homey.__("settings.width"),
				rounding: Homey.__("settings.rounding"),
				fontSize: Homey.__("settings.fontSize"),
				deleteItem: Homey.__("settings.deleteItem"),
				brokerId: Homey.__("settings.brokerId"),
				page: Homey.__("settings.page"),
				boxType: Homey.__("settings.boxType"),
				customMQTTTopic: Homey.__("settings.customMQTTTopic"),
				newCustomMQTTItem: Homey.__("settings.newCustomMQTTItem"),
			}
			const ctrlExplanations = {
				device: Homey.__("settings.deviceDExplanation"),
				capability: Homey.__("settings.capabilityDExplanation"),
				label: Homey.__("settings.toplabelDisplayExplanation"),
				text: Homey.__("settings.textExplanation"),
				unit: Homey.__("settings.unitExplanation"),
				xPos: Homey.__("settings.xPosExplanation"),
				yPos: Homey.__("settings.yPosExplanation"),
				width: Homey.__("settings.widthExplanation"),
				rounding: Homey.__("settings.roundingExplanation"),
				fontSize: Homey.__("settings.fontSizeExplanation"),
				deleteItem: Homey.__("settings.deleteItemExplanation"),
				brokerId: Homey.__("settings.brokerIdExplanation"),
				page: Homey.__("settings.pageExplanation"),
				boxType: Homey.__("settings.boxTypeExplanation"),
				customMQTTTopic: Homey.__("settings.customMQTTTopicExplanation"),
			}
			const itemLegend = Homey.__("settings.displayItemlegend", { itemNo: itemNo + 1 });
			const itemLegendName = item.label ? item.label : (item.device === 'none' ? item.text : item.capabilityName);
			const underlined = Homey.__("settings.boxTypeUnderlined");
			const notUnderlined = Homey.__("settings.boxTypeNotUnderlined");

			if (typeof item.page === 'undefined')
			{
				item.page = 0;
			}

			section = section +
				`<div class="horizontalcontainer">
					<div class="horizontalgroup">
						<details ${expanded ? 'open' : ''}>
							<summary class="summary">
								<legend class="homey-subtitle" id="display${itemNo}Legend"><b><em>${itemLegend}</em></b> - ${itemLegendName}: X:${item.xPos}, Y:${item.yPos}, W:${item.width}</legend>
								<span class="icon" style='font-size:30px;'>&#8628;</span>
							</summary>
							<hr>
							<label class="homey-form-label" for="display${itemNo}page">${ctrlLabels.page}
								<div class="tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlExplanations.page}</span>
								</div>
							</label>
							<input class="homey-form-input" id="display${itemNo}page" onChange="redisplayDisplyConfig(${itemNo})" type="number" value="${item.page}" />
							<label class="homey-form-label" for="display${itemNo}Device">${ctrlLabels.device}
								<div class="tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlExplanations.device}</span>
								</div>
							</label>
							<select class="homey-form-select" id="display${itemNo}Device" onChange="getDisplayCapabilities(${itemNo})">
							</select>
							<div id="display${itemNo}CapabilityDiv">
								<br>
								<label class="homey-form-label" for="display${itemNo}Capability">${ctrlLabels.capability}
									<div class="tooltip"><i class="fi fi-rr-info"></i>
										<span class="tooltiptext">${ctrlExplanations.capability}</span>
									</div>
								</label>
								<select class="homey-form-select" id="display${itemNo}Capability" onChange="selectDisplayCapability(this, ${itemNo})">
								</select>
							</div>
							<div id="display${itemNo}CustomMQTTTopicDiv">
								<br>
								<div id="display${itemNo}CustomMQTTTopicsSection"></div>
								<p><button class="homey-button-secondary-shadow" id="newDisplayCustomMQTTItem" onClick="newDisplayMQTTTopic(${itemNo})">${ctrlLabels.newCustomMQTTItem}</button></p>
							</div>
							<br>
							<label class="homey-form-label" for="display${itemNo}Label">${ctrlLabels.label}
								<div class="tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlExplanations.label}</span>
								</div>
							</label>
							<input class="homey-form-input" id="display${itemNo}Label" type="text" oninput="onDisplayLabelChange(this, ${itemNo})" value="${item.label}" />
							<div id="display${itemNo}UnitDiv">
								<label class="homey-form-label" for="display${itemNo}Unit">${ctrlLabels.unit}
									<div class="tooltip"><i class="fi fi-rr-info"></i>
										<span class="tooltiptext">${ctrlExplanations.unit}</span>
									</div>
								</label>
								<input class="homey-form-input" id="display${itemNo}Unit" type="text" value="${item.unit}" />
							</div>
							<div id="display${itemNo}TextDiv">
								<label class="homey-form-label" for="display${itemNo}Text">${ctrlLabels.text}
									<div class="tooltip"><i class="fi fi-rr-info"></i>
										<span class="tooltiptext">${ctrlExplanations.text}</span>
									</div>
								</label>
								<input class="homey-form-input" id="display${itemNo}Text" type="text" oninput="onDisplayLabelChange(this, ${itemNo})" value="${item.text}" />
							</div>
							<label class="homey-form-label" for="display${itemNo}X">${ctrlLabels.xPos}
								<div class="tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlExplanations.xPos}</span>
								</div>
							</label>
							<input class="homey-form-input" id="display${itemNo}X" onChange="redisplayDisplyConfig(${itemNo})" type="number" value="${item.xPos}" />
							<label class="homey-form-label" for="display${itemNo}Y">${ctrlLabels.yPos}
								<div class="tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlExplanations.yPos}</span>
								</div>
							</label>
							<input class="homey-form-input" id="display${itemNo}Y" onChange="redisplayDisplyConfig(${itemNo})" type="number" value="${item.yPos}" />
							<label class="homey-form-label" for="display${itemNo}Width">${ctrlLabels.width}
								<div class="tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlExplanations.width}</span>
								</div>
							</label>
							<input class="homey-form-input" id="display${itemNo}Width" type="number" value="${item.width}" />
							<label class="homey-form-label" for="display${itemNo}Rounding">${ctrlLabels.rounding}
								<div class="tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlExplanations.rounding}</span>
								</div>
							</label>
							<input class="homey-form-input" id="display${itemNo}Rounding" type="number" value="${item.rounding || 0}" />
							<label class="homey-form-label" for="display${itemNo}FontSize">${ctrlLabels.fontSize}
								<div class="tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlExplanations.fontSize}</span>
								</div>
							</label>
							<select class="homey-form-select" id="display${itemNo}FontSize">
								<option value=1>1</option>
								<option value=2>2</option>
								<option value=3>3</option>
								<option value=4>4</option>
								<option value=5>5</option>
							</select>
							<label class="homey-form-label" for="display${itemNo}BoxType">${ctrlLabels.boxType}
								<div class="tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlExplanations.boxType}</span>
								</div>
							</label>
							<select class="homey-form-select" id="display${itemNo}BoxType">
								<option value=0>${underlined}</option>
								<option value=1>${notUnderlined}</option>
							</select>
							<label class="homey-form-label" for="display${itemNo}BrokerId">${ctrlLabels.brokerId}
								<div class="tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlExplanations.brokerId}</span>
								</div>
							</label>
							<select class="homey-form-select" id="display${itemNo}BrokerId">
							</select>
							<br>
							<p><button class="homey-button-secondary-shadow" id="deleteItem" onClick="deleteItem(${itemNo})" style="font-size: 30px;"><i class="fi fi-rr-trash"></i> </button></p>
						</details>
					</div>
				</div>`;

			// document.getElementById('displayItemsSection').innerHTML = section;
			return section;
		}

		function scrollToTop(element)
		{
			// setTimeout(function()
			// {
			//     var fixedTopHeight = document.querySelector('.fixedTop').offsetHeight; // Get the height of the fixedTop div
			//     window.scrollTo(0, element.offsetTop - fixedTopHeight);
			// }, 100);
		}

		// Ensure that the display item's legend is always up-to-date with the latest label, position, and size values.
		function onDisplayLabelChange(element, itemNo)
		{
			let newLabel = element.value;
			if (element.id === `display${itemNo}Text`)
			{
				// Only use the text if the label is empty
				const label = document.getElementById(`display${itemNo}Label`).value;
				const device = document.getElementById(`display${itemNo}Device`).value;

				// Only use this if the label is empty
				if ((label !== '') || (device !== 'none'))
				{
					return;
				}
			}
			else
			{
				if (element.id !== `display${itemNo}Label`)
				{
					newLabel = document.getElementById(`display${itemNo}Label`).value;
				}

				if (newLabel === '')
				{
					// As the label is now empty, set the text to the text or capability name
					const device = document.getElementById(`display${itemNo}Device`).value;
					if (device === 'none')
					{
						newLabel = document.getElementById(`display${itemNo}Text`).value;
					}
					else
					{
						const capability = document.getElementById(`display${itemNo}Capability`).value;
						const capabilityElement = document.getElementById(`display${itemNo}Capability`);
						newLabel = capabilityElement.options && capabilityElement.options.length > 0 ? capabilityElement.options[capabilityElement.selectedIndex].text : device;
					}
				}
			}

			const x = document.getElementById(`display${itemNo}X`).value;
			const y = document.getElementById(`display${itemNo}Y`).value;
			const width = document.getElementById(`display${itemNo}Width`).value;

			document.getElementById(`display${itemNo}Legend`).innerHTML = `<b><em>${Homey.__("settings.displayItemlegend", { itemNo: itemNo + 1 })}</em></b> - ${newLabel}: X:${x}, Y:${y}, W:${width}`;
		}

		function makeSummarySticky()
		{
			var summaries = document.querySelectorAll('.summary');
			var lastStickySummary = null;
			var lastSummary = null;
			var fixedTopHeight = document.querySelector('.fixedTop').offsetHeight; // Get the height of the fixedTop div
			var lastTop = 0;

			summaries.forEach(function (summary)
			{
				var rect = summary.getBoundingClientRect();
				if (rect.height !== 0)
				{
					if (lastTop <= fixedTopHeight && rect.top > fixedTopHeight)
					{
						lastStickySummary = lastSummary;
					}

					lastSummary = summary;
					lastTop = rect.top;
				}
			});

			if (lastStickySummary == null)
			{
				lastStickySummary = lastSummary;
			}

			summaries.forEach(function (summary)
			{
				if (summary === lastStickySummary)
				{
					summary.classList.add('summary-sticky');
					summary.style.top = fixedTopHeight + 'px'; // Set the top of the summary div to the height of the fixedTop div
				}
				else
				{
					summary.classList.remove('summary-sticky');
				}
			});
		}

		window.addEventListener("scroll", makeSummarySticky);

		// if the display configuration has been fetched, update the display controls
		function fillDisplayDevices()
		{
			if (displayDevicesFetched)
			{
				// Get the current display configuration
				var displayConfig = localDisplayConfigurations[displayConfigurationNoElement.value];

				if (displayConfig)
				{
					for (var itemNo = 0; itemNo < displayConfig.items.length; itemNo++)
					{
						fillDevicesElement(document.getElementById(`display${itemNo}Device`), displayDevicesArray);
						document.getElementById(`display${itemNo}Device`).value = displayConfig.items[itemNo].device;
						getDisplayCapabilities(itemNo);
					}
				}
			}
		}

		function fillDisplayVariablesElement(item, capabilityElement, selectedVariable, selectedVariableName)
		{
			for (const variable of variablesArray)
			{
				var option = document.createElement("option");
				option.text = variable.name;
				option.value = variable.id;
				capabilityElement.add(option);
			}

			// Restore the previous variable selection
			capabilityElement.value = selectedVariable;
			if (capabilityElement.value !== selectedVariable)
			{
				// The variable must be missing, so add it to the list
				var option = document.createElement("option");
				option.text = selectedVariableName + " (Missing)";
				option.value = selectedVariable;
				capabilityElement.add(option);

				capabilityElement.value = selectedVariable;
			}
		}

		function getDisplayCapabilities(itemNo)
		{
			var deviceId = document.getElementById(`display${itemNo}Device`).value;
			var capabilitiesElement = document.getElementById(`display${itemNo}Capability`);
			capabilitiesElement.innerHTML = "";

			if (deviceId === 'customMQTT')
			{
				document.getElementById(`display${itemNo}CustomMQTTTopicDiv`).style.display = itemDisplyType;
			}
			else
			{
				document.getElementById(`display${itemNo}CustomMQTTTopicDiv`).style.display = "none";
			}

			if (deviceId === 'customMQTT' || deviceId === 'none')
			{
				document.getElementById(`display${itemNo}CapabilityDiv`).style.display = "none";
				document.getElementById(`display${itemNo}UnitDiv`).style.display = "none";
				document.getElementById(`display${itemNo}TextDiv`).style.display = itemDisplyType;
				onDisplayLabelChange({ id: `display${itemNo}Device`, value: '' }, itemNo);
				return;
			}

			if (deviceId === '_variable_')
			{
				document.getElementById(`display${itemNo}CapabilityDiv`).style.display = itemDisplyType;
				document.getElementById(`display${itemNo}UnitDiv`).style.display = itemDisplyType;
				document.getElementById(`display${itemNo}TextDiv`).style.display = "none";

				var selectedVariable = '';
				var displayConfig = localDisplayConfigurations[displayConfigurationNoElement.value];
				if (displayConfig)
				{
					selectedVariable = displayConfig.items[itemNo].capability;
					selectedVariableName = displayConfig.items[itemNo].capabilityName;
				}

				if (variablesFetched)
				{
					// Add each of the variables to the item drop list
					fillDisplayVariablesElement(itemNo, capabilitiesElement, selectedVariable, selectedVariableName);
				}
				else
				{
					// Resquest the list of variables
					Homey.api('POST', '/get_variables/', {}, function (err, variables)
					{
						if (err) return Homey.alert(err);

						if (variables)
						{
							// Add each of the variables to the item drop list
							variablesArray = Object.values(variables);
							variablesFetched = true;
							fillDisplayVariablesElement(itemNo, capabilitiesElement, selectedVariable, selectedVariableName);
						}
					});
				}

				return;
			}

			const capabilities = displayCapabilityItems.get(deviceId);
			if (capabilities)
			{
				fillDisplayCapabilitiesElement(itemNo, capabilitiesElement, capabilities);
			}
			else
			{
				// Resquest the list of capabilities
				Homey.api('POST', '/device_capabilities/', { deviceId }, function (err, capabilities)
				{
					if (err) return Homey.alert(err);

					if (capabilities)
					{
						displayCapabilityItems.set(deviceId, capabilities);
						fillDisplayCapabilitiesElement(itemNo, capabilitiesElement, capabilities);
					}
				});
			}
		}

		function fillDisplayCapabilitiesElement(itemNo, capabilitiesElement, capabilities)
		{
			const capabilitiesArray = Object.values(capabilities);
			for (const capability of capabilitiesArray)
			{
				var option = document.createElement("option");
				option.text = `${capability.title} (${capability.id})`;
				option.value = capability.id;
				capabilitiesElement.add(option);
			}

			document.getElementById(`display${itemNo}CapabilityDiv`).style.display = itemDisplyType;
			document.getElementById(`display${itemNo}UnitDiv`).style.display = itemDisplyType;
			document.getElementById(`display${itemNo}TextDiv`).style.display = "none";

			var displayConfig = localDisplayConfigurations[displayConfigurationNoElement.value];
			if (displayConfig)
			{
				const capabilityID = displayConfig.items[itemNo].capability;
				if (capabilities[capabilityID])
				{
					if (document.getElementById(`display${itemNo}Unit`).value === '')
					{
						document.getElementById(`display${itemNo}Unit`).value = capabilities[capabilityID].unit ? capabilities[capabilityID].unit : "";
					}
				}
				else
				{
					// The capability must be missing, so add it to the list
					var option = document.createElement("option");
					option.text = capabilityID + " (Missing)";
					option.value = capabilityID;
					capabilitiesElement.add(option);
				}

				capabilitiesElement.value = capabilityID;
			}
		}

		function selectDisplayCapability(Element, itemNo)
		{
			// var capabilities = null;
			// if (displayCapabilityItems[itemNo].capabilities)
			// {
			// 	capabilities = displayCapabilityItems[itemNo].capabilities
			// }
			// else
			// {
			// 	capabilities = variablesArray
			// }

			// var capabilityID = Element.value;
			// if (capabilityID != "" && capabilities[capabilityID])
			// {
			// 	document.getElementById(`display${itemNo}Unit`).value = capabilities[capabilityID].units ? capabilities[capabilityID].units : "";
			// }

			onDisplayLabelChange({ id: Element.id, value: '' }, itemNo);
		}

		function deleteItem(itemNo)
		{
			// Save all the settings so they don't get lost when the controls are redawn
			storeDisplaySettings();

			var displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];

			if (displayConfiguration != null)
			{
				displayConfiguration.items.splice(itemNo, 1);
				drawDisplayConfiguration(displayConfiguration);
			}
		}

		function storeDisplaySettings()
		{
			var displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];

			if (displayConfiguration != null)
			{
				displayConfiguration.version = 2;
				displayConfiguration.name = displayConfigNameElement.value;

				for (var itemNo = 0; itemNo < displayConfiguration.items.length; itemNo++)
				{
					const deviceElement = document.getElementById(`display${itemNo}Device`);

					displayConfiguration.items[itemNo].device = deviceElement.value;
					if (deviceElement.selectedIndex >= 0)
					{
						displayConfiguration.items[itemNo].deviceName = deviceElement.options[deviceElement.selectedIndex].text;

						// Remove ' (Missing Devices)' from the device name
						displayConfiguration.items[itemNo].deviceName = displayConfiguration.items[itemNo].deviceName.replace(/ \(Missing Devices\)/g, '');
					}
					else
					{
						displayConfiguration.items[itemNo].deviceName = "";
					}

					displayConfiguration.items[itemNo].capability = document.getElementById(`display${itemNo}Capability`).value;
					if (document.getElementById(`display${itemNo}Capability`).selectedIndex >= 0)
					{
						displayConfiguration.items[itemNo].capabilityName = document.getElementById(`display${itemNo}Capability`).options[document.getElementById(`display${itemNo}Capability`).selectedIndex].text;

						// Remove ' (Missing)' from the capability name
						displayConfiguration.items[itemNo].capabilityName = displayConfiguration.items[itemNo].capabilityName.replace(/ \(Missing\)/g, '');
					}
					else
					{
						displayConfiguration.items[itemNo].capabilityName = "";
					}
					displayConfiguration.items[itemNo].label = document.getElementById(`display${itemNo}Label`).value;
					displayConfiguration.items[itemNo].unit = document.getElementById(`display${itemNo}Unit`).value;
					displayConfiguration.items[itemNo].text = document.getElementById(`display${itemNo}Text`).value;
					displayConfiguration.items[itemNo].xPos = document.getElementById(`display${itemNo}X`).value;
					displayConfiguration.items[itemNo].yPos = document.getElementById(`display${itemNo}Y`).value;
					displayConfiguration.items[itemNo].width = document.getElementById(`display${itemNo}Width`).value;
					displayConfiguration.items[itemNo].rounding = document.getElementById(`display${itemNo}Rounding`).value;
					displayConfiguration.items[itemNo].fontSize = document.getElementById(`display${itemNo}FontSize`).value;
					displayConfiguration.items[itemNo].brokerId = document.getElementById(`display${itemNo}BrokerId`).value;
					displayConfiguration.items[itemNo].page = document.getElementById(`display${itemNo}page`).value;
					displayConfiguration.items[itemNo].boxType = document.getElementById(`display${itemNo}BoxType`).value;

					storeDisplayCustomMQTTItems(itemNo, displayConfiguration.items[itemNo].customMQTTTopics);
				}
			}
		}

		/// Broker Config code
		function drawBrokerItems()
		{
			document.getElementById('brokerItemsSection').innerHTML = "";
			for (var itemNo = 0; itemNo < localBrokerItems.length; itemNo++)
			{
				const item = localBrokerItems[itemNo];
				insertBrokerItemSection(item, itemNo);
			}
		}

		function insertBrokerItemSection(item, itemNo, expanded = false)
		{
			const ctrlLabels = {
				id: Homey.__("settings.id"),
				address: Homey.__("settings.address"),
				port: Homey.__("settings.port"),
				wsPort: Homey.__("settings.wsPort"),
				enabled: Homey.__("settings.enabled"),
				username: Homey.__("settings.username"),
				password: Homey.__("settings.password"),
				idExplanation: Homey.__("settings.idExplanation"),
				addressExplanation: Homey.__("settings.addressExplanation"),
				portExplanation: Homey.__("settings.portExplanation"),
				wsPortExplanation: Homey.__("settings.wsPortExplanation"),
				enabledExplanation: Homey.__("settings.enabledExplanation"),
				usernameExplanation: Homey.__("settings.usernameExplanation"),
				passwordExplanation: Homey.__("settings.passwordExplanation"),
			};
			const itemLegend = Homey.__("settings.brokerItemlegend", { itemNo: itemNo + 1 });
			const protected = item.protected ? "disabled" : "";
			const enableOption = item.enabled ? "checked" : "";
			let deleteButton = "";
			if (!item.protected)
			{
				deleteButton = `<p><button class="homey-button-secondary-shadow" id="deleteBrokerItem${itemNo}" onClick="deleteBrokerItem(${itemNo})" style="font-size: 30px;"><i class="fi fi-rr-trash"></i> </button></p>`;
			}

			let brokerDescription = "";
			if (item.brokerid === "homey")
			{
				brokerDescription = Homey.__("settings.brokerHomey");
				ctrlLabels.passwordExplanation = Homey.__("settings.homeyPasswordExplanation");
				ctrlLabels.usernameExplanation = Homey.__("settings.homeyUsernameExplanation");
			}
			else if (item.brokerid === "buttonplus")
			{
				brokerDescription = Homey.__("settings.brokerButtonPlus");
			}
			else
			{
				brokerDescription = Homey.__("settings.brokerUser");
			}

			var section = document.getElementById('brokerItemsSection').innerHTML;
			section = section +
				`<div class="horizontalcontainer">
					<div class="horizontalgroup">
						<details ${expanded ? 'open' : ''}>
							<summary class="summary">
								<legend class="homey-subtitle" id="broker${itemNo}Legend"><b><em>${itemLegend}</em></b> - ${item.brokerid}</legend>
								<span class="icon" style='font-size:30px;'>&#8628;</span>
							</summary>
							<hr>
							<p>${brokerDescription}</p>

							<label class="homey-form-label" for="broker${itemNo}Id">${ctrlLabels.id}
								<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlLabels.idExplanation}</span>
								</div>
							</label>
							<input class="homey-form-input" id="broker${itemNo}Id" type="text" value="${item.brokerid}" ${protected} onChange="updateBrokerLists(${itemNo})" oninput="onBrokerLabelChange(this, ${itemNo})"/>

							<label class="homey-form-label" for="broker${itemNo}Address">${ctrlLabels.address}
								<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlLabels.addressExplanation}</span>
								</div>
							</label>
							<input class="homey-form-input" id="broker${itemNo}Address" type="text" value="${item.url}" ${protected} />

							<label class="homey-form-label" for="broker${itemNo}Port">${ctrlLabels.port}
								<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlLabels.portExplanation}</span>
								</div>
							</label>
							<input class="homey-form-input" id="broker${itemNo}Port" type="number" value="${item.port}" />

							<label class="homey-form-label" for="broker${itemNo}WSPort">${ctrlLabels.wsPort}
								<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlLabels.wsPortExplanation}</span>
								</div>
							</label>
							<input class="homey-form-input" id="broker${itemNo}WSPort" type="number" value="${item.wsport}" />

							<label class="homey-form-label" for="broker${itemNo}Username">${ctrlLabels.username}
								<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlLabels.usernameExplanation}</span>
								</div>
							</label>
							<input class="homey-form-input" id="broker${itemNo}Username" type="text" value="${item.username ? item.username : ""}""/>

							<label class="homey-form-label" for="broker${itemNo}Password">${ctrlLabels.password}
								<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlLabels.passwordExplanation}</span>
								</div>
							</label>
							<input class="homey-form-input" id="broker${itemNo}Password" type="text" value="${item.password ? item.password : ""}""/>

							<label class="homey-form-checkbox">
								<input class="homey-form-checkbox-input" id="broker${itemNo}Enabled" onClick="rebuildBrokerLists(${itemNo})" type="checkbox" ${enableOption}/>
								<span class="homey-form-checkbox-checkmark"></span>
								<span class="homey-form-checkbox-text">${ctrlLabels.enabled}</span>
								<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlLabels.enabledExplanation}</span>
								</div>
							</label>

							${deleteButton}
						</details>
					</div>
				</div>`;

			document.getElementById('brokerItemsSection').innerHTML = section;
		}

		function onBrokerLabelChange(element, itemNo)
		{
			document.getElementById(`broker${itemNo}Legend`).innerHTML = `<b><em>${Homey.__("settings.brokerItemlegend", { itemNo: itemNo + 1 })}</em></b> - ${element.value}`;
		}

		function updateBrokerLists(itemNo)
		{
			// Get the current button configuration
			const buttonConfig = localButtonConfigurations[currentButtonConfigurationNo];

			// if buttonConfig is and array then the number of pages is the length of the array else it is 1
			const numberOfPages = Array.isArray(buttonConfig) ? buttonConfig.length : 1;
			for (let page = 0; page < numberOfPages; page++)
			{
				updateBrokerListSection(itemNo, 'left', page);
				updateBrokerListSection(itemNo, 'right', page);
			}

			// Update the default broker list
			defaultBrokerElement.options[itemNo].text = document.getElementById(`broker${itemNo}Id`).value;

			// Update the broker in the all the custom MQTT topics in the panel config
			for (let k = 0; k < customMQTTItemsElements.length; k++)
			{
				customMQTTItemsElements[k].options[itemNo].text = document.getElementById(`broker${itemNo}Id`).value;
			}

			// Update the broker in the all the custom disply MQTT topics in the panel config
			for (let k = 0; k < customDisplayMQTTItemsElements.length; k++)
			{
				customDisplayMQTTItemsElements[k].options[itemNo].text = document.getElementById(`broker${itemNo}Id`).value;
			}

			// Update the broker lists in the display config
			const displayConfig = localDisplayConfigurations[currentDisplayConfigurationNo];
			for (var displayItemNo = 0; displayItemNo < displayConfig.items.length; displayItemNo++)
			{
				const brokerIdElement = document.getElementById(`display${displayItemNo}BrokerId`);
				brokerIdElement.options[itemNo].text = document.getElementById(`broker${itemNo}Id`).value;
			}
		}

		function updateBrokerListSection(itemNo, side, page)
		{
			// Update the broker in the left and right broker list in the panel config
			const brokerIdElement = document.getElementById(`${side}${page}BrokerId`);
			brokerIdElement.options[itemNo].text = document.getElementById(`broker${itemNo}Id`).value;
		}

		function deleteBrokerItem(itemNo)
		{
			if (localBrokerItems.length > 2 && !localBrokerItems[itemNo].protected)
			{
				localBrokerItems.splice(itemNo, 1);
				drawBrokerItems();

				// Remove from the default broker list
				defaultBrokerElement.remove(itemNo);

				// Remove the broker from the broker list in the panel and display config
				removeBrokerFromConfig(itemNo);
			}
			else
			{
				Homey.alert(Homey.__("settings.deleteBrokerItemError"));
			}
		}

		function rebuildBrokerLists(itemNo)
		{
			const enabled = document.getElementById(`broker${itemNo}Enabled`).checked;
			localBrokerItems[itemNo].enabled = enabled;

			// Fetch current settings so we can restore them after the rebuild
			// Get the current configuration
			const buttonConfig = localButtonConfigurations[currentButtonConfigurationNo];

			// if buttonConfig is and array then the number of pages is the length of the array else it is 1
			const numberOfPages = buttonConfig.length;
			for (let page = 0; page < numberOfPages; page++)
			{
				// get the broker element
				const leftBrokerIdElement = document.getElementById(`left${page}BrokerId`);
				const rightBrokerIdElement = document.getElementById(`right${page}BrokerId`);

				buttonConfig[page].leftBrokerId = leftBrokerIdElement.value;
				buttonConfig[page].rightBrokerId = rightBrokerIdElement.value;

				// reset the broker lists in all the config items
				leftBrokerIdElement.length = 0;
				rightBrokerIdElement.length = 0;
			}

			for (let k = 0; k < customMQTTItemsElements.length; k++)
			{
				customMQTTItemsElements[k].length = 0;
			}

			for (let k = 0; k < customDisplayMQTTItemsElements.length; k++)
			{
				customDisplayMQTTItemsElements[k].length = 0;
			}

			// Reset the default broker list
			const defaultBrokerItem = defaultBrokerElement.value;
			defaultBrokerElement.length = 0;

			const displayConfig = localDisplayConfigurations[currentDisplayConfigurationNo];
			for (let displayItemNo = 0; displayItemNo < displayConfig.items.length; displayItemNo++)
			{
				const displayItem = displayConfig.items[displayItemNo];
				const brokerIdElement = document.getElementById(`display${displayItemNo}BrokerId`);
				displayItem.brokerId = brokerIdElement.value;

				brokerIdElement.length = 0;
			}

			// Add a 'Default' broker entry to the lists
			var defaultText = Homey.__("settings.default");

			for (let page = 0; page < numberOfPages; page++)
			{
				// get the broker element
				const leftBrokerIdElement = document.getElementById(`left${page}BrokerId`);
				const rightBrokerIdElement = document.getElementById(`right${page}BrokerId`);

				var option = document.createElement("option");
				option.value = 'Default';
				option.text = defaultText;
				leftBrokerIdElement.add(option);

				var option = document.createElement("option");
				option.value = 'Default';
				option.text = defaultText;
				rightBrokerIdElement.add(option);
			}

			// Add the brokers to the broker list in the panel and display config
			for (var itemNo = 0; itemNo < localBrokerItems.length; itemNo++)
			{
				// Add the broker to the broker list in the panel and display config
				var brokerItem = localBrokerItems[itemNo];
				if (brokerItem.enabled)
				{
					addBrokerToConfig(brokerItem);
				}
			}

			for (let page = 0; page < numberOfPages; page++)
			{
				// get the broker element
				const leftBrokerIdElement = document.getElementById(`left${page}BrokerId`);
				const rightBrokerIdElement = document.getElementById(`right${page}BrokerId`);

				// select the broker in the broker list in the panel and display config
				leftBrokerIdElement.value = buttonConfig[page].leftBrokerId;
				rightBrokerIdElement.value = buttonConfig[page].rightBrokerId;
			}

			for (let displayItemNo = 0; displayItemNo < displayConfig.items.length; displayItemNo++)
			{
				var optionDisplay = document.createElement("option");
				optionDisplay.value = 'Default';
				optionDisplay.text = defaultText;
				document.getElementById(`display${displayItemNo}BrokerId`).add(optionDisplay);
				const displayItem = displayConfig.items[displayItemNo];
				const brokerIdElement = document.getElementById(`display${displayItemNo}BrokerId`);
				brokerIdElement.value = displayItem.brokerId;
			}
		}

		function addBrokerToConfig(brokerItem, numberOfPages)
		{
			// Add the new broker to the default broker list
			var option = document.createElement("option");
			option.value = brokerItem.brokerid;
			option.text = brokerItem.brokerid;
			defaultBrokerElement.add(option);

			for (let page = 0; page < numberOfPages; page++)
			{
				// get the broker element
				const leftBrokerIdElement = document.getElementById(`left${page}BrokerId`);
				const rightBrokerIdElement = document.getElementById(`right${page}BrokerId`);

				// Add the new broker to the panel config broker lists
				var optionLeft = document.createElement("option");
				optionLeft.value = brokerItem.brokerid;
				optionLeft.text = brokerItem.brokerid;
				leftBrokerIdElement.add(optionLeft);

				var optionRight = document.createElement("option");
				optionRight.value = brokerItem.brokerid;
				optionRight.text = brokerItem.brokerid;
				rightBrokerIdElement.add(optionRight);
			}

			// Add the new broker to the custom MQTT topic broker lists
			for (let k = 0; k < customMQTTItemsElements.length; k++)
			{
				var option = document.createElement("option");
				option.value = brokerItem.brokerid;
				option.text = brokerItem.brokerid;
				customMQTTItemsElements[k].add(option);
			}

			// Add the new broker to the custom display MQTT topic broker lists
			for (let k = 0; k < customDisplayMQTTItemsElements.length; k++)
			{
				var option = document.createElement("option");
				option.value = brokerItem.brokerid;
				option.text = brokerItem.brokerid;
				customDisplayMQTTItemsElements[k].add(option);
			}

			// Add the new broker to the display config broker lists
			const displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];
			for (let j = 0; j < displayConfiguration.items.length; j++)
			{
				const displayItem = displayConfiguration.items[j];
				var option = document.createElement("option");
				option.value = brokerItem.brokerid;
				option.text = brokerItem.brokerid;
				let brokerIdElement = document.getElementById(`display${j}BrokerId`);
				brokerIdElement.add(option);
			}
		}

		function removeBrokerFromConfig(itemNo)
		{
			// Get the current configuration
			var buttonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];

			// if localButtonConfigurations is an array, then set numPage to the length of the array otherwise set numPage to 1
			var numPages = Array.isArray(buttonPanelConfiguration) ? buttonPanelConfiguration.length : 1;

			for (page = 0; page < numPages; page++)
			{
				// Remove the broker from the left and right broker list in the panel config
				const leftBrokerIdElement = document.getElementById(`left${page}BrokerId`);
				leftBrokerIdElement.remove(itemNo);

				const rightBrokerIdElement = document.getElementById(`right${page}BrokerId`);
				rightBrokerIdElement.remove(itemNo);
			}

			// Remove the broker from the all the custom MQTT topics in the panel config
			for (let k = 0; k < customMQTTItemsElements.length; k++)
			{
				customMQTTItemsElements[k].remove(itemNo);
			}

			// Remove the broker from the all the custom display MQTT topics in the panel config
			for (let k = 0; k < customDisplayMQTTItemsElements.length; k++)
			{
				customDisplayMQTTItemsElements[k].remove(itemNo);
			}

			// Remove the broker from all the lists in the display config items
			const displayConfig = localDisplayConfigurations[currentDisplayConfigurationNo];
			for (var displayItemNo = 0; displayItemNo < displayConfig.items.length; displayItemNo++)
			{
				const item = displayConfig.items[displayItemNo];
				const brokerIdElement = document.getElementById(`display${displayItemNo}BrokerId`);
				brokerIdElement.remove(itemNo);
			}

			defaultBrokerElement.remove(itemNo);
		}

		function storeBrokerSettings()
		{
			let oneEnabled = false;
			for (var itemNo = 0; itemNo < localBrokerItems.length; itemNo++)
			{
				// Make sure there isn't already a broker with this id
				newBrokerid = document.getElementById(`broker${itemNo}Id`).value;

				for (var itemNo2 = 0; itemNo2 < itemNo; itemNo2++)
				{
					if (newBrokerid.toUpperCase() === localBrokerItems[itemNo2].brokerid.toUpperCase())
					{
						Homey.alert(Homey.__("settings.duplicateBrokerIdError", { brokerId: newBrokerid }));
						return false;
					}
				}

				const enabled = document.getElementById(`broker${itemNo}Enabled`).checked;
				if (enabled)
				{
					oneEnabled = true;
				}
				localBrokerItems[itemNo].enabled = enabled;
				localBrokerItems[itemNo].brokerid = newBrokerid;
				localBrokerItems[itemNo].url = document.getElementById(`broker${itemNo}Address`).value;
				localBrokerItems[itemNo].port = document.getElementById(`broker${itemNo}Port`).value;
				localBrokerItems[itemNo].wsport = document.getElementById(`broker${itemNo}WSPort`).value;

				const username = document.getElementById(`broker${itemNo}Username`).value;
				const password = document.getElementById(`broker${itemNo}Password`).value;
				if (!username && password)
				{
					Homey.alert(Homey.__("settings.passwordError1"));
					return false;
				}
				localBrokerItems[itemNo].username = username;
				localBrokerItems[itemNo].password = password;
			}

			if (!oneEnabled)
			{
				Homey.alert(Homey.__("settings.noEnabledBrokerError"));
				return false;
			}
			return oneEnabled;
		}

		/// Custom MQTT code
		function drawCustomMQTTTopics(side, page, buttonPanelConfiguration)
		{
			document.getElementById(`${side}${page}CustomMQTTTopicsSection`).innerHTML = "";
			customMQTTItemsElements = [];

			const customMQTTTopics = buttonPanelConfiguration[`${side}CustomMQTTTopics`];

			for (var itemNo = 0; itemNo < customMQTTTopics.length; itemNo++)
			{
				const topic = customMQTTTopics[itemNo];
				insertCustomMQTTTopicSection(topic, itemNo, side);
			}

			// Set the value for the brokerID in each custom MQTT topics section
			for (var itemNo = 0; itemNo < customMQTTTopics.length; itemNo++)
			{
				const topic = customMQTTTopics[itemNo];
				document.getElementById(`${side}${page}CustomMQTT${itemNo}BrokerId`).value = topic.brokerId;
			}

			var tooltips = document.querySelectorAll(".tooltip");
			tooltips.forEach(function (tooltip, index)
			{
				// Set a mouse over function for each tooltop element
				tooltip.addEventListener("mouseover", position_tooltip); // On hover, launch the function below
			})
		}

		function insertCustomMQTTTopicSection(Topic, ItemNo, Side)
		{
			const ctrlLabels = {
				brokerId: Homey.__("settings.brokerId"),
				brokerIdExplanation: Homey.__("settings.brokerIdExplanation"),
				id: Homey.__("settings.MQTTId"),
				idExplanation: Homey.__("settings.MQTTIdExplanation"),
				type: Homey.__("settings.type"),
				typeExplanation: Homey.__("settings.typeExplanation"),
				topic: Homey.__("settings.topic"),
				topicExplanation: Homey.__("settings.topicExplanation"),
				payload: Homey.__("settings.payload"),
				payloadExplanation: Homey.__("settings.payloadExplanation"),
				enabled: Homey.__("settings.enabled"),
				click: Homey.__("settings.click"),
				longPress: Homey.__("settings.longPress"),
				led: Homey.__("settings.led"),
			};
			const itemLegend = Homey.__("settings.customMQTTItemlegend", { itemNo: ItemNo + 1 });
			const enableOption = Topic.enabled ? "checked" : "";

			var section = document.getElementById(`${Side}CustomMQTTTopicsSection`).innerHTML;
			section = section +
				`<div class="horizontalcontainer">
					<div class="horizontalgroup">
						<legend class="homey-subtitle">${itemLegend}</legend>

						<label class="homey-form-label" for="${Side}CustomMQTT${ItemNo}Id">${ctrlLabels.id}
							<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
								<span class="tooltiptext">${ctrlLabels.idExplanation}</span>
							</div>
						</label>
						<input class="homey-form-input" id="${Side}CustomMQTT${ItemNo}Id" type="text" value="${Topic.id}"/>

						<label class="homey-form-label" for="${Side}CustomMQTT${ItemNo}Type">${ctrlLabels.type}
							<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
								<span class="tooltiptext">${ctrlLabels.typeExplanation}</span>
							</div>
						</label>
						<select class="homey-form-select" id="${Side}CustomMQTT${ItemNo}Type">
							<option value=0>${ctrlLabels.click}</option>
							<option value=1>${ctrlLabels.longPress}</option>
							<option value=14>${ctrlLabels.led}</option>
						</select><br>

						<label class="homey-form-label" for="${Side}CustomMQTT${ItemNo}topic">${ctrlLabels.topic}
							<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
								<span class="tooltiptext">${ctrlLabels.topicExplanation}</span>
							</div>
						</label>
						<input class="homey-form-input" id="${Side}CustomMQTT${ItemNo}topic" type="text" value="${Topic.topic}" />

						<label class="homey-form-label" for="${Side}CustomMQTT${ItemNo}payload">${ctrlLabels.payload}
							<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
								<span class="tooltiptext">${ctrlLabels.payloadExplanation}</span>
							</div>
						</label>
						<input class="homey-form-input" id="${Side}CustomMQTT${ItemNo}payload" type="text" value="${Topic.payload}" />

						<label class="homey-form-label" for="${Side}CustomMQTT${ItemNo}BrokerId">${ctrlLabels.brokerId}
							<div class="tooltip" onmouseover="position_tooltip"><i class="fi fi-rr-info"></i>
								<span class="tooltiptext">${ctrlLabels.brokerIdExplanation}</span>
							</div>
						</label>
						<select class="homey-form-select" id="${Side}CustomMQTT${ItemNo}BrokerId">
						</select><br>

						<label class="homey-form-checkbox">
							<input class="homey-form-checkbox-input" id="${Side}CustomMQTT${ItemNo}Enabled" type="checkbox" ${enableOption}/>
							<span class="homey-form-checkbox-checkmark"></span>
							<span class="homey-form-checkbox-text">${ctrlLabels.enabled}</span>
						</label>

						<p><button class="homey-button-secondary-shadow" id="${Side}DeleteItem${ItemNo}" onClick="deleteCustomMQTTItem(${ItemNo}, '${Side}')" style="font-size: 30px;"><i class="fi fi-rr-trash"></i> </button></p>
					</div>
				</div>`;

			document.getElementById(`${Side}CustomMQTTTopicsSection`).innerHTML = section;
			customMQTTItemsElements.push(document.getElementById(`${Side}CustomMQTT${ItemNo}BrokerId`));

			// Add the brokers to the broker list
			var option = document.createElement("option");
			option.text = 'Default';
			option.value = 'Default';
			customMQTTItemsElements[ItemNo].add(option);
			for (var brokerNo = 0; brokerNo < localBrokerItems.length; brokerNo++)
			{
				const brokerItem = localBrokerItems[brokerNo];
				var option = document.createElement("option");
				option.text = brokerItem.brokerid;
				option.value = brokerItem.brokerid;
				customMQTTItemsElements[ItemNo].add(option);
				customMQTTItemsElements[ItemNo].value = Topic.brokerId;
			}
		}

		// Delete the specified custom item from the button panel configuration and redraw the list
		function deleteCustomMQTTItem(itemNo, side)
		{
			var ButtonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];
			const customMQTTTopics = ButtonPanelConfiguration[`${side}CustomMQTTTopics`];

			customMQTTTopics.splice(itemNo, 1);
			drawCustomMQTTTopics(side, ButtonPanelConfiguration);
		}

		//  Copy the contents of the specified custom item controls to the button panel configuration
		function storeCustomMQTTItem(side, buttonPanelConfiguration, itemNo)
		{
			// Get the custom MQTT topics array
			const customMQTTTopics = buttonPanelConfiguration[`${side}CustomMQTTTopics`];

			// Check if customMQTTTopics is defined and length is not 0
			if (!customMQTTTopics || customMQTTTopics.length === 0) return;

			// Fetch the item from the array or create a new one
			let item = customMQTTTopics[itemNo];
			if (!item)
			{
				item = {};
				customMQTTTopics.push(item);
			}

			// Update the item
			item.id = document.getElementById(`${side}CustomMQTT${itemNo}Id`).value;
			item.type = document.getElementById(`${side}CustomMQTT${itemNo}Type`).value;
			item.topic = document.getElementById(`${side}CustomMQTT${itemNo}topic`).value;
			item.payload = document.getElementById(`${side}CustomMQTT${itemNo}payload`).value;
			item.brokerId = document.getElementById(`${side}CustomMQTT${itemNo}BrokerId`).value;
			item.enabled = document.getElementById(`${side}CustomMQTT${itemNo}Enabled`).checked;
		}

		// Copy the contents of the all the custom items controls to the button panel configuration
		function storeCustomMQTTItems(side, buttonPanelConfiguration)
		{
			for (var itemNo = 0; itemNo < customMQTTItemsElements.length; itemNo++)
			{
				storeCustomMQTTItem(side, buttonPanelConfiguration, itemNo);
			}
		}

		function getButtonList()
		{
			Homey.api('POST', '/buttondevices/', {}, function (err, devices)
			{
				if (err) return Homey.alert(err);

				fillButtonListElement(webViewIpElement, devices);
			});
		}

		function fillButtonListElement(Element, DevicesArray)
		{
			if (Element && (DevicesArray.length > 0))
			{
				//fill the device lists with devices
				Element.innerHTML = "";

				for (const device of DevicesArray)
				{
					var option = document.createElement("option");
					option.text = device.name;
					option.value = device.ip;
					Element.add(option);
				}
			}
		}

		function setupButtonBrokerItems()
		{
			if (!brokerItemsFetched)
			{
				setTimeout(setupBrokers, 1000);
				return;
			}

			// Add a 'Default' broker entry to the lists
			var defaultText = Homey.__("settings.default");


			// Make sure currentButtonConfigurationNo is set and within range
			if (!currentButtonConfigurationNo || (currentButtonConfigurationNo >= localButtonConfigurations.length))
			{
				currentButtonConfigurationNo = 0;
			}

			// Get the current configuration
			var buttonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];

			// if localButtonConfigurations is an array, then set numPage to the length of the array otherwise set numPage to 1
			var numPages = buttonPanelConfiguration.length;

			for (let page = 0; page < numPages; page++)
			{
				const leftBrokerIdElement = document.getElementById(`left${page}BrokerId`);
				const rightBrokerIdElement = document.getElementById(`right${page}BrokerId`);

				// Add the deafult option to the broker lists
				var option = document.createElement("option");
				option.value = 'Default';
				option.text = defaultText;
				leftBrokerIdElement.add(option);

				var option = document.createElement("option");
				option.value = 'Default';
				option.text = defaultText;
				rightBrokerIdElement.add(option);
			}

			if (displayConfigurationsFetched)
			{
				// Add the deafult option to the display config broker lists
				const displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];
				for (let j = 0; j < displayConfiguration.items.length; j++)
				{
					const displayItem = displayConfiguration.items[j];
					var optionDisplay = document.createElement("option");
					optionDisplay.value = 'Default';
					optionDisplay.text = defaultText;
					document.getElementById(`display${j}BrokerId`).add(optionDisplay);
					document.getElementById(`display${j}BrokerId`).value = displayItem.brokerId;
				}
			}

			// Setup the list items for enabled brokers in the panel config
			for (let i = 0; i < localBrokerItems.length; i++)
			{
				const brokerItem = localBrokerItems[i];
				if (brokerItem.enabled)
				{
					for (let page = 0; page < numPages; page++)
					{
						const leftBrokerIdElement = document.getElementById(`left${page}BrokerId`);
						const rightBrokerIdElement = document.getElementById(`right${page}BrokerId`);

						var option = document.createElement("option");
						option.value = brokerItem.brokerid;
						option.text = brokerItem.brokerid;
						leftBrokerIdElement.add(option);
						if (buttonConfigurationsFetched)
						{
							leftBrokerIdElement.value = buttonPanelConfiguration[page].leftBrokerId;
						}

						var option = document.createElement("option");
						option.value = brokerItem.brokerid;
						option.text = brokerItem.brokerid;
						rightBrokerIdElement.add(option);
						if (buttonConfigurationsFetched)
						{
							rightBrokerIdElement.value = buttonPanelConfiguration[page].rightBrokerId;
						}
					}

					// Add the broker to the custom MQTT topic broker lists
					for (let k = 0; k < customMQTTItemsElements.length; k++)
					{
						var option = document.createElement("option");
						option.value = brokerItem.brokerid;
						option.text = brokerItem.brokerid;
						customMQTTItemsElements[k].add(option);
					}

					// Add the broker to the custom display MQTT topic broker lists
					for (let k = 0; k < customDisplayMQTTItemsElements.length; k++)
					{
						var option = document.createElement("option");
						option.value = brokerItem.brokerid;
						option.text = brokerItem.brokerid;
						customDisplayMQTTItemsElements[k].add(option);
					}

					if (displayConfigurationsFetched)
					{
						// Add the broker to the display config broker lists
						const displayConfiguration = localDisplayConfigurations[currentDisplayConfigurationNo];
						for (let j = 0; j < displayConfiguration.items.length; j++)
						{
							const displayItem = displayConfiguration.items[j];
							var optionDisplay = document.createElement("option");
							optionDisplay.value = brokerItem.brokerid;
							optionDisplay.text = brokerItem.brokerid;
							document.getElementById(`display${j}BrokerId`).add(optionDisplay);
							document.getElementById(`display${j}BrokerId`).value = displayItem.brokerId;
						}
					}
				}
			}

			drawBrokerItems();

			// Fill the default broker list
			fillDefaultBrokerList();
			Homey.get('defaultBroker', function (err, defaultBroker)
			{
				if (err) return Homey.alert(err);

				if (defaultBroker === "")
				{
					defaultBrokerElement.value = 'homey';
				}
				else
				{
					defaultBrokerElement.value = defaultBroker;
				}
			});
		}

		function buttonDeviceChanged(side, page)
		{
			// Get the current button configuration
			var buttonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];

			// Get the device element
			var deviceElement = document.getElementById(`${side}${page}Device`);

			// Get the config page
			var config = buttonPanelConfiguration[page];

			// Update the device in the local configuration
			config[`${side}Device`] = deviceElement.value;
			if (deviceElement.selectedIndex >= 0)
			{
				config[`${side}CapabilityName`] = deviceElement.options[deviceElement.selectedIndex].text;
			}
			else
			{
				config[`${side}CapabilityName`] = deviceElement.value;
			}

			// Remove all occurrences of ' (Missing Devices)' from the capability name
			config[`${side}CapabilityName`] = config[`${side}CapabilityName`].replace(/ \(Missing Devices\)/g, '');

			// Remove any leading spaces from the device name
			config[`${side}Device`] = config[`${side}Device`].trim();

			// Update the capabilities
			getCapabilities(side, page, deviceElement.value, config[`${side}Capability`], config[`${side}CapabilityName`]);
		}

		function deleteButtonPage(page)
		{
			// Delete the page from the current button configuration
			var buttonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];
			buttonPanelConfiguration.splice(page, 1);

			// Renumber the pages
			for (let i = 0; i < buttonPanelConfiguration.length; i++)
			{
				buttonPanelConfiguration[i].PageNum = i;
			}

			// Create and display the new page
			writeButtonsections(buttonPanelConfiguration.length);
			updateButtonPanelControls();
		}

		function onButtonPageChange(Element, page)
		{
			if (Element.value === "")
			{
				return;
			}

			let newPage = parseInt(Element.value);

			// make sure the new number is > 0 and less than the number of pages
			if (newPage < 0 || newPage >= localButtonConfigurations[currentButtonConfigurationNo].length)
			{
				alert(Homey.__("settings.pageError"));
				Element.value = page;
				return;
			}

			// Now we need to move the page to the new position in the array
			var buttonPanelConfiguration = localButtonConfigurations[currentButtonConfigurationNo];
			var oldPage = page;

			// If the new page is less than the old page, then we need to move the old page to the new page and move all the pages between the new and old page up one
			if (newPage < oldPage)
			{
				// Move the old page to the new page
				var tempPage = buttonPanelConfiguration[oldPage];
				buttonPanelConfiguration.splice(oldPage, 1);
				buttonPanelConfiguration.splice(newPage, 0, tempPage);

				// Renumber the pages
				for (let i = 0; i < buttonPanelConfiguration.length; i++)
				{
					buttonPanelConfiguration[i].PageNum = i;
				}
			}
			else if (newPage > oldPage)
			{
				// Move the old page to the new page
				var tempPage = buttonPanelConfiguration[oldPage];
				buttonPanelConfiguration.splice(oldPage, 1);
				buttonPanelConfiguration.splice(newPage, 0, tempPage);

				// Renumber the pages
				for (let i = 0; i < buttonPanelConfiguration.length; i++)
				{
					buttonPanelConfiguration[i].PageNum = i;
				}
			}

			// Redisplay the pages
			writeButtonsections(buttonPanelConfiguration.length);
			updateButtonPanelControls();
		}

		// Create the HTML for the button sections. Note this just creates the framework, the controls values are set using updateButtonPanelControls
		function writeButtonsections(numPages)
		{
			// Write the button sections
			const ctrlLabels = {
				page: Homey.__("settings.page"),
			}
			const ctrlExplanations = {
				page: Homey.__("settings.buttonPageExplanation"),
			}

			var html = "";
			for (page = 0; page < numPages; page++)
			{
				html += `<div class="horizontalcontainer">
					<div class="horizontal
                		<div class="horizontalcontainer">
							<div class="horizontalgroup">
								<label class="homey-form-label" for="${page}PageNum"><span>${ctrlLabels.page}</span>
								<div class="tooltip"><i class="fi fi-rr-info"></i>
									<span class="tooltiptext">${ctrlExplanations.page}</span>
								</div>
								</label>
								<input class="homey-form-input" id="${page}PageNum" type=${page === 0 ? "text" : "number"} ${page === 0 ? "readonly" : ""} onchange="onButtonPageChange(this, '${page}')" />`

				html += getButtonHtml("left", page);
				html += getButtonHtml("right", page);

				if (page !== 0)
				{
					html += `<p><button class="homey-button-secondary-shadow" id="deletePage${page}" onClick="deleteButtonPage(${page})" style="font-size: 30px;"><i class="fi fi-rr-trash"></i> </button></p>`;
				}

				html += `</div>
					</div>
				</div>`;
			}
			document.getElementById('buttonItemsSection').innerHTML = html;
		}

		// Create the HTML for the button page and side
		function getButtonHtml(side, page)
		{
			const leftPanelText = Homey.__("settings.leftPanel");
			const rightPanelText = Homey.__("settings.rightPanel");

			const ctrlLabels = {
				device: Homey.__("settings.device"),
				capability: Homey.__("settings.capability"),
				label: Homey.__("settings.topLabel"),
				text: Homey.__("settings.text"),
				unit: Homey.__("settings.unit"),
				topLabel: Homey.__("settings.topLabel"),
				labelOn: Homey.__("settings.labelOn"),
				labelOff: Homey.__("settings.labelOff"),
				dimChange: Homey.__("settings.dimChange"),
				frontLEDOnColor: Homey.__("settings.frontLEDOnColor"),
				frontLEDOffColor: Homey.__("settings.frontLEDOffColor"),
				wallLEDOffColor: Homey.__("settings.wallLEDOffColor"),
				wallLEDOnColor: Homey.__("settings.wallLEDOnColor"),
				longRepeat: Homey.__("settings.longRepeat"),
				brokerId: Homey.__("settings.brokerId"),
				page: Homey.__("settings.page"),
				customMQTTTopic: Homey.__("settings.customMQTTTopic"),
				newCustomMQTTItem: Homey.__("settings.newCustomMQTTItem"),
				panel: side === 'left' ? leftPanelText : rightPanelText,
			}
			const ctrlExplanations = {
				device: Homey.__("settings.deviceDExplanation"),
				capability: Homey.__("settings.capabilityDExplanation"),
				label: Homey.__("settings.toplabelDisplayExplanation"),
				text: Homey.__("settings.textExplanation"),
				unit: Homey.__("settings.unitExplanation"),
				topLabel: Homey.__("settings.topLabelExplanation"),
				labelOn: Homey.__("settings.labelOnExplanation"),
				labelOff: Homey.__("settings.labelOffExplanation"),
				dimChange: Homey.__("settings.dimValueExplanation"),
				frontLEDOnColor: Homey.__("settings.frontLEDOnColorExplanation"),
				frontLEDOffColor: Homey.__("settings.frontLEDOffColorExplanation"),
				wallLEDOffColor: Homey.__("settings.wallLEDOffColorExplanation"),
				wallLEDOnColor: Homey.__("settings.wallLEDOnColorExplanation"),
				longRepeat: Homey.__("settings.longRepeatExplanation"),
				brokerId: Homey.__("settings.brokerIdExplanation"),
				page: Homey.__("settings.buttonPageExplanation"),
				customMQTTTopic: Homey.__("settings.customMQTTTopicExplanation"),
			}

			const html = `<div class="horizontalcontainer">
                <div class="horizontal
                <div class="horizontalcontainer">
                    <div class="horizontalgroup">
                        <details onclick="scrollToTop(this)">
                            <summary class="summary">
                                <legend class="homey-subtitle" id="button${side}${page}Legend"><b><em>><span>${ctrlLabels.panel}</span></em></b></legend><span class="icon" style='font-size:30px;'>&#8628;</span>
                            </summary >
                            <hr>

                                <label class="homey-form-label" for="${side}${page}Device"><span>${ctrlLabels.device}</span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext">${ctrlExplanations.device}</span>
                                    </div>
                                </label>
                                <select class="homey-form-select" id="${side}${page}Device" onChange="buttonDeviceChanged('${side}', ${page})"">
                                    <option value selected disabled hidden${ctrlLabels.device}"></option>
                                </select>

                                <span>
                                    <div id="${side}${page}CapabilityDiv">
                                        <label class="homey-form-label" id="${side}${page}CapabilityLabel" for="${side}${page}Capability"><span>${ctrlLabels.capability}</span>
                                            <div class="tooltip"><i class="fi fi-rr-info"></i>
                                                <span class="tooltiptext">${ctrlExplanations.capability}</span>
                                            </div>
                                        </label>
                                        <select class="homey-form-select" id="${side}${page}Capability">
                                            <option value selected disabled hidden>${ctrlLabels.Capability}</option>
                                        </select>
                                    </div>
                                </span>

                                <label class="homey-form-label" for="${side}${page}TopText"><span>${ctrlLabels.topLabel}</span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext">${ctrlExplanations.topLabel}</span>
                                    </div>
                                </label>
                                <input class="homey-form-input" id="${side}${page}TopText" type="text" maxlength="20" oninput="onButtonLabelChange(this, '${side}${page}')" value />

                                <span>
                                    <div id="${side}${page}OnTextDiv">
                                        <label class="homey-form-label" id="${side}${page}OnTextLabel" for="${side}${page}OnText"><span>${ctrlLabels.labelOn}</span>
                                            <div class="tooltip"><i class="fi fi-rr-info"></i>
                                                <span class="tooltiptext">${ctrlExplanations.labelOn}</span>
                                            </div>
                                        </label>
                                        <input class="homey-form-input" id="${side}${page}OnText" type="text" maxlength="20" value="" value />
                                    </div>
                                </span>

                                <span>
                                    <div id="${side}${page}DimChangeDiv">
                                        <label class="homey-form-label" id="${side}${page}DimChangeLabel" for="${side}${page}DimChange"><span>${ctrlLabels.dimChange}</span>
                                            <div class="tooltip"><i class="fi fi-rr-info"></i>
                                                <span class="tooltiptext">${ctrlExplanations.dimChange}</span>
                                            </div>
                                        </label>
                                        <input class="homey-form-input" id="${side}${page}DimChange" type="text" maxlength="20" value />
                                    </div>
                                </span>

                                <label class="homey-form-label" id="${side}${page}OffTextLabel" for="${side}${page}OffText"><span>${ctrlLabels.labelOff}</span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext">${ctrlExplanations.labelOff}</span>
                                    </div>
                                </label>
                                <input class="homey-form-input" id="${side}${page}OffText" type="text" maxlength="20" value />

                                <label class="homey-form-label" id="${side}${page}FrontLEDOnColorLabel" for="${side}${page}FrontLEDOnColor"><span>${ctrlLabels.frontLEDOnColor}</span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext">${ctrlExplanations.frontLEDOnColor}</span>
                                    </div>
                                </label>
                                <input class="homey-form-input" id="${side}${page}FrontLEDOnColor" type="color" value=#ff0000 />

                                <label class="homey-form-label" id="${side}${page}WallLEDOnColorLabel" for="${side}${page}FrontLEDOnColor"><span>${ctrlLabels.wallLEDOnColor}</span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext">${ctrlExplanations.wallLEDOnColor}</span>
                                    </div>
                                </label>
                                <input class="homey-form-input" id="${side}${page}WallLEDOnColor" type="color" value=#ff0000 />

                                <label class="homey-form-label" id="${side}${page}FrontLEDOffColorLabel" for="${side}${page}FrontLEDOffColor"><span>${ctrlLabels.frontLEDOffColor}</span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext">${ctrlExplanations.frontLEDOffColor}</span>
                                    </div>
                                </label>
                                <input class="homey-form-input" id="${side}${page}FrontLEDOffColor" type="color" value=#ff0000 />

                                <label class="homey-form-label" id="${side}${page}WallLEDOffColorLabel" for="${side}${page}FrontLEDOffColor"><span>${ctrlLabels.wallLEDOffColor}</span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext">${ctrlExplanations.wallLEDOffColor}</span>
                                    </div>
                                </label>
                                <input class="homey-form-input" id="${side}${page}WallLEDOffColor" type="color" value=#ff0000 />

                                <label class="homey-form-checkbox">
                                    <input class="homey-form-checkbox-input" id="${side}${page}DisableLongRepeat" type="checkbox" value="auto" />
                                    <span class="homey-form-checkbox-checkmark"></span>
                                    <span class="homey-form-checkbox-text"><span>${ctrlLabels.longRepeat}</span></span>
                                    <div class="tooltip"><i class="fi fi-rr-info"></i>
                                        <span class="tooltiptext">${ctrlExplanations.longRepeat}</span>
                                    </div>
                                </label>

                                <span>
                                    <div id="${side}${page}BrokerIdDiv">
                                        <label class="homey-form-label" for="${side}${page}BrokerId"><span>${ctrlLabels.brokerId}</span>
                                            <div class="tooltip"><i class="fi fi-rr-info"></i>
                                                <span class="tooltiptext">${ctrlExplanations.brokerId}</span>
                                            </div>
                                        </label>
                                        <select class="homey-form-select" id="${side}${page}BrokerId">
                                        </select>
                                    </div>
                                </span>

                                <span>
                                    <div id="${side}${page}CustomMQTTDiv">
                                        <br>
                                            <div id="${side}${page}CustomMQTTTopicsSection"></div>
                                            <p><button class="homey-button-secondary-shadow" id="new${side}${page}CustomMQTTItem"><span>${ctrlLabels.newCustomMQTTItem}</span></button></p>
                                    </div>
                                </span>
                        </details >
                    </div >
                </div >
            </div >`;
			return html;
		}

	</script>
</body>

</html>